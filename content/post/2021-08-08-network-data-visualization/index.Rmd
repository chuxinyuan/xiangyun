---
title: 网络数据可视化与 R 语言
author: 黄湘云
date: '2022-05-30'
slug: network-data-visualization
categories:
  - 统计图形
tags:
  - 网络分析
  - ggplot2
  - Rgraphviz
  - igraph 
  - ggraph
  - DiagrammeR
bibliography: 
  - refer.bib
  - packages.bib
draft: true
toc: true
thumbnail: /img/seven-bridges.png
link-citations: true
description: "本文首先概览 R 语言在网络数据分析和可视化方面的情况；然后介绍图的表示（矩阵），图的计算（矩阵计算），图的展示（点、线等），图的工具（R 和其它软件）；最后以 CRAN 上 R 包的元数据为基础，介绍网络分析和可视化的过程，也发现了 R 语言社区中一些非常有意思的现象。"
---


```{r setup, echo=FALSE}
library(data.table)
knitr::opts_chunk$set(
  comment = "#",
    error = FALSE,
     tidy = FALSE,
    cache = FALSE,
 collapse = TRUE
)
# 修改输出的显示行数
knitr::knit_hooks$set(output = local({
  # the default output hook
  hook_output = knitr::knit_hooks$get('output')
  function(x, options) {
    if (!is.null(n <- options$out.lines)) { # out.lines
      x = xfun::split_lines(x)
      if (length(x) > n) {
        # truncate the output
        x = c(head(x, n), '....\n')
      }
      x = paste(x, collapse = '\n') # paste first n lines together
    }
    hook_output(x, options)
  }
}))
# 控制输出的宽度
options(width = 69)
```

```{css, echo=FALSE}
.sidebar {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.sidebar, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.rmdinfo {
  border: 1px solid #ccc;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}
div.rmdinfo::before {
  content: "声明";
  color: block;
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

figure {
  text-align: center;
}

div.img {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}
```

::: rmdtip
时隔四年，Gephi 发布了 1.0.0 版，写一篇文章庆祝一下。
:::

本文首先概览 R 语言在网络数据分析和可视化方面的情况；然后介绍图的表示（矩阵），图的计算（矩阵计算），图的展示（点、线等），图的工具（R 和其它软件）；最后以 CRAN 上 R 包的元数据为基础，介绍网络分析和可视化的过程，也发现了 R 语言社区中一些非常有意思的现象。

网络图是表示节点之间关系的图，核心在于关系的刻画， 用来表达网络关系的是稀疏矩阵，以及为处理这种矩阵而专门优化的矩阵计算库，如 **Matrix** 、[**rsparse**](https://github.com/rexyai/rsparse)和 **RcppEigen** [@Bates2013]，PageRank  应该是大家最为熟悉的网络数据挖掘算法，图关系挖掘和计算的应用场景非常广泛，如社交推荐（社交 App）、风险控制（银行征信、企业查）、深度学习（图神经网络）、知识图谱（商户、商家、客户的实体关系网络）、区块链、物联网（IoT）、反洗钱（金融监管）、数据治理（数据血缘图谱）等。

企业级的图存储和计算框架，比较有名（可能是最有名的），反正，笔者最先听说的是[Neo4j](https://github.com/neo4j/neo4j) ，它有以 AGPL 协议发布的开源版本，还有商业版本。[Nebula Graph](https://github.com/vesoft-inc/nebula)  分布式开源图数据库，高扩展性和高可用性，支持千亿节点、万亿条边、毫秒级查询，有[中文文档](https://github.com/vesoft-inc/nebula-docs-cn/)，有企业应用案例，[美团图数据库平台建设及业务实践](https://mp.weixin.qq.com/s/aYd5tqwogJYfkJXhVNuNpg)。阿里研发的[GraphScope](https://github.com/alibaba/GraphScope) 提供一站式大规模图计算系统，支持图神经网络计算。[HugeGraph](https://github.com/hugegraph/hugegraph)图数据库应用于[金融反欺诈实践](https://zhuanlan.zhihu.com/p/114665466)。


[node2vec](https://cran.r-project.org/package=node2vec)包实现等人提出的大规模网络特征学习[@Grover2016]。[networkx](https://github.com/networkx/networkx)是做网络分析的 Python 模块。
[**rsparse**](https://github.com/rexyai/rsparse) 包提供很多基于稀疏矩阵的统计学习算法，支持基于 OpenMP 的并行计算。[RSpectra](https://github.com/yixuan/RSpectra) 包是 C++ 库 [Spectra](https://spectralib.org/) 的 R 接口，仅有两个函数 `eigs()` 和 `svds()` 分别用来计算 $N$ 阶矩阵（稀疏或稠密都行） Top K 个最大的特征值/特征向量，适合大规模特征值和奇异值分解问题，在 k 远远小于 N 时，特别能体现优越性。后面从 CRAN 网络数据中获取 Top K 个主要的组织、个人和 R 包。


<!--

[**RcppSparse**](https://github.com/zdebruine/RcppSparse)  RcppArmadillo 和 RcppEigen 深拷贝deep copy 操作，而 RcppSparse zero-copy 零拷贝，无缝衔接，而计算结果是一致的，详细描述见 [Constructing a Sparse Matrix Class in Rcpp](https://gallery.rcpp.org/articles/sparse-matrix-class/)

1. Roger Bivand 分析源码提交记录 <https://github.com/rsbivand/eRum18>
1. 基本数据操作到两大阵营的对话 <https://d.cosx.org/d/420697>
1. 分析 CRAN 上 R 包元数据，挖掘 R 社区中隐藏的信息 <https://r-graphics.netlify.com/cs-cran-network.html>
-->


# 概览


[igraph](https://github.com/igraph/igraph) 是非常流行和核心的网络分析 C 语言库，它提供有多种语言的接口，其 R 语言接口 [igraph](https://github.com/igraph/rigraph) 包也被很多其它做网络分析的 R 包所引用。开源的 [Gephi](https://github.com/gephi/gephi) 软件适合处理中等规模的网络分析和可视化。大规模图计算可以用 Apache Spark 的 [GraphX](https://spark.apache.org/graphx/)。R 语言这层，主要还是对应数据分析和数据产品，用于在内部咨询和商业分析。

[David Schoch](http://mr.schochastics.net/) 开发的 [graphlayouts](https://github.com/schochastics/graphlayouts) 包添加布局算法用于网络可视化，他个人网站上还有一些介绍 R 语言网络分析的文章。他开发的另一个 R 包[networkdata](https://github.com/schochastics/networkdata)收集了**980**个网络相关的数据集，用于教学、文章和书籍介绍相关知识应该足够，用不着自己还到处去找了。Thomas Lin Pedersen 开发的[ggraph](https://github.com/thomasp85/ggraph)包实现图和网络的绘图语法，类似 ggplot2 的设计，和以往的使用习惯保持一致，这就非常方便。他开发的另一个 R 包[tidygraph](https://github.com/thomasp85/tidygraph) 将净土应用到图操作上面。Martina Morris 等人开发了一批用于网络分析和建模的 R 包，类似 tidyverse 的做法都整合在 [statnet](https://github.com/statnet) 包里。

[BDgraph](https://cran.r-project.org/package=BDgraph) [@BDgraph2019] 基于生灭过程的贝叶斯结构学习用于图模型，

[qgraph](https://github.com/SachaEpskamp/qgraph) [@qgraph2012] 网络数据可视化和分析，高斯图模型计算

[DoubleML](https://github.com/DoubleML/doubleml-for-r/)[@DoubleML2021] 构建在 mlr3 及生态上，实现 Double/Debiased 机器学习框架[@Chernozhukov2018]。
[text2map](https://gitlab.com/culturalcartography/text2map) [@text2map2021] 文本分析，词嵌入，文本网络
[mlpack](https://github.com/mlpack/mlpack) [@mlpack2018] 是前沿机器学习算法合集。



[visNetwork](https://github.com/datastorm-open/visNetwork) 包 可以制作交互式网络图形，它是 JS 库 [vis-network](https://github.com/visjs/vis-network) 的 R 语言接口。Richard Iannone 而开发的[DiagrammeR](https://github.com/rich-iannone/DiagrammeR) 包可以制作静态的矢量网页图形。

::: rmdnote
[networkD3](https://github.com/christophergandrud/networkD3) CRAN 上次更新还在 2017 年，[Sam Tyner](https://sctyner.me/) 开发的 [geomnet](https://github.com/sctyner/geomnet) 包给 ggplot2 添加了网络图层 `geom_net`，目前未在 CRAN 上发布。François Briatte 开发的 [ggnet](https://github.com/briatte/ggnet) 目前也未在 CRAN 上发布，但是其帮助文档值得一看，[]( https://briatte.github.io/ggnet/)。
:::

另一类表达关系的是流程图或项目架构图，比较流行的制作工具（软件）有[graphviz](https://gitlab.com/graphviz/graphviz)、[plantuml](https://github.com/plantuml/plantuml)、[drawio-desktop](https://github.com/jgraph/drawio-desktop) 和[flowchart.js](https://github.com/adrai/flowchart.js)。在 R Markdown 文档中，knitr 包可以调用 [Graphviz](https://www.graphviz.org/) 软件生成网络图并插入到文档中，而 [nomnoml](https://github.com/rstudio/nomnoml) 包没有外部软件依赖，非常方便，下图\@ref(fig:nomnoml)即为该 R 包制作。

![(\#fig:nomnoml) 开发 R Shiny 应用的技术栈](https://user-images.githubusercontent.com/12031874/120408326-6190a900-c381-11eb-9dcf-9881d33fa2b6.png){.full}



```{r network-deps, message=FALSE, echo=FALSE}
# 获取 R 包元数据
Sys.setenv(R_CRAN_WEB = "https://mirrors.tuna.tsinghua.edu.cn/CRAN")
# 返回 data.frame
pdb <- tools::CRAN_package_db()

# CRAN 上的 R 包
pkgs <- c(
  "igraph", "graphlayouts", "ggraph", "tidygraph",
  "DiagrammeR", "visNetwork", "statnet", "sand",
  "geomnet", "ggnet", "ggnetwork", "qgraph", 
  "GGally", "sna", "network", "networkD3", 
  "Rgraphviz", "graph", "node2vec"
)

# Github 上的 R 包
remote_pkgs = c('geomnet' = 'sctyner', 'ggnet' = 'briatte')

bioc_pkgs = c("Rgraphviz", "graph")

if (length(bioc_pkgs)) {
  if (!"BiocManager" %in% .packages(T)) install.packages("BiocManager")
}
# 安装依赖
invisible(lapply(pkgs, function(pkg) {
  if (system.file(package = pkg) != "") {
    return()
  }
  if(pkg %in% bioc_pkgs){
    BiocManager::install(pkg)
  }
  repo <- remote_pkgs[pkg]
  if (is.na(repo)) { # 不在 Github 上
    install.packages(pkg, quiet = TRUE)
  } else {
    remotes::install_github(paste(repo, pkg, sep = "/"))
  }
}))

# 处理掉丑陋的成对单引号
rmd_lib <- c(
  "ggplot2", "vis.js"
)
rmd_regexp <- paste("'(", paste(rmd_lib, collapse = "|"), ")'", sep = "")

# 提取 R Shiny 应用使用的 R 包及其基本描述
sub_pdb <- subset(
  x = pdb,
  select = c("Package", "Title", "Maintainer", "URL", "License", "BugReports"),
  subset = Package %in% pkgs
) |>
  transform(Title = gsub("(\\\n)", " ", Title)) |>
  transform(Title = gsub(rmd_regexp, "\\1", Title)) |> 
  transform(Maintainer = gsub("<([^<>]*)>", "", Maintainer)) |> 
  # transform(URL = gsub("(\\\n)", " ", URL)) |> 
  # transform(URL = gsub(",", "", URL)) |> 
  # transform(URL = ifelse(is.na(URL), BugReports, URL)) |> 
  # transform(URL = ifelse(is.na(URL), sprintf("https://CRAN.R-project.org/package=%s", Package), URL)) |> 
  transform(Package = paste0("**", Package, "**", " ", "[@", Package, "]"))

# 展示表格
knitr::kable(sub_pdb[order(sub_pdb$Maintainer), 
                     setdiff(colnames(sub_pdb), c("URL", "BugReports"))],
  row.names = FALSE,
  caption = "网络分析的 R 包（排名不分先后）",
  col.names = c("R 包", "简介", "维护者", "协议")
)
```
```{r write-bib, include=FALSE}
bib <- knitr::write_bib(
  x = pkgs, file = NULL, prefix = ""
)
bib <- unlist(bib)
bib <- gsub("(\\\n)", " ", bib)
xfun::write_utf8(bib, "packages.bib")
```


推荐 Github 上 [超棒的网络分析](https://github.com/briatte/awesome-network-analysis) 资源集合，ggplot2 关于网络数据可视化的[介绍](https://ggplot2-book.org/networks.html)，阅读 Erick Kolaczyk 的书籍《Statistical Analysis of Network Data with R》[@Kolaczyk2014;@Kolaczyk2020]和发表在《R Journal》上的文章《Network Visualization with ggplot2》[@Tyner2017]及其配套 R 包 [ggnetwork](https://github.com/briatte/ggnetwork)。Katherine Ognyanova 在个人博客上持续维护的材料 --- [Static and dynamic network visualization with R](https://kateto.net/network-visualization)，David Schoch 介绍用 R 包 ggraph 和 graphlayouts 做网络数据可视化的材料 --- [Network Visualizations in R: using ggraph and graphlayouts](http://mr.schochastics.net/netVizR.html)，Albert-László Barabási 的在线书籍[《Network Science》](http://networksciencebook.com/)，Douglas Luke 的《A User’s Guide to Network Analysis in R》[@Luke2015]。无论是软件工具还是相关文献，笔者相信这只是列举了很小的一部分而已，但是应该足够应付绝大部分使用场景，读者若还有补充，欢迎来统计之都论坛留言评论 --- [中等规模及以上的网络图，怎么用 R 高效地绘制](https://d.cosx.org/d/419292)或灌水 --- [R 社区的开发人员知多少](https://d.cosx.org/d/420670)。

落园园主的博文[十八般武艺，谁主天下？](https://cosx.org/2013/02/jinyong-fiction-mining)分析金庸先生小说揭密最受欢迎的兵器，刘思喆的博文[从北京地铁规划再看地段的重要性](https://bjt.name/2021/02/13/subway.html)分析地铁网络寻找房价洼地。



# 网络分析基础

柯尼斯堡七桥问题：在所有桥都只走一遍的情况下，如何才能把这个地方所有的桥都走遍？欧拉将每一座桥抽象为一条线，桥所连接地区抽象为点[^seven-bridges]。此处，用[tikz-network](https://ctan.org/pkg/tikz-network) 绘制网络图，如图\@ref(fig:seven-bridges)所示， $1,2,\cdots,7$ 分别表示七座桥， $A,B,C,D$ 分别表示四块区域。


[^seven-bridges]: <https://en.wikipedia.org/wiki/Seven_Bridges_of_K%C3%B6nigsberg>

![(\#fig:seven-bridges) 欧拉用图抽象的柯尼斯堡七桥](/img/seven-bridges.png){ width=65% }

```{r seven-bridges, engine="tikz", fig.cap="柯尼斯堡七桥问题", cache=FALSE, engine.opts=list(extra.preamble=c("\\usepackage[default]{sourcesanspro}", "\\usepackage{tikz-network}")), eval=FALSE, echo=FALSE}
\begin{tikzpicture}
\Vertex[IdAsLabel, x=5, color=gray, size=1, fontsize=\large]{A}
\Vertex[IdAsLabel, x=10, color=gray, size=1, fontsize=\large]{B}
\Vertex[IdAsLabel, x=15, color=gray, size=1, fontsize=\large]{C}
\Vertex[IdAsLabel, x=10, y=6, color=gray, size=1, fontsize=\large]{D}

\Edge[label=2, bend=45, fontscale=2](A)(B)
\Edge[label=6, bend=30, fontscale=2](A)(D)
\Edge[label=3, bend=45, fontscale=2](B)(A)
\Edge[label=5, bend=45, fontscale=2](B)(C)
\Edge[label=4, bend=45, fontscale=2](C)(B)
\Edge[label=7, bend=30, fontscale=2](D)(C)
\Edge[label=1, fontscale=2](D)(B)
\end{tikzpicture}
```

柯尼斯堡七桥图的数据已经收录在 **igraphdata** 包里，数据集名称就叫 Koenigsberg

```{r,eval=FALSE}
library(igraphdata)
data(Koenigsberg)
library(igraph)
plot(Koenigsberg)
```



## 安装 R 包


Rgraphviz [Graphviz](https://www.graphviz.org/)

```{r}
if(!"BiocManager" %in% .packages(T)) install.packages("BiocManager")
if(!"graph" %in% .packages(T)) BiocManager::install(pkgs = "graph")
if(!"Rgraphviz" %in% .packages(T)) BiocManager::install(pkgs = "Rgraphviz")
```


```{r,eval=FALSE}
# https://www.isid.ac.in/~deepayan/R-tutorials/docs/roverview.pdf
if(!"pkgDepTools" %in% .packages(T)) BiocManager::install(pkgs = "pkgDepTools")
# https://github.com/r-lib/pkgcache
library(graph)
library(Rgraphviz)
library(pkgDepTools)
g <- makeDepGraph("http://cran.r-project.org", keep.builtin = TRUE)
g

revDepGraph <- function(g, pkg) {
  olen <- 0
  pkgKeep <- pkg
  elist <- g@edgeL
  elist <- elist[!(sapply(elist, is.null))]
  while (length(pkgKeep) > olen) {
    olen <- length(pkgKeep)
    w <- which(g@nodes %in% pkgKeep)
    revdep <- sapply(elist, function(x) any(w %in% x$edges))
    pkgKeep <- union(pkgKeep, names(revdep)[revdep])
  }
  subGraph(pkgKeep, g)
}
gsub <- revDepGraph(g, "lme4")
gsub
library(Rgraphviz)
graph.par(nodes = list(shape = "ellipse"))
gl <- layoutGraph(gsub, layoutType = "twopi")
renderGraph(gl)
```

## 图的表示

## 图的计算

## 图的展示

4个节点，给定邻接矩阵，即可画出关系图

```{r}
# library(graph)
mat <- matrix(c(
  0, 0, 1, 1,
  0, 0, 1, 1,
  1, 1, 0, 1,
  1, 1, 1, 0
),
byrow = TRUE, ncol = 4,
dimnames = list(letters[1:4], letters[1:4])
)
```


```{r,eval=FALSE}
g1 <- graph::graphAM(adjMat = mat)
graph::plot(g1)
```

![(\#fig:graph) 用 **graph** 包绘制4个顶点的简单网络图](https://user-images.githubusercontent.com/12031874/67205314-193da500-f442-11e9-834f-2617220aa084.png){ width=35% }

用函数 `randomGraph()` 随机生成一个网络图

```{r}
set.seed(123)
V <- letters[1:10] # 图的顶点
M <- 1:4  # 选择生成图的
g2 <- graph::randomGraph(V, M, p = 0.2)
graph::numEdges(g2)  # 边的个数
graph::edgeNames(g2) # 边的名字，无向图顶点之间用 ~ 连接
g2
graph::edges(g2) # 边
graph::edgeWeights(g2) # 边的权重
```

V 表示图的顶点， M 表示一组元素的集合，
p 表示从集合 M 中选出一个元素的概率。随机图的构造方法如下：
从 M 中以概率 p 选出一个元素，比如 1 （或者没有选），然后将 1 随机地指给 V 中的一个顶点 a，重复这个过程 4 次（次数取决于 M 中元素的个数）完成对一个顶点的随机指定，此时，顶点 a 对应一个长度为 4 的逻辑向量，有值的位置记为 TRUE，反之记为 FALSE，对其他顶点操作类似，这样就可以得到一个 10 * 4 的矩阵。如果某一列有两个顶点共有一个元素，比如 1， 则这两个顶点有边连接，反之则无。如果两个顶点共用2和3两个元素，则连接两个顶点的边的权重为 2。可见，V 和 M 的数量，以及 p 的值决定图的稠密程度。

```{r,eval=FALSE}
graph::plot(g2)
```

![(\#fig:random-graph) 用 **graph** 包生成10个顶点的随机网络图](https://user-images.githubusercontent.com/12031874/67205315-193da500-f442-11e9-88c8-e053a35a2168.png){ width=45% }

换个布局

```{r,eval=FALSE}
graph::plot(g2, "neato")
```

![(\#fig:neato-graph) neato 布局 ](https://user-images.githubusercontent.com/12031874/67205319-19d63b80-f442-11e9-83c8-6c68b1793526.png){ width=55% }

```{r,eval=FALSE}
graph::plot(g2, "twopi")
```

![(\#fig:twopi-graph) twopi 布局](https://user-images.githubusercontent.com/12031874/67205321-19d63b80-f442-11e9-88e0-b783d3daa5f7.png){ width=55% }


# 案例：CRAN 网络分析

之前肯定有人分析过，但是我的分析更加全面，更加深刻，涉及 R 包，开发者和组织生态三个层次。

network-with-r 基于 CRAN 数据，分析 R 语言社区开发者关系网络。首先展示当前 R 语言社区的一些基本概览信息，目的是让外行或入坑不深的人有所了解。
分析对象是人及其关系，价值会更高，更能吸引读者，其次 R 包依赖和贡献关系。
邮箱后缀 \@符号后面的部分，根据邮箱查所属国家，地区，开发者的邮箱分布，所属大学、企业分布。单个人物和集体人物。
在 R 会开始之前发出来，比较应景。已经在这个事情上搞来搞去，搞了很多时间了，今天算是交作业了。围绕生态环境来写和分析，最后思考，如何引领，站在核心开发者的视角，基金会的视角来看，对统计之都有没有一些启示。

## R 包

只考虑 CRAN 范围内的数据

影响力
关键 R 包


在什么平台开发，Github 还是线下

R 包关系
一度关系，安装 A 包，必须安装 B 包，则 B 包为 A 包的前置依赖。

选择合适的 R 包，软件质量问题 Ohloh 网站，从 R 包开发者，依赖情况等，发现一批优质的 R 包和厉害的开发者。

### 发布协议 

R 软件以 GPL 2.0 或 GPL 3.0 协议发布

```{r}
license_pdb <- subset(x = pdb, select = c("Package", "License"))
license_pdb_aggr <-aggregate(data = license_pdb, Package ~ License, FUN = function(x) length(unique(x)))
license_pdb_aggr <- license_pdb_aggr[order(license_pdb_aggr$Package, decreasing = TRUE), ]

knitr::kable(head(license_pdb_aggr, 15),
  col.names = c("R 包协议", "R 包数量"), row.names = FALSE,
  caption = "CRAN 上受开发者欢迎的 R 包发布协议（Top 15）"
)
```

GPL 协议占主导地位，MIT 协议次之。

CRAN 会检测 R 包的授权，只有授权协议包含在[数据库](https://svn.r-project.org/R/trunk/share/licenses/license.db)中的才可以在 CRAN 上发布。

```{r,eval=FALSE}
# 查看文件，如何以最合适的方式读取呢？
db = readLines(con = "https://svn.r-project.org/R/trunk/share/licenses/license.db")
head(db,20)
db[grepl(x = db, pattern = "^Name:")]
```



### 更新频次


距今10余年未更新

```{r}
subset(pdb, subset = Published == min(Published), 
       select = c("Package", "Title", "Published"))
```

18000 多个 R 包，距离上次更新的时间间隔分布

```{r}
diff_date_pdb <- subset(pdb, select = c("Package", "Published")) |> 
  transform(diff_date = as.integer(Sys.Date() - as.Date(Published)))
```

```{r}
quantile(diff_date_pdb$diff_date)
```

半年时间更新 25% 的 R 包，一年半时间更新 50% 的 R 包，三年半时间也只更新 75% 的 R 包。

::: rmdtip
非常值得和 Python 对比一下，Python 模块仓库 <https://pypi.org/>。
Python 编程风格指南 <https://www.python.org/dev/peps/pep-0008/>。
:::

### 增长速度

目前手头只有一份昨天的 CRAN 日志，没法和历史对比，若有历史的 CRAN 快照日志，就可以站在 2012 年看 2000-2012 年的净增长量和速度。

```{r}
# R 包增长速度
# 以现在的时间作为参照，看过去时间点的 R 包净增长量。
pkgs <- subset(x = pdb, select = c("Package", "Date", "Published")) |>
  transform(Date = ifelse(!is.na(Published), Published, Date)) |>
  transform(Published = as.Date(Published)) |>
  subset(Published >= as.Date("2012-01-01")) |>
  transform(Month = format(Published, format = "%Y-%m-01")) |>
  transform(Month = as.Date(Month))

pkgs <- aggregate(formula = Package ~ Month, data = pkgs, FUN = function(x) length(unique(x)))
```

下图以 2021-12-04 观测日，统计过去每个月份的净增长量。

```{r,eval=FALSE}
library(ggplot2)
ggplot(pkgs, aes(x = Month, y = Package)) +
  geom_point()+
  geom_line() +
  geom_hline(yintercept = 0, size = 1, colour = "#535353")  +
  labs(
    x = "", y = "# Packages (log)",
    title = "Packages published on CRAN ever since"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(panel.grid.major.x = element_blank()) 
```

```{r,eval=FALSE}
# 增长速度
Growth <- function(x) {
  c(NA, (tail(x, -1) - head(x, length(x) - 1)) / head(x, length(x) - 1))
}

pkgs <- transform(pkgs, Growth = Growth(Package)) |> 
  subset(subset = !is.na(Growth))

# 增长速度 MoM 月环比 以多快的速度在净增长
ggplot(pkgs, aes(x = Month, y = Growth)) +
  geom_point() +
  geom_line() +
  labs(
    y = "Growth (%)", x = "",
    subtitle = "Packages published on CRAN since 2013"
  ) +
  theme_minimal(
    base_size = 11, base_family = "sans"
  ) +
  theme(panel.grid.major.x = element_blank()) +
  geom_hline(yintercept = 0, size = .6, colour = "#535353")
```

### 选择 R 包

挑选合适的 R 包是一件比较困难的事情，R 社区开发的 R 包实在太多了，重复造的轮子也很多，哪个轮子结实好用就选哪个。

[packagemetrics](https://github.com/sfirke/packagemetrics) 可以统计 R 包各个方面的信息，从而帮助你选择该使用哪个 R 包

```{r,eval=FALSE}
# 两个 R 包列在一起，有各项指标可以比较
library(packagemetrics)

dplyr_and_dt <- package_list_metrics(c("dplyr", "data.table"))
glimpse(dplyr_and_dt)

table_packages = c("dplyr", "data.table", "tidyr")

pkg_df <- package_list_metrics(table_packages) 
# included vector of table pkgs
ft <- metrics_table(pkg_df)
```


## 开发者

<!-- 
关键开发者、所属组织性质，学校、公司 
-->

一个人有多个邮箱的情况比较多，因此清理了 Maintainer 字段中的邮箱，按照习惯来说，人名通常只有一种写法，国外会加入头衔、爵号什么的，这种难以清理合并了。截止目前，R 社区开发者数量已超过 **10000** 人，而根据 Python 官方网站数字 <https://pypi.org/>，Python 社区开发者超过 **55** 万人。

```{r}
maintainer_db <- subset(
  x = pdb,
  subset = !duplicated(Package) & Maintainer != "ORPHANED",
  select = c("Package", "Maintainer")
) |>
  transform(Maintainer = gsub(pattern = "<.*?>", replacement = "", x = Maintainer)) |> 
  transform(Maintainer = trimws(Maintainer, which = "both", whitespace = "[ \t\r\n]")) |> 
  transform(Maintainer = tolower(Maintainer))

length(unique(maintainer_db$Maintainer))
```



### Top 组织

[PBS Software](https://github.com/pbs-software)
[SuperLearner](https://github.com/ecpolley/SuperLearner) [@SuperLearner]
[DrWhy](https://github.com/ModelOriented/DrWhy)[@DrWhy2021]、
[tidymodels](https://github.com/tidymodels/tidymodels)[@Kuhn2020]、 [easystats](https://github.com/easystats/easystats)[@Makowski2020]、 [tidyverse](https://github.com/tidyverse/tidyverse) [@Wickham2019]
[strengejacke](https://github.com/strengejacke/strengejacke)[@Daniel2019]、 [mlr3verse](https://github.com/mlr-org/mlr3verse) [@Lang2021]

目的和 tidymodels 差不多，都是提供做数据建模的完整解决方案，区别在于它不基于 tidyverse 这套东西。

```{r}
str_extract <- function(text, pattern, ...) regmatches(text, regexpr(pattern, text, ...))
# 确保有邮箱
org_pdb <- subset(
  x = pdb,
  select = c("Package", "Maintainer"),
  subset = grepl(pattern = "[<>]", x = Maintainer)
) |> 
  transform(email_suffix = gsub(pattern = ".*?@(.*?)>", replacement = "\\1", x = Maintainer))

org_pdb_aggr <-aggregate(data = org_pdb, Package ~ email_suffix, FUN = function(x) length(unique(x)))

org_pdb_aggr <- org_pdb_aggr[order(org_pdb_aggr$Package, decreasing = TRUE), ]

tmp <- head(org_pdb_aggr, 30)

tmp1 <- head(tmp, ceiling(nrow(tmp) / 2))
tmp2 <- tail(tmp, floor(nrow(tmp) / 2))

knitr::kable(list(tmp1, tmp2),
  col.names = c("邮箱后缀", "R 包数量"), row.names = FALSE,
  caption = "最受欢迎的邮箱（Top 30）"
)
```

看到这个结果还是蛮震惊的，竟有 6584 个 R 包使用 Gmail 邮箱，截止写作时间，CRAN 上全部 R 包 18000 多个，Gmail 邮箱覆盖率超过 1/3！

### 教育机构

我们知道 R 语言社区的很多开发者来自学界，使用学校邮箱的应该不少，因此，决定看看 Top 的大学有哪些，以及总数能否超过 Gmail 邮箱？


```{r}
edu_email <- subset(x = org_pdb_aggr, subset = grepl(pattern = "edu$", x = email_suffix))

tmp <- head(edu_email, 30)

tmp1 <- head(tmp, ceiling(nrow(tmp) / 2))
tmp2 <- tail(tmp, floor(nrow(tmp) / 2))

knitr::kable(list(tmp1, tmp2),
  col.names = c("邮箱后缀", "R 包数量"), row.names = FALSE,
  caption = "贡献 R 包最多的大学（Top 30）"
)
```

好吧，几乎全是欧美各个 NB 大学的，比如华盛顿大学（ uw.edu）、密歇根大学（umich.edu）、加州伯克利大学（berkeley.edu）等等。顺便一说，欧美各个大学的网站，特别是统计院系很厉害的，已经帮大家收集得差不多了，有留学打算的读者自取，邮箱后缀就是学校/院官网。

而使用大学邮箱的 R 包总数竟不及 Gmail 邮箱，可见谷歌邮箱服务在全球 R 语言社区的影响力，赤裸裸的数字，赤裸裸的伤害！虽然有的学校邮箱不以 edu 结尾，有的人虽在学校，但是使用了 Gmail 邮箱，但是巨大的数字鸿沟，几乎可以断定 R 语言社区的开发主力已经从学术界转移到工业界。

```{r}
sum(edu_email$Package)
```

一般人我都不告诉他，勾搭 NB 院校老师的机会来了，我们先来看看斯坦佛大学（stanford.edu）的哪些老师贡献了哪些 R 包。

```{r}
stanford_pdb <- subset(
  x = org_pdb,
  subset = grepl(pattern = "stanford.edu", x = Maintainer),
  select = c("Package", "Maintainer")
) |>
  transform(Maintainer = gsub(pattern = "<.*?>", replacement = "", x = Maintainer)) |>
  transform(Maintainer = trimws(Maintainer, which = "both", whitespace = "[ \t\r\n]"))

tmp <- stanford_pdb[order(stanford_pdb$Maintainer, decreasing = TRUE), ]
tmp1 <- head(tmp, ceiling(nrow(tmp) / 2))
tmp2 <- tail(tmp, floor(nrow(tmp) / 2))

knitr::kable(list(tmp1, tmp2),
  col.names = c("R 包", "开发者"), row.names = FALSE,
  caption = "斯坦福大学开发者（部分）"
)
```


### 高产开发者

```{r}
author_pdb <- subset(x = pdb, select = c("Package", "Maintainer"))
author_pdb_aggr <-aggregate(data = author_pdb, Package ~ Maintainer, FUN = function(x) length(unique(x)))
author_pdb_aggr <- author_pdb_aggr[order(author_pdb_aggr$Package, decreasing = TRUE), ]
author_pdb_aggr <- transform(author_pdb_aggr, Maintainer = gsub(pattern = "<.*?>", replacement = "", x = Maintainer))
tmp = head(author_pdb_aggr, 30)
tmp1 = head(tmp, 15)
tmp2 = tail(tmp, 15)

knitr::kable(list(tmp1, tmp2),
  col.names = c("开发者", "R 包数量"), row.names = FALSE,
  caption = "开发 R 包数量最多的人（Top 30）"
)
```

看到这个结果既有意料之中的，又有很多意料之外的。比如谢益辉竟没有进入前 Top 15，还有好多人是我不知的，甚至是第一次看到，足见我的孤陋寡闻！顺便一提，这其实是一个值得关注的 R 语言社区顶级开发者列表。



### CRAN 团队


```{r,comment=NA,echo=FALSE}
writeLines(readLines(file.path(R.home("doc"), "AUTHORS")))
```


```{r,comment=NA}
core_dev <- subset(pdb,
  subset = grepl(
    x = Maintainer,
    pattern = paste0(c(
      "(@[Rr]-project\\.org)",
      "(ripley@stats.ox.ac.uk)", # Brian Ripley
      "(p.murrell@auckland.ac.nz)", # Paul Murrell
      "(paul@stat.auckland.ac.nz)", # Paul Murrell
      "(maechler@stat.math.ethz.ch)", # Martin Maechler
      "(mmaechler+Matrix@gmail.com)", # Martin Maechler
      "(bates@stat.wisc.edu)", # Douglas Bates
      "(pd.mes@cbs.dk)", # Peter Dalgaard
      "(ligges@statistik.tu-dortmund.de)", # Uwe Ligges
      "(tlumley@u.washington.edu)", # Thomas Lumley
      "(t.lumley@auckland.ac.nz)", # Thomas Lumley
      "(martyn.plummer@gmail.com)", # Martyn Plummer
      "(luke-tierney@uiowa.edu)", # Luke Tierney
      "(stefano.iacus@unimi.it)", # Stefano M. Iacus
      "(murdoch.duncan@gmail.com)", # Duncan Murdoch
      "(michafla@gene.com)" # Michael Lawrence
    ), collapse = "|")
  ),
  select = c("Package", "Maintainer")
) |>
  transform(Maintainer = gsub(
    x = Maintainer,
    pattern = '(<([^<>]*)>)|(")',
    replacement = ""
  )) |>
  transform(Maintainer = gsub(
    x = Maintainer,
    pattern = "(R-core)|(R Core Team)",
    replacement = "CRAN Team"
  )) |>
  transform(Maintainer = gsub(
    x = Maintainer,
    pattern = "(S. M. Iacus)|(Stefano M.Iacus)|(Stefano Maria Iacus)",
    replacement = "Stefano M. Iacus"
  )) |>
  transform(Maintainer = gsub(
    x = Maintainer,
    pattern = "(Toby Hocking)",
    replacement = "Toby Dylan Hocking"
  )) |>
  transform(Maintainer = gsub(
    x = Maintainer,
    pattern = "(John M Chambers)",
    replacement = "John Chambers"
  ))

tmp <- aggregate(data = core_dev, Package ~ Maintainer, FUN = function(x) length(unique(x)))
tmp <- tmp[order(tmp$Package, decreasing = TRUE),]
tmp1 <- head(tmp, ceiling(nrow(tmp) / 2))
tmp2 <- tail(tmp, floor(nrow(tmp) / 2))
knitr::kable(list(tmp1, tmp2),
  col.names = c("团队成员", "R 包数量"), row.names = FALSE,
  caption = "CRAN 团队开发维护 R 包数量情况"
)
```

Martin Maechler、Simon Urbanek、Kurt Hornik、Torsten Hothorn、Achim Zeileis 等真是高产呐！除了维护 R 语言核心代码，还开发维护了**20**多个 R 包！以 Brian Ripley 为例，看看他都开发了哪些 R 包。

```{r}
subset(pdb,
  subset = grepl(
    x = Maintainer,
    pattern = "Brian Ripley"
  ),
  select = c("Package", "Title"), drop = TRUE
) |>
  unique(by = "Package") |> 
  transform(Title = gsub(
    pattern = "(\\\n)",
    replacement = " ", x = Title
  )) |> 
  knitr::kable(row.names = FALSE)
```

震惊！有一半收录在 R 软件中，所以已经持续维护 **20** 多年了。

::: rmdtip
根据邮箱后缀匹配抽取的 R 包及开发者，规则也许不能覆盖所有的情况，读者若有补充，欢迎 PR 给我。举个例子，Brian Ripley 的邮箱 <ripley@stats.ox.ac.uk> 就不是一路，需要单独添加。
:::

看看他们开发的 R 包之间的依赖关系，数据范围就是他们开发的 R 包

```{r}
core_dev_db <- subset(pdb,
  subset = grepl(
    x = Maintainer,
    pattern = paste0(c(
      "(@[Rr]-project\\.org)",
      "(ripley@stats.ox.ac.uk)",    # Brian Ripley
      "(p.murrell@auckland.ac.nz)", # Paul Murrell
      "(paul@stat.auckland.ac.nz)", # Paul Murrell
      "(maechler@stat.math.ethz.ch)", # Martin Maechler
      "(mmaechler+Matrix@gmail.com)", # Martin Maechler
      "(bates@stat.wisc.edu)", # Douglas Bates
      "(pd.mes@cbs.dk)",       # Peter Dalgaard
      "(ligges@statistik.tu-dortmund.de)", # Uwe Ligges
      "(tlumley@u.washington.edu)",        # Thomas Lumley
      "(t.lumley@auckland.ac.nz)",         # Thomas Lumley
      "(martyn.plummer@gmail.com)",        # Martyn Plummer
      "(luke-tierney@uiowa.edu)",          # Luke Tierney
      "(stefano.iacus@unimi.it)",   # Stefano M. Iacus
      "(murdoch.duncan@gmail.com)", # Duncan Murdoch
      "(michafla@gene.com)"         # Michael Lawrence
    ), collapse = "|")
  )
)
```

```{r}
# 顶点
core_dev_pkgs <- core_dev_db[, "Package"]
```


```{r,eval=FALSE}
# A-B 边
core_dev_pkgs_net <- tools::package_dependencies(packages = core_dev_pkgs, db = core_dev_db)

# B-A 边
# core_dev_pkgs_net <- lapply(core_dev_pkgs, tools::dependsOnPkgs, installed = core_dev_db)
# 有效的边
core_dev_pkgs_subnet = core_dev_pkgs_net[unlist(lapply(core_dev_pkgs_net, length)) > 0]

# R 包
# R 包对应的依赖
# 若某个 R 包越受欢迎，它的下游依赖越多，在图上就有越多的 R 包指向它
core_dev_pkgs_subnet_df <- data.frame(
  from = rep(names(core_dev_pkgs_subnet),
    times = unlist(lapply(core_dev_pkgs_subnet, length))
  ),
  to = unlist(core_dev_pkgs_subnet) 
)

base_pkgs = xfun::base_pkgs()

core_dev_pkgs_subnet_df <- subset(x = core_dev_pkgs_subnet_df, subset = !to %in% base_pkgs)
# 所有顶点
node_df <- data.frame(name = unique(c(core_dev_pkgs_subnet_df$from, core_dev_pkgs_subnet_df$to)))

# 统计入度
# core_dev_pkgs_subnet_df = as.data.table(core_dev_pkgs_subnet_df)
# 
# core_dev_pkgs_subnet_df[, weigth := .N, by = "to"]
```


```{r,eval=FALSE}
library(igraph)
# 从 data.frame 创建图
net <- graph_from_data_frame(
  d = core_dev_pkgs_subnet_df,
  vertices = node_df, directed = TRUE
)
# 默认情况下
plot(net)

net <- simplify(net, remove.multiple = F, remove.loops = T)

# layout_with_fr
# layout_with_kk
plot(net,
  edge.arrow.size = .2, edge.curved = .1,
  vertex.label = NA, vertex.size = 2,
  layout = layout_with_fr(net)
)

plot(net,
  edge.arrow.size = .2, edge.curved = .1,
  vertex.label = NA, vertex.size = 2,
  layout = layout_with_graphopt(net)
)

plot(net,
  edge.arrow.size = .2, edge.curved = .1,
  vertex.label = NA, vertex.size = 2,
  layout = layout_with_kk(net)
)

plot(net,
  edge.arrow.size = .5,
  edge.curved = .1,
  edge.color = "gray85",
  # vertex.label=NA,
  vertex.size = .7,
  vertex.label.cex = 0.5,
  layout = layout_with_kk(net)
)
```



### RStudio 团队


```{r}
extract_maintainer <- function(x) {
  x <- gsub(pattern = "<.*?>", replacement = "", x = x)
  x <- trimws(x, which = "both", whitespace = "[ \t\r\n]")
  x
}
rstudio_db <- subset(pdb,
  subset = grepl(x = Maintainer, pattern = "rstudio.com"),
  select = c("Package", "Maintainer")
) |> 
  transform(Maintainer = extract_maintainer(Maintainer))
rstudio_db <- aggregate(data = rstudio_db, Package ~ Maintainer, FUN = function(x) length(unique(x)))
rstudio_db <- rstudio_db[order(rstudio_db$Package, decreasing = TRUE), ]
```
```{r rstudio-developers}
tmp1 <- head(rstudio_db, ceiling(nrow(rstudio_db) / 2))
tmp2 <- tail(rstudio_db, floor(nrow(rstudio_db) / 2))

knitr::kable(list(tmp1, tmp2),
  col.names = c("团队成员", "R 包数量"), row.names = FALSE,
  caption = "RStudio 团队开发维护 R 包数量情况（部分）"
)
```

在开发维护的 R 包里，谢益辉所给的联系邮箱是 <xie@yihui.name>，就不在上述之列，因此，表\@ref(tab:rstudio-developers)中所列仅是部分而已。

CRAN 和 RStudio 团队是 R 语言社区最为熟悉的，其它团队需借助一些网络分析算法挖掘了。


## 开发者关系

选择一个 R 包需要考虑很多因素，最关键的因素还是人，以 data.table 为例，外部依赖很少，运行效率很高，功能覆盖很广，向后兼容很好，帮助文档很全，单测回测很足。R 包的品质可以看出做人做事的品质，Code Style Should Taste Well!

依赖 10 个 R 包，就是依赖 10 个维护者，如果是依赖自个的 R 包，维护者数量就没有 10 个了。

通过 R 包贡献合作的关系

### 贡献者

以 **data.table** 包为例，从元数据中抽取贡献者名单

```{r}
author <- pdb[pdb$Package == "data.table", c("Authors@R")]
author <- gsub(pattern = "[\\\n]", x = author, replacement = "")
author <- eval(parse(text = author))
format(author, include = c("given", "family"))
```

其中，`@javrucebo` 和 `@marc-outins` 是 Github ID 并不是姓名。各个贡献者

```{r}
format(author, include = c("role"))
```

data.table 的维护者，建立`r length(author)`个贡献者到维护者的有向图关系

```{r}
pdb[pdb$Package == "data.table", "Maintainer"]
```

直接依赖 data.table 的 R 包近 1000 个

```{r, out.lines=6}
# 强依赖 data.table 包的 R 包
tools::dependsOnPkgs('data.table', installed = pdb, dependencies = "strong", recursive = FALSE)
```

若算上逆向间接依赖的数量，则多达 2700 多个 R 包。

```{r,eval=FALSE}
tools::dependsOnPkgs('data.table', installed = pdb, dependencies = "strong", recursive = TRUE)
```

前向依赖更是达到了惊人的 4350 个 R 包

```{r,eval=FALSE}
# 前向依赖
tools::package_dependencies(packages = "data.table", db = pdb, reverse = TRUE, which = "most", recursive = "strong")
```


![(\#fig:r-net) R 包依赖关系网络](https://user-images.githubusercontent.com/12031874/138590902-8d631fc8-37d2-4adc-8710-561cefe40697.jpg){ width=55% }


# 案例：博客网络分析

<!-- 
2021-11-25 再发10篇文章后，才做此分析 
-->

我和益辉的文章有很大的相似性，各自文章内的相似性，二者文章间的相似性。
节点和边的定义，仿照落园园主的金庸小说做法。


# 环境信息

在 RStudio IDE 内编辑本文的 R Markdown 源文件，用 **blogdown** 构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 knitr 之后的 Markdown 文件，得益于 **blogdown** 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：

```{r}
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "blogdown",
  "data.table", "node2vec"
))
```


# 参考文献
