---
title: 地理可视化与 R 语言
author: 黄湘云
date: '2022-03-25'
slug: maps-in-r
categories:
  - 统计图形
tags:
  - 地理可视化
  - ggplot2
  - ggmap
  - maps
  - leaflet
  - leafletCN
  - baidumap
  - RgoogleMaps
  - choroplethr
  - lattice
  - latticeExtra
toc: true
draft: true
link-citations: true
bibliography: 
  - refer.bib
  - packages.bib
description: "介绍用于地理可视化的几种常用数据结构，比如 **sp** 包、**sf** 包和 **raster** 包提供的三种空间数据存储、操作的类和方法。
介绍地理可视化常用的展示形式，如瓦片图、围栏图、气泡图等，以及绘制过程中需要注意的制图规范问题，地理信息是比较敏感的数据，从大的层面上来说，涉及国家主权和领土完整。笔者合著的书籍《现代统计图形》曾因此将所有地图相关的介绍全部摘除，本文也意图去梳理和填补这方面的坑点。"
---

<style type="text/css">
.sidebar {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.sidebar, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.rmdinfo {
  border: 1px solid #ccc;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}
div.rmdinfo::before {
  content: "声明";
  color: block;
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

figure {
  text-align: center;
}

div.img {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}
</style>

<div class="rmdinfo">

本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。

</div>

# 概览

介绍用于地理可视化的几种常用数据结构，比如 sp 包、sf 包和 raster 包提供的三种空间数据存储、操作的类和方法。
介绍地理可视化常用的展示形式，如瓦片图、围栏图、气泡图等，以及绘制过程中需要注意的制图规范问题，地理信息是比较敏感的数据，从大的层面上来说，涉及国家主权和领土完整。

<!-- 
需要数据的话，R 语言社区有很多开放数据

百度地图慧眼 迁徙 https://qianxi.baidu.com/ 

腾讯大数据 https://data.qq.com/
腾讯开放平台
https://open.tencent.com/
城市数据派 需要会员注册才能下载数据
https://www.udparty.com/

创建一个 R Shiny 应用将会比较有趣
https://lbs.amap.com/ 申请 API 令牌
用 R 调用高德地图实现路径规划
https://cxy.rbind.io/post/2021/10/14/r-amap/
-->

# 地图服务

比较常见的地图服务，国外有谷歌、微软，国内有百度、高德，凡是提供本地生活服务的公司都或多或少地依赖高精地图，如美团外卖，阿里飞猪等。本文主要带领读者了解地图服务，以及使用 R 语言来做地理可视化，为增加代入感，笔者就以「中国矿业大学（北京）学院路校区」这个地标的 IP 定位开始。首先用 [curl](https://curl.se/) 工具请求网站 <https://ipinfo.io/>[^1]，它会自动获取用户上网使用的 IP 以及 IP 所处的地理位置，如下：

``` bash
curl ipinfo.io
```

    {
      "ip": "223.71.83.98",
      "city": "Beijing",
      "region": "Beijing",
      "country": "CN",
      "loc": "39.9288,116.3890",
      "org": "AS56048 China Mobile Communicaitons Corporation"
    }

可知学校所处位置：纬度 39.9288 经度 116.3890，当然这离高精地图还有十万八千里，也正因定位的粗糙性，笔者才敢把它放在博客里，毕竟高精地理信息是涉及国家安全的内容。另外，值得注意的是对同一目标不同公司提供的定位可能是不同的，因为所选的地理参考系不同，常用的三种坐标系见文档[坐标系](https://lbsyun.baidu.com/index.php?title=coordinate)。大家熟知的GPS全球卫星定位系统采用 WGS84，而 GCJ02 由WGS84加密后的坐标系，是由中国国家测绘局制定的地理坐标系统，又称火星坐标系。BD09为百度坐标系，在GCJ02坐标系基础上再次加密。注意，加密过程不可逆，是一种非线性加密方式，反向解密后的坐标在部分区域的定位差别很大。

## 谷歌地图

David Kahle 开发的[**ggmap**](https://github.com/dkahle/ggmap) ([Kahle and Wickham 2013](#ref-Kahle2013)) 包在 2011 年发布在 CRAN 上，是一个基于 ggplot2 的空间可视化包，背景地图来自谷歌地图。目前，由于 Google 地图服务策略调整，需要申请 Google 地图服务的访问令牌才可以使用地图服务。
可将申请到的 `GGMAP_GOOGLE_API_KEY` 保存到本地文件 `~/.Renviron`，以供 **ggmap** 后续使用。

Google 提供的是一种瓦片地图，即由一张张小图片拼凑起来形成一张完整的地图，就好像盖房用的瓦片。精度由瓦片的分辨率决定，且是栅格 raster 地图，而非矢量地图，如图 <a href="#fig:ggmap-tile">1</a> 所示。

<figure>
<img src="http://tile.stamen.com/terrain-background/5/4/10.png" class="full" alt="Figure 1: ggmap 地形图" /><figcaption aria-hidden="true">Figure 1: ggmap 地形图</figcaption>
</figure>

ggmap 可以调用多种样式的地图，地形图、水彩图等，如图<a href="#fig:ggmap-tiles">2</a> 所示。

``` r
library(ggplot2)
library(ggmap)
library(patchwork)

us <- c(left = -125, bottom = 25.75, right = -67, top = 49)
# 从 tile server 服务器上下载 Stamen Maps 数据，组成一个图片
dat1 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "toner-lite"
  )
p1 <- ggmap(dat1)
# 地形图
dat2 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "terrain"
)
p2 <- ggmap(dat2)

dat3 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "watercolor"
)
p3 <- ggmap(dat3)

dat4 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "terrain-background"
)
p4 <- ggmap(dat4)

p1 / p2 | p3 / p4
```

<figure>
<img src="/img/maps-in-r/ggmap-tiles.png" class="full" alt="Figure 2: ggmap 几种常用背景地图" /><figcaption aria-hidden="true">Figure 2: ggmap 几种常用背景地图</figcaption>
</figure>

## 必应地图

与 **ggmap** 相比，[**RgoogleMaps**](https://github.com/markusloecher/rgooglemaps) ([Loecher and Ropkins 2015](#ref-Loecher2015)) 支持更多的地图服务，除了 Google 地图外，还支持必应地图，以及基于 lattice 的可视化，借助 [**loa**](https://r-forge.r-project.org/scm/?group_id=1400) 和 [**latticeExtra**](https://r-forge.r-project.org/projects/latticeextra/) 还可以支持高级的自定义，如何使用见[ggmap 使用案例](https://github.com/vertica/Vertica-Geospatial)
、[loa 文档](https://loa.r-forge.r-project.org/loa.intro.html)和[latticeExtra 文档](https://latticeextra.r-forge.r-project.org/)。

``` r
library(RgoogleMaps) # 同时需要 RCurl
library(RCurl)
```

使用 Bing 地图服务也是需要 `API_KEY` 的，可先去 [Bing 地图开发中心](https://www.bingmapsportal.com/) 用 Outlook 邮箱创建账户，然后申请免费的基础版，过程见[说明](https://www.microsoft.com/en-us/maps/create-a-bing-maps-key)。

``` r
map_cumtb <- GetBingMap(
  center = c(lat = 40.0, lon = 116.4), zoom = 12, 
  apiKey = Sys.getenv("BingMap_API_KEY"), verbose = 0, 
  destfile = "CUMTB.png"
)
PlotOnStaticMap(map_cumtb)
```

如图 <a href="#fig:bing-cumtb">3</a> 所示，坐标（40.0, 116.4）定位在中国矿业大学（北京）学院路校区。

<figure>
<img src="/img/maps-in-r/bing-cumtb.png" class="full" alt="Figure 3: 微软必应地图" /><figcaption aria-hidden="true">Figure 3: 微软必应地图</figcaption>
</figure>

## 百度地图

杜亚磊开发的[baidumap](https://github.com/badbye/baidumap)包可以调用百度地图服务 <https://map.baidu.com/> 提供地理可视化的背景地图。百度是国内比较早的互联网公司，之前介绍的 Apache Echarts 最早也是百度可视化团队开发的，百度地理信息可视化平台使用的地理可视化组件来自开源的[mapv](https://github.com/huiyan-fe/mapv)。

在百度地图上，根据地理名称获得经纬度信息，获得经纬度后，可以将位置标记在地图上，下面以「中国矿业大学（北京）」为例

``` r
remotes::install_github('badbye/baidumap')
```

`BaiduMap_API_Key` 是从[百度 LBS 云服务](https://lbsyun.baidu.com/)申请到的地图 API 访问令牌，保存到本地 `.Renviron` 文件里 `BaiduMap_API_Key=[key]`，这样启动 R 软件时就会自动载入。

``` r
library(baidumap)
options(baidumap.key = Sys.getenv("BaiduMap_API_Key"))
getCoordinate('中国矿业大学（北京）学院路校区', formatted = T)
# longtitude   latitude 
#      116.4       40.0
```

``` r
library(ggplot2)
cumtb_map <- getBaiduMap("中国矿业大学（北京）学院路校区", zoom = 12)
cumtb_coordinate <- getCoordinate("中国矿业大学（北京）学院路校区", formatted = T)
cumtb_coordinate <- data.frame(t(cumtb_coordinate))
# 调 ggmap 绘制背景地图
ggmap::ggmap(cumtb_map) +
  geom_point(aes(x = longtitude, y = latitude),
    data = cumtb_coordinate, col = "red", size = 5
  )
```

<figure>
<img src="/img/maps-in-r/baidumap-cumtb.png" class="full" alt="Figure 4: 百度地图-中国矿业大学（北京）" /><figcaption aria-hidden="true">Figure 4: 百度地图-中国矿业大学（北京）</figcaption>
</figure>

## 开放地图

OpenStreetMap 虽是开放数据，来自世界各地的贡献者，不提供免费的地图 API，使用此地图服务，不会将自己的数据上传至 OpenStreetMap 的服务器上。而 Leaflet 是开源的交互式地理可视化 JS 库。

<figure>
<img src="/img/leaflet.svg" class="full" alt="Figure 5: 开源交互式 JavaScript 库 Leaflet" /><figcaption aria-hidden="true">Figure 5: 开源交互式 JavaScript 库 Leaflet</figcaption>
</figure>

Joe Cheng 开发维护的 [leaflet](https://github.com/rstudio/leaflet) 包是 JavaScript 库 [Leaflet](https://github.com/Leaflet/Leaflet) 的 R 语言接口。

在 leaflet 地图上实际经纬度为 `c(116.34394, 39.99665)`

``` r
library(magrittr)
library(leaflet)
cumtb_map1 = leaflet() %>% 
  setView(lng = 116.34394, lat = 39.99665, zoom = 17) %>%
  addTiles() %>% 
  addPopups(116.34394, 39.99665, '这里是 <b>学院路校区</b>, 中国矿业大学（北京）')
cumtb_map1
```

<figure>
<img src="/img/maps-in-r/leaflet-cumtb.png" class="full" alt="Figure 6: OpenStreetMap 地图-中国矿业大学（北京）" /><figcaption aria-hidden="true">Figure 6: OpenStreetMap 地图-中国矿业大学（北京）</figcaption>
</figure>

不难看出，百度地图和 leaflet 地图的坐标系不是同一个，获取的经纬度不同，这里将矿大（北京）定位到农大了

``` r
cumtb_map2 = leaflet() %>% 
  setView(lng = 116.35688, lat = 40.00314, zoom = 17) %>%
  addTiles() %>% 
  addPopups(116.35688, 40.00314, '这里是 <b>学院路校区</b>, 中国矿业大学（北京）')
cumtb_map2
```

注意：GeoIP 只能给定一个粗略的经纬度信息，根据IP解析出来的经纬度 `c(116,39.9)` ，相比百度地图API根据地理名称获取的经纬度`c(116.35688,40.00314 )`就更加模糊了

## 高德地图

<!-- 
补充此测绘资质意味着什么？
-->

高德和百度都是有甲级测绘资质的单位

``` r
library(leaflet)
library(leafletCN)

leaflet(options = leafletOptions(
  minZoom = 4, maxZoom = 18,
  zoomControl = FALSE
)) %>%
  amap() %>%
  addCircles(
    data = data.frame(lon = 116.35688, lat = 40.00314, size = 50),
    lng = ~lon, lat = ~lat, radius = ~size, color = "red",
    fillOpacity = 0.55, stroke = T, weight = 1,
    label = htmltools::HTML("这里是 <b>学院路校区</b>, 中国矿业大学（北京）")
  )
```

高德地图采用的是火星坐标系和 leaflet 采用的 GPS 坐标系不同，导致矿大定位到了农大，如图<a href="#fig:leaflet-amap-cumtb">7</a>

<figure>
<img src="/img/maps-in-r/leaflet-amap-cumtb.png" class="full" alt="Figure 7: 高德地图-中国矿业大学（北京）" /><figcaption aria-hidden="true">Figure 7: 高德地图-中国矿业大学（北京）</figcaption>
</figure>

# 基础知识

## 网址定位

<!-- 
为什么网址 IP 网络协议 address 可以定位 GeoIP
如何使用？R 包如何使用它们？
-->

GeoIP 数据库 [MaxMind](https://github.com/maxmind)

``` bash
brew install geoip geoipupdate
```

离线下载 [GeoLite2 数据库](https://dev.maxmind.com/geoip/geoip2/geolite2/)，下载地址

``` bash
curl -C - -O http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz
```

![GeoLite2 数据库下载页面](https://wp-contents.netlify.com/2018/12/GeoIP2.png)

将 maxmind 格式数据库移动到 [**rgeolocate** 包](https://github.com/ironholds/rgeolocate) 的额外数据存放位置

**rgeolocate** 只包含 GeoLite2-Country.mmdb 数据

解析 IP，获取 IP 指向的洲名，国家代码，国家，城市，城市唯一识别码，所在时区和经纬度。

``` r
library(rgeolocate)
results <- maxmind(
  ips = "111.203.130.69",
  file = system.file("extdata", "GeoLite2-Country.mmdb", package = "rgeolocate"),
  fields = c(
    "continent_name", "country_code", "country_name",
    "region_name", "city_name", "city_geoname_id",
    "timezone", "longitude", "latitude"
  )
)
results
#   continent_name country_code country_name region_name city_name
# 1           Asia           CN        China        <NA>      <NA>
#   city_geoname_id timezone longitude latitude
# 1              NA     <NA>        NA       NA
```

依次是洲、国家编码简称、国家名称、区域（省级）名称、城市名称、城市代码（不确定编码体系，此外国家行政区划编码）、时区、经度和纬度。

这里使用的 IP 地址 111.203.130.69 在中国矿业大学（北京）校区内。

## 坐标编码

GeoHash

## 坐标系统

地球既不是圆球的也不是标准的椭球，将三维的球面投影到二维的平面有不同的方法，每一种方法都对应一种坐标转化，选定坐标原点后即构成坐标参考系统（Coordinate Reference System，简称 CRS）。**maps** 包内置了一份世界地图数据，下面以此为例介绍，本节空间数据的操作都用 **sf** 包来完成。

``` r
library(sf)
# Linking to GEOS 3.8.1, GDAL 3.2.1, PROJ 7.2.1; sf_use_s2() is TRUE
library(maps)
# st_as_sf 将 map 类转化为 sf 类
world1 <- st_as_sf(map("world", plot = FALSE, fill = TRUE))
## 检索坐标参考系统
st_crs(world1)
# Coordinate Reference System:
#   User input: EPSG:4326 
#   wkt:
# GEOGCRS["WGS 84",
#     DATUM["World Geodetic System 1984",
#         ELLIPSOID["WGS 84",6378137,298.257223563,
#             LENGTHUNIT["metre",1]]],
#     PRIMEM["Greenwich",0,
#         ANGLEUNIT["degree",0.0174532925199433]],
#     CS[ellipsoidal,2],
#         AXIS["geodetic latitude (Lat)",north,
#             ORDER[1],
#             ANGLEUNIT["degree",0.0174532925199433]],
#         AXIS["geodetic longitude (Lon)",east,
#             ORDER[2],
#             ANGLEUNIT["degree",0.0174532925199433]],
#     USAGE[
#         SCOPE["Horizontal component of 3D system."],
#         AREA["World."],
#         BBOX[-90,-180,90,180]],
#     ID["EPSG",4326]]
## world 数据集采用 WGS 84 坐标系
st_crs("EPSG:4326")
# Coordinate Reference System:
#   User input: EPSG:4326 
#   wkt:
# GEOGCRS["WGS 84",
#     DATUM["World Geodetic System 1984",
#         ELLIPSOID["WGS 84",6378137,298.257223563,
#             LENGTHUNIT["metre",1]]],
#     PRIMEM["Greenwich",0,
#         ANGLEUNIT["degree",0.0174532925199433]],
#     CS[ellipsoidal,2],
#         AXIS["geodetic latitude (Lat)",north,
#             ORDER[1],
#             ANGLEUNIT["degree",0.0174532925199433]],
#         AXIS["geodetic longitude (Lon)",east,
#             ORDER[2],
#             ANGLEUNIT["degree",0.0174532925199433]],
#     USAGE[
#         SCOPE["Horizontal component of 3D system."],
#         AREA["World."],
#         BBOX[-90,-180,90,180]],
#     ID["EPSG",4326]]
```

**sf** 包提供 `st_as_sf()` 函数将 map 类转化为 sf 类，`st_crs()` 函数检索地图数据中附带的坐标参考系信息。接下来，用 `st_transform()` 函数转化坐标，参数 `crs` 指定新的坐标系统，示例里 `+proj=laea` 表示目标映射关系 Lambert Azimuthal Equal Area，而 `+ellps=WGS84` 即 [WGS 1984](https://en.wikipedia.org/wiki/World_Geodetic_System) 或称 [EPSG:4326](https://en.wikipedia.org/wiki/EPSG_Geodetic_Parameter_Dataset)，坐标系 WGS84 被全球定位系统采用，也简称 GPS 坐标系。`+lon_0=155` 和 `+lat_0=-90` 分别是经纬度，东经 155 度，南纬 90 度，也就是观测视角到南极去了。

``` r
# 坐标转化
world2 <- st_transform(
  x = world1,
  crs = "+proj=laea +y_0=0 +lon_0=155 +lat_0=-90 +ellps=WGS84 +no_defs"
)
## 检索坐标参考系统
st_crs(world2)
# Coordinate Reference System:
#   User input: +proj=laea +y_0=0 +lon_0=155 +lat_0=-90 +ellps=WGS84 +no_defs 
#   wkt:
# PROJCRS["unknown",
#     BASEGEOGCRS["unknown",
#         DATUM["Unknown based on WGS84 ellipsoid",
#             ELLIPSOID["WGS 84",6378137,298.257223563,
#                 LENGTHUNIT["metre",1],
#                 ID["EPSG",7030]]],
#         PRIMEM["Greenwich",0,
#             ANGLEUNIT["degree",0.0174532925199433],
#             ID["EPSG",8901]]],
#     CONVERSION["unknown",
#         METHOD["Lambert Azimuthal Equal Area",
#             ID["EPSG",9820]],
#         PARAMETER["Latitude of natural origin",-90,
#             ANGLEUNIT["degree",0.0174532925199433],
#             ID["EPSG",8801]],
#         PARAMETER["Longitude of natural origin",155,
#             ANGLEUNIT["degree",0.0174532925199433],
#             ID["EPSG",8802]],
#         PARAMETER["False easting",0,
#             LENGTHUNIT["metre",1],
#             ID["EPSG",8806]],
#         PARAMETER["False northing",0,
#             LENGTHUNIT["metre",1],
#             ID["EPSG",8807]]],
#     CS[Cartesian,2],
#         AXIS["(E)",north,
#             MERIDIAN[90,
#                 ANGLEUNIT["degree",0.0174532925199433,
#                     ID["EPSG",9122]]],
#             ORDER[1],
#             LENGTHUNIT["metre",1,
#                 ID["EPSG",9001]]],
#         AXIS["(N)",north,
#             MERIDIAN[0,
#                 ANGLEUNIT["degree",0.0174532925199433,
#                     ID["EPSG",9122]]],
#             ORDER[2],
#             LENGTHUNIT["metre",1,
#                 ID["EPSG",9001]]]]
## WGS 84 / Pseudo-Mercator 墨卡托投影
st_crs("EPSG:3857")
# Coordinate Reference System:
#   User input: EPSG:3857 
#   wkt:
# PROJCRS["WGS 84 / Pseudo-Mercator",
#     BASEGEOGCRS["WGS 84",
#         DATUM["World Geodetic System 1984",
#             ELLIPSOID["WGS 84",6378137,298.257223563,
#                 LENGTHUNIT["metre",1]]],
#         PRIMEM["Greenwich",0,
#             ANGLEUNIT["degree",0.0174532925199433]],
#         ID["EPSG",4326]],
#     CONVERSION["Popular Visualisation Pseudo-Mercator",
#         METHOD["Popular Visualisation Pseudo Mercator",
#             ID["EPSG",1024]],
#         PARAMETER["Latitude of natural origin",0,
#             ANGLEUNIT["degree",0.0174532925199433],
#             ID["EPSG",8801]],
#         PARAMETER["Longitude of natural origin",0,
#             ANGLEUNIT["degree",0.0174532925199433],
#             ID["EPSG",8802]],
#         PARAMETER["False easting",0,
#             LENGTHUNIT["metre",1],
#             ID["EPSG",8806]],
#         PARAMETER["False northing",0,
#             LENGTHUNIT["metre",1],
#             ID["EPSG",8807]]],
#     CS[Cartesian,2],
#         AXIS["easting (X)",east,
#             ORDER[1],
#             LENGTHUNIT["metre",1]],
#         AXIS["northing (Y)",north,
#             ORDER[2],
#             LENGTHUNIT["metre",1]],
#     USAGE[
#         SCOPE["Web mapping and visualisation."],
#         AREA["World between 85.06°S and 85.06°N."],
#         BBOX[-85.06,-180,85.06,180]],
#     ID["EPSG",3857]]
```

下面将两个不同坐标系统下的世界地图绘制出来，如图 <a href="#fig:sf-crs">8</a> 所示。

``` r
library(ggplot2)
library(patchwork)
p1 <- ggplot() +
  geom_sf(data = world1)

p2 <- ggplot() +
  geom_sf(data = world2)

p1 + p2
```

<figure>
<img src="/img/maps-in-r/sf-crs.png" class="full" alt="Figure 8: 坐标系统" /><figcaption aria-hidden="true">Figure 8: 坐标系统</figcaption>
</figure>

# 数据可视化

地理可视化的展示形式有气泡图、热力图、瓦片图、地形图等，下面陆续使用 **lattice** 、**ggplot2** 和 **leaflet** 来绘制静态和交互图形。

[choroplethr](https://github.com/trulia/choroplethr) 和[choroplethrMaps](https://github.com/trulia/choroplethrMaps) 主要用来制作地区分布图，需要的区域数据，**choroplethrMaps** 包提供三份地图数据，分别是美国州、县地图和世界地图， 相关介绍材料见[这里](https://arilamstein.com/open-source/)。[tmap](https://github.com/r-tmap/tmap) 制作交互地图，[mapsf](https://github.com/riatelab/mapsf) 制作符号地图、等值地图、拓扑地图，关于各类地图的可视化示例见[AntV 官网](https://antv.vision/zh)。[mapsapi](https://github.com/michaeldorman/mapsapi) 可以连接 4 种 Google 提供的 Web 地图服务。

## 示例：美国旧金山犯罪数据

下面以 **RgoogleMaps** 包内置的空间数据集 incidents 为例介绍

``` r
library(RgoogleMaps)
# 加载 incidents 
data(incidents)
# 查看数据
head(incidents)
#        IncidntNum           Category
# 67026   120621114            ASSAULT
# 34773   120328627     OTHER OFFENSES
# 113571  120653593       NON-CRIMINAL
# 35951   120333927      LARCENY/THEFT
# 102975  120963370     OTHER OFFENSES
# 35201   120338701 DISORDERLY CONDUCT
#                                     Descript DayOfWeek       Date
# 67026                               STALKING  Saturday 2012-07-21
# 34773    FAILURE TO HEED RED LIGHT AND SIREN Wednesday 2012-04-25
# 113571          AIDED CASE, MENTAL DISTURBED    Friday 2012-08-17
# 35951            PETTY THEFT FROM A BUILDING    Friday 2012-04-27
# 102975 DRIVERS LICENSE, SUSPENDED OR REVOKED  Thursday 2012-11-29
# 35201          MAINTAINING A PUBLIC NUISANCE    Sunday 2012-04-29
#         Time PdDistrict        Resolution
# 67026  00:01       PARK              NONE
# 34773  17:29    MISSION              NONE
# 113571 09:50   SOUTHERN PSYCHOPATHIC CASE
# 35951  11:30       PARK              NONE
# 102975 07:00    BAYVIEW     ARREST, CITED
# 35201  00:23    MISSION    ARREST, BOOKED
#                            Location    lon   lat violent HrOfDay
# 67026  MCALLISTER ST / BRODERICK ST -122.4 37.78    TRUE      00
# 34773           16TH ST / BRYANT ST -122.4 37.77   FALSE      17
# 113571      1200 Block of MARKET ST -122.4 37.78   FALSE      09
# 35951        1000 Block of HAYES ST -122.4 37.78   FALSE      11
# 102975    BAY SHORE BL / AUGUSTA ST -122.4 37.73   FALSE      07
# 35201          400 Block of CAPP ST -122.4 37.76   FALSE      00
#        TimeOfDay HourOfWeek censusBlock
# 67026    0.01667     24.017 06075015802
# 34773   17.48333    137.483 06075017700
# 113571   9.83333      9.833 06075017601
# 35951   11.50000     11.500 06075016400
# 102975   7.00000    151.000 06075025702
# 35201    0.38333     48.383 06075020800
```

数据集 incidents 来自 2012 年旧金山的犯罪数据，更多数据见 [DataSF 项目](https://datasf.org/opendata/)，一些数据分析见 Github [项目](https://github.com/datasf)。数据集 incidents 随机抽取了 5000 行，16个观测变量，分别是犯罪数目 `IncidntNum`、犯罪类型 `Category`、犯罪行为描述 `Descript`、犯罪行为发生在周几 `DayOfWeek`、犯罪行为发生的日期 `Date`、犯罪行为发生的时间（hh::mm）`Time`、警局辖区 `PdDistrict`、警方处置方式 `Resolution`、位置 `Location`、经度 `lon`、纬度 `lat`、是否属于暴力行为 `violent`、发生时间（小时，以2位整数计） `HrOfDay`、发生时间（小时，以10进制计）`TimeOfDay`、发生时间（一周168个小时，0-168之间的数字）`HourOfWeek`、人口普查的区块标记 `censusBlock`。图<a href="#fig:incidents-map">9</a>展示警方出警地点，或者说犯罪行为发生地点，红点表示此处发生暴力冲突，黑点表示此处没有暴力冲突。

``` r
plotmap(
  lat = lat, lon = lon, data = incidents, 
  col = 'violent', zoom = 12,
  pch = 20, cex = 0.5, API = "google",
  apiKey = Sys.getenv("GGMAP_GOOGLE_API_KEY")
)
```

<figure>
<img src="/img/maps-in-r/incidents-map.png" class="full" alt="Figure 9: 2012 年旧金山警方出警地点的空间分布" /><figcaption aria-hidden="true">Figure 9: 2012 年旧金山警方出警地点的空间分布</figcaption>
</figure>

除了 **RgoogleMaps** 提供的 `plotmap()` 函数，当然，还可以用 **leaflet** 来绘制交互式的散点图，因为交互，可以放入更多的信息。如图<a href="#fig:incidents-leaflet">10</a>，鼠标悬浮在散点上可以看到事件发生的警区 PdDistrict，点击可以看到警方的处置方式 Resolution，这是设置 `addCircles()` 的参数 `label` 和 `popup` 实现的，实际上，它们还可以放入更加丰富的信息。

``` r
library(leaflet)
# 分类变量映射成颜色
colorize_factor <- function(x) {
  # 设置颜色梯度数目
  scales::col_factor(palette = "plasma", domain = unique(x))(x)
}
# 警方处置方式 Resolution 映射成颜色变量
incidents <- transform(incidents, color = colorize_factor(Resolution))
# 绘制交互图形
leaflet(options = leafletOptions(
    minZoom = 4, maxZoom = 18, zoomControl = FALSE
  )) |> 
  addTiles() |> 
  setView(lng = -122.4, lat = 37.77, zoom = 13) |> 
  addCircles(
    data = incidents, popup = ~Resolution, 
    radius = 30, label = ~PdDistrict,
    lng = ~lon, lat = ~lat, color = ~color
  ) |> 
  addLegend("topright", pal = colorFactor(
    palette = "plasma", domain = unique(incidents$Resolution)
  ), values = incidents$Resolution, opacity = 1)
```

<figure>
<img src="/img/maps-in-r/incidents-leaflet.png" class="full" alt="Figure 10: 2012 年旧金山警方出警地点的空间分布" /><figcaption aria-hidden="true">Figure 10: 2012 年旧金山警方出警地点的空间分布</figcaption>
</figure>

接下来再细致一点地探索 incidents 数据集，各个警区出警次数的分布情况，

``` r
library(data.table)
incidents <- as.data.table(incidents)
library(ggplot2)
# SOUTHERN 警区的犯罪记录显著高于其他警区
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("PdDistrict", "violent")]

ggplot(data = dat, aes(x = PdDistrict, y = cnt, fill = violent)) +
  geom_col()
```

<figure>
<img src="/img/maps-in-r/incidents-pddistrict.png" class="full" alt="Figure 11: 事件发生次数随警区的分布" /><figcaption aria-hidden="true">Figure 11: 事件发生次数随警区的分布</figcaption>
</figure>

进一步，可将图<a href="#fig:incidents-pddistrict">11</a>所示分布绘制在地图上，如图<a href="#fig:incidents">12</a>事件发生次数随警区的空间分布。

``` r
dat <- incidents[, .(cnt = length(IncidntNum), lat = mean(lat), lon = mean(lon)), by = c("violent", "PdDistrict")]
# RgoogleMapsPlot 函数合成了地图和 lattice 分面绘图的能力
RgoogleMapsPlot(cnt ~ lat * lon | violent,
  data = dat,
  pch = 19, col = "orangered",
  scales = list(
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  panel = panel.loaPlot, show.axes = TRUE
)
```

<figure>
<img src="/img/maps-in-r/incidents.png" class="full" alt="Figure 12: 事件发生次数随警区的空间分布：左图非暴力事件，右图暴力事件" /><figcaption aria-hidden="true">Figure 12: 事件发生次数随警区的<strong>空间</strong>分布：左图<strong>非暴力</strong>事件，右图<strong>暴力</strong>事件</figcaption>
</figure>

全年来看，事件发生的时间分布，即犯罪的高峰时段在下午 5-6 点，一直持续到午夜 12 点。

``` r
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("HrOfDay", "violent")]
ggplot(data = dat, aes(x = HrOfDay, y = cnt, fill = violent)) +
  geom_col()
```

<figure>
<img src="/img/maps-in-r/incidents-hour.png" class="full" alt="Figure 13: 事件发生次数随时段的分布" /><figcaption aria-hidden="true">Figure 13: 事件发生次数随时段的分布</figcaption>
</figure>

每次接报出警，警方会根据具体情况快速对事件定级分类，然后派出相应的警力以及处置方式。可以见事件性质 Category、是否发生暴力 violent 和警方处置方式 Resolution 应当有很强的关联。既然 Category， violent 和 Resolution 有很强的关联，展示关联关系非常重要，有的分类 Category 应该给予足够的处置力度，特别对于暴力事件，警方的措施是否有不当或处置不力的？以此，还可以推测旧金山的治安状况。

``` r
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("Category", "violent", "Resolution")]

ggplot(data = dat, aes(x = reorder(Category, cnt), y = cnt, fill = Resolution)) +
  geom_col() +
  coord_flip() +
  facet_grid(rows = vars(violent), scales = "free", space = "free") +
  labs(x = "Category")
```

<figure>
<img src="/img/maps-in-r/incidents-resolution.png" class="full" alt="Figure 14: 事件性质和警方处置情况" /><figcaption aria-hidden="true">Figure 14: 事件性质和警方处置情况</figcaption>
</figure>

对于不同的事件 Category 有不同的执行措施 Resolution，执行措施和是否属于暴力有关系，一般来讲，暴力事件都应该有处置，发生暴力事件只有 5 类，打架斗殴、抢劫、性骚扰、绑架、盗窃。

| Category                    | Category_cn |
|:----------------------------|:------------|
| LARCENY/THEFT               | 盗窃        |
| NON-CRIMINAL                | 非犯罪      |
| OTHER OFFENSES              | 其他罪行    |
| ASSAULT                     | 打架斗殴    |
| VANDALISM                   | 蓄意破坏    |
| DRUG/NARCOTIC               | 毒品/麻醉品 |
| BURGLARY                    | 入室盗窃    |
| VEHICLE THEFT               | 车辆盗窃    |
| MISSING PERSON              | 人员失踪    |
| ROBBERY                     | 抢劫        |
| SUSPICIOUS OCC              | 可疑的 OCC  |
| FRAUD                       | 欺诈        |
| TRESPASS                    | 非法入侵    |
| FORGERY/COUNTERFEITING      | 伪造/假冒   |
| WEAPON LAWS                 | 武器法      |
| DISORDERLY CONDUCT          | 扰乱秩序    |
| RECOVERED VEHICLE           | 回收车辆    |
| DRIVING UNDER THE INFLUENCE | 非正常行驶  |
| DRUNKENNESS                 | 醉酒        |
| SEX OFFENSES, FORCIBLE      | 性骚扰      |
| RUNAWAY                     | 逃跑        |
| KIDNAPPING                  | 绑架        |
| LOITERING                   | 游荡        |
| LIQUOR LAWS                 | 酒法        |
| PROSTITUTION                | 卖淫        |
| ARSON                       | 纵火        |
| EMBEZZLEMENT                | 挪用公款    |
| EXTORTION                   | 勒索        |
| STOLEN PROPERTY             | 被盗财产    |
| GAMBLING                    | 赌博        |
| BAD CHECKS                  | 空头支票    |
| PORNOGRAPHY/OBSCENE MAT     | 色情/淫秽   |
| SUICIDE                     | 自杀        |

Table 1: 事件性质

## 示例：美国人口普查统计数据

静态的和交互式的地图

[Choropleth Map](https://en.wikipedia.org/wiki/Choropleth_map)

参考苏玮制作的日本新冠疫情看板 [COVID-19](https://github.com/swsoyee/2019-ncov-japan)

[用 tidycensus 和 tmap 创建人口统计数据地图](http://zevross.com/blog/2018/10/02/creating-beautiful-demographic-maps-in-r-with-the-tidycensus-and-tmap-packages/)

``` r
library(ggplot2)
state.x77 <- data.frame(state = tolower(rownames(state.x77)), state.x77)

usmap::plot_usmap(data = state.x77, values = "Population", labels = TRUE) +
  scale_fill_gradientn(
    colours = hcl.colors(10), na.value = "grey90",
    guide = guide_colourbar(
      barwidth = 25, barheight = 0.4,
      title.position = "top" # 图例标题位于图例上方
    )
  ) +
  labs(fill = "State Population (1975)") +
  theme(legend.position = "bottom") # 图例位置图形下方
```

<figure>
<img src="/img/maps-in-r/usmap-statex77.png" class="full" alt="Figure 15: 1975年美国各个州的人口" /><figcaption aria-hidden="true">Figure 15: 1975年美国各个州的人口</figcaption>
</figure>

## 示例：美国锡安公园地形数据

美国西南部犹他州锡安国家公园的高程珊格数据 elevation，该数据集由 [Jakub Nowosad](https://nowosad.github.io/) 收集于 [spDataLarge](https://github.com/Nowosad/spDataLarge) 包内，由于该 R 包收集的地理信息数据很多又很大，超出了 CRAN 对 R 包的大小限制，因此，需要从作者制作的 drat 站点下载。

``` r
install.packages("spDataLarge", repos = "https://nowosad.github.io/drat/")
```

elevation 数据集通过雷达地形测绘 SRTM (Shuttle Radar Topography Mission) 获得，其分辨率为 90m `\(\times\)` 90m，属于高精度地形网格数据，更多细节描述见 <http://srtm.csi.cgiar.org/>，下图<a href="#fig:raster-elevation">16</a>将公园的地形清晰地展示出来了，读者不妨再借助维基百科词条 (<https://en.wikipedia.org/wiki/Zion_National_Park>) 从整体上了解该公园的情况，结合丰富的实景图可以获得更加直观的感受。

<figure>
<img src="/img/maps-in-r/raster-elevation.png" class="full" alt="Figure 16: raster 包绘制锡安国家公园地形" /><figcaption aria-hidden="true">Figure 16: <strong>raster</strong> 包绘制锡安国家公园地形</figcaption>
</figure>

# 常见绘图包

## echarts4r

**echarts4r** ([Coene 2022](#ref-echarts4r)) 支持使用多种地图服务，包括 OSM（OpenStreetMap）、Mapbox 等

``` r
library(echarts4r)
# OSM
quakes |>
  e_charts(long) |>
  e_leaflet(center = c(175, -20), zoom = 4) |>
  e_leaflet_tile() |>
  e_scatter(lat, size = mag, coord_system = "leaflet")
```

<figure>
<img src="/img/maps-in-r/quakes-osm.png" class="full" alt="Figure 17: echarts4r 使用 OpenStreetMap 地图" /><figcaption aria-hidden="true">Figure 17: <strong>echarts4r</strong> 使用 OpenStreetMap 地图</figcaption>
</figure>

类似谷歌的要求，使用 Mapbox 地图服务也需要先申请个人访问令牌，申请下来后，也把它设置到 R 语言环境变量里 `MAPBOX_TOKEN`，以便后续使用。

``` r
# MAPBOX 地图
quakes |>
  e_charts(long) |>
  e_mapbox(
    # MAPBOX 的访问令牌
    token = Sys.getenv("MAPBOX_TOKEN"),
    style = "mapbox://styles/mapbox/dark-v9",
    # 视角：地图中心
    center = c(175, -20),
    # 缩放等级
    zoom = 4
  ) |>
  e_scatter_3d(lat, mag, coord_system = "mapbox") |>
  e_visual_map(mag)
```

<figure>
<img src="/img/maps-in-r/quakes-mapbox.png" class="full" alt="Figure 18: echarts4r 使用 MAPBOX 地图" /><figcaption aria-hidden="true">Figure 18: <strong>echarts4r</strong> 使用 MAPBOX 地图</figcaption>
</figure>

在国内，最好使用百度、高德这样的国家认可的地图服务提供商，这也很容易，只需用高德的 tile 服务数据替换 OSM 的。

``` r
# 高德地图
quakes |>
  e_charts(long) |>
  e_leaflet(center = c(175, -20), zoom = 4) |>
  e_leaflet_tile(
    template = "http://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
    options = list(tileSize = 256, minZoom = 3, maxZoom = 17)
  ) |>
  e_scatter(lat, size = mag, coord_system = "leaflet")
```

<figure>
<img src="/img/maps-in-r/quakes-amap.png" class="full" alt="Figure 19: echarts4r 使用高德地图" /><figcaption aria-hidden="true">Figure 19: <strong>echarts4r</strong> 使用高德地图</figcaption>
</figure>

百度、阿里、腾讯等公司都提供大量面向不同场景的地图服务，一些软件也内置了地图，如[tableau](https://www.tableau.com/products/desktop) 和[QGIS](https://www.qgis.org/)等，下图<a href="#fig:qgis">20</a> 展示 QGIS 软件使用在线的 OpenStreetMap 地图。

<figure>
<img src="/img/maps-in-r/qgis.png" class="full" alt="Figure 20: QGIS 软件内的 OpenStreetMap 地图" /><figcaption aria-hidden="true">Figure 20: QGIS 软件内的 OpenStreetMap 地图</figcaption>
</figure>

### 动画

``` r
gapminder |>
  group_by(year) |>
  e_charts(x = country, timeline = TRUE) |>
  e_map(serie = gdpPercap) |>
  e_visual_map(serie = gdpPercap) |>
  e_tooltip(
    # 数据项图形触发，用于散点图等，设置 'axis' 表示坐标轴触发，主要在柱状图/条形图
    trigger = "item",
    # 鼠标移动或点击时触发
    triggerOn = "mousemove|click",
    # 定制悬浮内容 params.name 取自 bind 变量
    formatter = htmlwidgets::JS("
      function(params){
        return('国家: <strong>' + params.name + '</strong>' +
               '<br />人均 GDP: ' + Math.round(params.value) + '美元')
      }
    ")
  )
```

### 3D 交互

[3D 地球数据可视化](https://github.com/z3tt/ports_globe/blob/main/echarts_globe.R)

## leaflet

**leaflet** ([Cheng, Karambelkar, and Xie 2021](#ref-leaflet)) 包

``` r
colorize_numeric <- function(x) {
  n <- 9 # 设置颜色梯度数目
  scales::col_numeric(palette = "viridis", domain = range(x))(x)
}
quakes <- transform(quakes, color = colorize_numeric(mag))
# 绘图
plot(data = quakes, lat ~ long, col = color, pch = 19)

# 注意因子水平个数
colorize_factor <- function(x) {
  scales::col_factor(palette = "Set2", levels = unique(x))(x)
}
# 给每个点设置一个颜色
iris <- transform(iris, color = colorize_factor(Species))
# 绘图
plot(data = iris, Petal.Length ~ Petal.Width, col = color, pch = 19)
```

[**colourvalues**](https://github.com/SymbolixAU/colourvalues) 包专门颜色转化工作。

``` r
library(leaflet)
data(quakes)
# Pop 提示
quakes$popup_text <- lapply(paste(
  "编号:", "<strong>", quakes$stations, "</strong>", "<br>",
  "震深:", quakes$depth, "<br>",
  "震级:", quakes$mag
), htmltools::HTML)
# 构造调色板
pal <- colorBin("Spectral", bins = pretty(quakes$mag), reverse = TRUE)

leaflet(quakes, options = leafletOptions(attributionControl = FALSE)) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addCircles(lng = ~long, lat = ~lat, color = ~ pal(mag), label = ~popup_text) |>
  addLegend("bottomright",
    pal = pal, values = ~mag,
    title = "地震震级"
  ) |>
  addScaleBar(position = c("bottomleft"))
```

<figure>
<img src="/img/maps-in-r/quakes-leaflet.png" class="full" alt="Figure 21: leaflet 包使用 OpenStreetMap 地图" /><figcaption aria-hidden="true">Figure 21: <strong>leaflet</strong> 包使用 OpenStreetMap 地图</figcaption>
</figure>

## plotly

**plotly** ([Sievert et al. 2021](#ref-plotly)) 包调用 Mapbox 地图服务做地理可视化

``` r
plotly::plot_mapbox(
  data = quakes, colors = "Spectral",
  lon = ~long, lat = ~lat, color = ~mag,
  type = "scattermapbox", mode = "markers",
  marker = list(size = 10, opacity = 0.5)
) |>
  plotly::layout(
    title = "斐济地震带",
    mapbox = list(
      # style = 'dark', # 暗黑主题
      zoom = 4, # 缩放级别
      center = list(lat = -20, lon = 175)
    )
  ) |>
  plotly::config(
    mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"),
    displayModeBar = FALSE
  )
```

<figure>
<img src="/img/maps-in-r/quakes-plotly.png" class="full" alt="Figure 22: plotly 包使用 Mapbox 地图" /><figcaption aria-hidden="true">Figure 22: <strong>plotly</strong> 包使用 Mapbox 地图</figcaption>
</figure>

布局设置以 `layout(mapbox = ...)` 内的 style 参数为例， 它是用来设置地图风格样式的，除了默认的参数值 `basic`，还可以设置为夜晚暗黑 `dark`，卫星地图 `satellite` 等，其他见[文档](https://plotly.com/r/reference/layout/mapbox/)。

<figure>
<img src="/img/maps-in-r/quakes-satellite.png" class="full" alt="Figure 23: plotly 包使用 Mapbox 卫星地图" /><figcaption aria-hidden="true">Figure 23: <strong>plotly</strong> 包使用 Mapbox 卫星地图</figcaption>
</figure>

### 动画

参考 plotly 官网 [choropleth map](https://plotly.com/python/choropleth-maps/)

``` python
import plotly.express as px
df = px.data.gapminder()
df.head(6)
```

           country continent  year  lifeExp       pop   gdpPercap iso_alpha  iso_num
    0  Afghanistan      Asia  1952   28.801   8425333  779.445314       AFG        4
    1  Afghanistan      Asia  1957   30.332   9240934  820.853030       AFG        4
    2  Afghanistan      Asia  1962   31.997  10267083  853.100710       AFG        4
    3  Afghanistan      Asia  1967   34.020  11537966  836.197138       AFG        4
    4  Afghanistan      Asia  1972   36.088  13079460  739.981106       AFG        4
    5  Afghanistan      Asia  1977   38.438  14880372  786.113360       AFG        4

相比于 R 语言 gapminder 数据集，添加了新的一列 `iso_alpha`

``` python
fig = px.choropleth(
    df,
    locations="iso_alpha",
    color="lifeExp"
    # 动画帧
    animation_frame="year",
    # 动画分组
    animation_group="country",
    # 悬浮提示
    hover_name="country", 
    color_continuous_scale=px.colors.sequential.Viridis,
)
fig.show()
```

# 空间数据结构

空间数据操作 Spatial Data Manipulation

空间区域的面积、空间点的路径、区域叠加、基于空间关系的数据查询等。

空间数据分析 Spatial Data Analysis
空间数据的描述性和探索性分析

空间统计分析 Spatial Statistical Analysis

传统的统计模型认为观测值之间常常是独立的，而空间数据自带空间相关性，需要专门的统计分析方法。

空间数据建模 Spatial Data Modeling

空间过程预测，空间分析：空间点模式分析 Spatial Point Pattern Analysis、格网/面状数据分析 Area Data/Grid Data/lattice Data、地统计分析 Geostatistics

描述空间相关性：莫兰指数 用于 面状数据，变差函数 用于 连续数据

[**rnaturalearth**](https://github.com/ropenscilabs/rnaturalearth) 和 [**rnaturalearthdata**](https://github.com/ropenscilabs/rnaturalearthdata) 提供 [美国国家地理](https://www.naturalearthdata.com/)网站的 R 语言接口，可以免费下载矢量和栅格地图数据。

``` r
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
```

下载和绘制中国地图数据，如图<a href="#fig:china-map">24</a>

``` r
sp::plot(rnaturalearth::ne_countries(
  country = "China",
  continent = "Asia",
  type = "countries",
  scale = 10, returnclass = "sp"
))
```

<figure>
<img src="/img/maps-in-r/china-map.png" class="full" alt="Figure 24: 美国国家地理网站提供的中国地图数据" /><figcaption aria-hidden="true">Figure 24: 美国国家地理网站提供的中国地图数据</figcaption>
</figure>

<div class="rmdnote">

**rnaturalearthhires** 有 20 多 M，不在 CRAN 上，安装命令如下：

``` r
install.packages(
  pkgs = "rnaturalearthhires",
  repos = "http://packages.ropensci.org",
  type = "source"
)
```

</div>

## 矢量数据 sp

**sp** ([Pebesma and Bivand 2021](#ref-sp)) 是一个 R 包，提供一种存储和操作空间数据的对象类型，具体地，提供点 SpatialPoints / SpatialMultiPoints、线 SpatialLines、多边形 SpatialPolygons、栅格 SpatialGrid / SpatialPixels 等基础空间数据类型以及相应构造方法，还有聚合 `aggregate()`，合并 `merge()`，转化 `spTransform()` 和绘图 `spplot()` / `bubble()` / `image()` 等空间数据操作和可视化函数。

``` r
library(sp)
```

meuse 数据集为例

``` r
data(meuse)
summary(meuse)
#        x                y             cadmium          copper     
#  Min.   :178605   Min.   :329714   Min.   : 0.20   Min.   : 14.0  
#  1st Qu.:179371   1st Qu.:330762   1st Qu.: 0.80   1st Qu.: 23.0  
#  Median :179991   Median :331633   Median : 2.10   Median : 31.0  
#  Mean   :180005   Mean   :331635   Mean   : 3.25   Mean   : 40.3  
#  3rd Qu.:180630   3rd Qu.:332463   3rd Qu.: 3.85   3rd Qu.: 49.5  
#  Max.   :181390   Max.   :333611   Max.   :18.10   Max.   :128.0  
#                                                                   
#       lead            zinc           elev            dist       
#  Min.   : 37.0   Min.   : 113   Min.   : 5.18   Min.   :0.0000  
#  1st Qu.: 72.5   1st Qu.: 198   1st Qu.: 7.55   1st Qu.:0.0757  
#  Median :123.0   Median : 326   Median : 8.18   Median :0.2118  
#  Mean   :153.4   Mean   : 470   Mean   : 8.16   Mean   :0.2400  
#  3rd Qu.:207.0   3rd Qu.: 674   3rd Qu.: 8.96   3rd Qu.:0.3641  
#  Max.   :654.0   Max.   :1839   Max.   :10.52   Max.   :0.8804  
#                                                                 
#        om        ffreq  soil   lime       landuse       dist.m    
#  Min.   : 1.00   1:84   1:97   0:111   W      :50   Min.   :  10  
#  1st Qu.: 5.30   2:48   2:46   1: 44   Ah     :39   1st Qu.:  80  
#  Median : 6.90   3:23   3:12           Am     :22   Median : 270  
#  Mean   : 7.48                         Fw     :10   Mean   : 290  
#  3rd Qu.: 9.00                         Ab     : 8   3rd Qu.: 450  
#  Max.   :17.00                         (Other):25   Max.   :1000  
#  NA's   :2                             NA's   : 1
```

Ruud van Rijn 和 Mathieu Rikken 最初收集了 Stein 村 Meuse 河洪泛区地表土壤重金属浓度数据，Edzer Pebesma 将数据整理打包后做成 **sp** 内置的数据集 meuse。除了几种重金属浓度，还包含土壤、周围环境相关的变量，共 155 个采样点，14 个观测变量，具体情况：

-   x 东西方向坐标，单位米，坐标参照系为 RDH（Rijksdriehoek） 荷兰地形。
-   y 南北方向坐标，单位米。
-   cadmium 表土**镉**浓度，每千克土壤中镉含量（按毫克计），因此，浓度单位为 ppm，若原始数据中镉浓度为 0，则漂移至 0.2，即最小的镉浓度的一半。
-   copper 表土**铜**浓度，单位 ppm。
-   lead 表土**铅**浓度，单位 ppm。
-   zinc 表土**锌**浓度，单位 ppm。
-   elev 以当地河床为水平面，相对高度，单位米。
-   dist 采样点至 Meuse 河的距离，距离归一化到 0-1 区间。
-   om 每100千克土壤中有机质的占比，百分数。
-   ffreq 洪水等级，1 表示两年一次，2 表示十年一次，3 表示 五十年一次。
-   soil 土壤类型，按照荷兰 1:50000 的土壤图划分，1 表示 Rd10A （钙质弱发育草甸土，轻质砂质粘土），2 表示 Rd90C/VII （非钙质弱发育草甸土，重砂质粘土至轻质粘土），3 表示 Bkd26/VII
    （红砖土、细砂质、粉质轻质粘土）。
-   landuse 土地利用类别：Aa 农业/未指定 = ，Ab = Agr/糖用甜菜，Ag = Agr/小谷物，Ah = Agr/??，Am = Agr/玉米，B = 树林，Bw = 牧场中的树木，DEN = ?? , Fh = 高果树，Fl = 矮果树； Fw = 牧场果树，Ga = 家庭花园，SPO = 运动场，STA = 马厩，Tv = ?? , W = 牧场。
-   dist.m 采样点到 Meuse 河的距离，单位以米计，数据来自实地调查。

最后，数据集 meuse 中的行名 `row.names` 表示原始的采样点的编号。

meuse 是 SpatialPointsDataFrame 类型

meuse 指定坐标系

``` r
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs")
class(meuse)
# [1] "SpatialPointsDataFrame"
# attr(,"package")
# [1] "sp"
```

将普通的数据框 data.frame 转化为空间点数据框 SpatialPointsDataFrame， sp 包不仅提供了数据类型的转化方法，而且对这种新的数据类型提供相应的绘图方法，使用方法和普通的 `plot()` 函数一样，这也是 S3 泛型函数的特色。

``` r
plot(meuse)
```

<figure>
<img src="/img/maps-in-r/sp-meuse.png" class="full" alt="Figure 25: sp 包绘图空间点数据" /><figcaption aria-hidden="true">Figure 25: <strong>sp</strong> 包绘图空间点数据</figcaption>
</figure>

``` r
data(meuse.grid)
coordinates(meuse.grid) = ~x+y
proj4string(meuse.grid) <- CRS("+init=epsg:28992")
gridded(meuse.grid) = TRUE
spplot(meuse.grid)
```

meuse.grid 是 SpatialPixelsDataFrame 类型

实际上，截止目前 `plot()` 函数已经汇集很多方法了，它已经是一个绘图对象，对于不同类型的数据对象，它会调用相应的绘图方法。记住，一切都是对象，一切的操作都是函数调用。

|                                            |                   |                             |               |
|:-------------------------------------------|:------------------|:----------------------------|:--------------|
| plot,ANY,ANY-method                        | plot.dendrogram   | plot.ppr                    | plot.shingle  |
| plot,color,ANY-method                      | plot.density      | plot.prcomp                 | plot.SOM      |
| plot,Spatial,missing-method                | plot.ecdf         | plot.princomp               | plot.somgrid  |
| plot,SpatialGrid,missing-method            | plot.factor       | plot.profile.nls            | plot.spec     |
| plot,SpatialGridDataFrame,missing-method   | plot.formula      | plot.R6                     | plot.stepfun  |
| plot,SpatialLines,missing-method           | plot.function     | plot.raster                 | plot.stft     |
| plot,SpatialMultiPoints,missing-method     | plot.ggplot       | plot.sf                     | plot.stl      |
| plot,SpatialPixels,missing-method          | plot.gtable       | plot.sfc_CIRCULARSTRING     | plot.svm      |
| plot,SpatialPixelsDataFrame,missing-method | plot.hcl_palettes | plot.sfc_GEOMETRY           | plot.table    |
| plot,SpatialPoints,missing-method          | plot.hclust       | plot.sfc_GEOMETRYCOLLECTION | plot.trans    |
| plot,SpatialPolygons,missing-method        | plot.histogram    | plot.sfc_LINESTRING         | plot.trellis  |
| plot.acf                                   | plot.HoltWinters  | plot.sfc_MULTILINESTRING    | plot.ts       |
| plot.bclust                                | plot.ica          | plot.sfc_MULTIPOINT         | plot.tskernel |
| plot.classIntervals                        | plot.isoreg       | plot.sfc_MULTIPOLYGON       | plot.TukeyHSD |
| plot.data.frame                            | plot.lm           | plot.sfc_POINT              | plot.tune     |
| plot.decomposed.ts                         | plot.medpolish    | plot.sfc_POLYGON            | plot.units    |
| plot.default                               | plot.mlm          | plot.sfg                    |               |

Table 2: plot 绘图方法

``` r
library(loa)
OpenStreetMapPlot(lead * 2 + zinc ~ latitude * longitude,
  col.regions = c("grey", "darkred"), 
  key.z.main="Concentrations", panel.zcases = TRUE,
  data = lat.lon.meuse, map = roadmap.meuse
)
```

## 栅格数据 raster

栅格数据是空间数据的另一种类型，比如遥感卫星拍摄的照片，**raster** ([Hijmans 2021](#ref-raster)) 可以处理这类数据的分析和可视化。

[layer](https://github.com/marcosci/layer) 层次性

笔者用 iPhone 12 Pro 拍摄的天空照片和银杏树照片，层次，通道，
TIFF 照片卫星拍摄的照片与此大致相仿，所使用的镜头不同而已。下面介绍一下如何处理这类图像数据。图像处理，检测 detection，分割 segmentation，识别 recognition，如何识别出来图片中是乌云还是银杏叶，乌云和银杏叶的轮廓，如何将一朵朵乌云分割开来，一片片银杏叶呢？

``` r
library(raster)
```

``` r
data(grain, package = 'spData')
raster::plot(grain, asp = NA)
```

<figure>
<img src="/img/maps-in-r/raster-grain.png" class="full" alt="Figure 26: raster 包绘制栅格数据" /><figcaption aria-hidden="true">Figure 26: <strong>raster</strong> 包绘制栅格数据</figcaption>
</figure>

<div class="rmdtip">

R 软件内置的调色板 `terrain.colors()` 专用于地形图配色，从翠绿色、土黄色、沙白色，无不暗示海拔变化，读者不妨想象一下，山上的树呈翠绿色，山腰的砂石土块呈土黄色，山脚的河床小路呈沙白色，十分符合我国南方的丘陵山地印象。

</div>

[**spData**](https://github.com/Nowosad/spData/)

**spData** 内的 wheat 数据集来自非常经典的空间统计书籍《Statistics for Spatial Data》([Cressie 1993](#ref-Cressie1993))。

sf 读取 shp 文件

``` r
library(sf)
wheat <- st_read(system.file("shapes/wheat.shp", package = "spData"))
# Reading layer `wheat' from data source 
#   `/Library/Frameworks/R.framework/Versions/4.1/Resources/library/spData/shapes/wheat.shp' 
#   using driver `ESRI Shapefile'
# Simple feature collection with 500 features and 8 fields
# Geometry type: POLYGON
# Dimension:     XY
# Bounding box:  xmin: 1.255 ymin: 1.35 xmax: 64 ymax: 67.35
# CRS:           NA
wheat
# Simple feature collection with 500 features and 8 fields
# Geometry type: POLYGON
# Dimension:     XY
# Bounding box:  xmin: 1.255 ymin: 1.35 xmax: 64 ymax: 67.35
# CRS:           NA
# First 10 features:
#    SP_ID SP_ID_1 lat yield    r     c   lon lat1
# 1      0      g1 3.3  3.63 65.7  2.51  2.51 65.7
# 2      1      g2 3.3  4.15 65.7  5.02  5.02 65.7
# 3      2      g3 3.3  4.06 65.7  7.53  7.53 65.7
# 4      3      g4 3.3  5.13 65.7 10.04 10.04 65.7
# 5      4      g5 3.3  3.04 65.7 12.55 12.55 65.7
# 6      5      g6 3.3  4.48 65.7 15.06 15.06 65.7
# 7      6      g7 3.3  4.75 65.7 17.57 17.57 65.7
# 8      7      g8 3.3  4.04 65.7 20.08 20.08 65.7
# 9      8      g9 3.3  4.14 65.7 22.59 22.59 65.7
# 10     9     g10 3.3  4.00 65.7  25.1 25.10 65.7
#                          geometry
# 1  POLYGON ((1.255 64.05, 1.25...
# 2  POLYGON ((3.765 64.05, 3.76...
# 3  POLYGON ((6.275 64.05, 6.27...
# 4  POLYGON ((8.785 64.05, 8.78...
# 5  POLYGON ((11.3 64.05, 11.3 ...
# 6  POLYGON ((13.8 64.05, 13.8 ...
# 7  POLYGON ((16.32 64.05, 16.3...
# 8  POLYGON ((18.82 64.05, 18.8...
# 9  POLYGON ((21.34 64.05, 21.3...
# 10 POLYGON ((23.85 64.05, 23.8...
```

``` r
plot(wheat["yield"])
```

<figure>
<img src="/img/maps-in-r/sf-wheat.png" class="full" alt="Figure 27: 小麦产量空间分布图" /><figcaption aria-hidden="true">Figure 27: 小麦产量空间分布图</figcaption>
</figure>

``` r
meuse.test <- raster(x = system.file("external/test.grd", package="raster"))
class(meuse.test)
# [1] "RasterLayer"
# attr(,"package")
# [1] "raster"
```

``` r
plot(meuse.test, legend = F)
```

## 矢量数据 sf

[Proj](https://proj.org/)

**sf** ([Pebesma 2021](#ref-sf)) 可以看作是继 sp 后的第二代空间数据处理和分析的框架，上一代的 maptools rgdal 和 rgeos 包退役。 历史遗留的部分陆续迁移至 sp 新的开发阵地已经迁移到 sf 上。哪些遗留的部分会迁移到 sp 而新的阵地又是什么？

``` r
library(sf)
```

``` r
data(alaska, package = 'spData')
alaska
# Simple feature collection with 1 feature and 6 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -2176000 ymin: 404900 xmax: 1493000 ymax: 2384000
# Projected CRS: NAD83(NSRS2007) / Alaska Albers
#   GEOID   NAME REGION           AREA total_pop_10 total_pop_15
# 1    02 Alaska   West 1718925 [km^2]       691189       733375
#                         geometry
# 1 MULTIPOLYGON (((-1730018 47...
```

数据集 alaska 使用的坐标参考系是 Alaska Albers (EPSG:3467)。各个变量分别是 GEOID 地理标识符（geographic identifiers），NAME 州的名称，REGION 区域的名称，AREA 面积（平方千米），total_pop_10 2010 年人口，total_pop_15 2015 年人口，geometry 表示 sf 多边形类的集合属性。

``` r
plot(alaska["total_pop_15"])
```

<figure>
<img src="/img/maps-in-r/sf-alaska.png" class="full" alt="Figure 28: sf 包绘制多边形数据" /><figcaption aria-hidden="true">Figure 28: <strong>sf</strong> 包绘制多边形数据</figcaption>
</figure>

``` r
data(world, package = 'spData')
world
# Simple feature collection with 177 features and 10 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -180 ymin: -89.9 xmax: 180 ymax: 83.65
# Geodetic CRS:  WGS 84
# # A tibble: 177 × 11
#    iso_a2 name_long   continent  region_un subregion  type   area_km2
#  * <chr>  <chr>       <chr>      <chr>     <chr>      <chr>     <dbl>
#  1 FJ     Fiji        Oceania    Oceania   Melanesia  Sover…   1.93e4
#  2 TZ     Tanzania    Africa     Africa    Eastern A… Sover…   9.33e5
#  3 EH     Western Sa… Africa     Africa    Northern … Indet…   9.63e4
#  4 CA     Canada      North Ame… Americas  Northern … Sover…   1.00e7
#  5 US     United Sta… North Ame… Americas  Northern … Count…   9.51e6
#  6 KZ     Kazakhstan  Asia       Asia      Central A… Sover…   2.73e6
#  7 UZ     Uzbekistan  Asia       Asia      Central A… Sover…   4.61e5
#  8 PG     Papua New … Oceania    Oceania   Melanesia  Sover…   4.65e5
#  9 ID     Indonesia   Asia       Asia      South-Eas… Sover…   1.82e6
# 10 AR     Argentina   South Ame… Americas  South Ame… Sover…   2.78e6
# # … with 167 more rows, and 4 more variables: pop <dbl>,
# #   lifeExp <dbl>, gdpPercap <dbl>, geom <MULTIPOLYGON [°]>
```

world 包含 177 个国家和地区的人口数据，area_km2 面积、pop 人口（2014 年）、lifeExp 人均寿命（2014 年）和 gdpPercap 人均 GDP （2014 年）。地理信息相关的数据有 iso_a2 国标 ISO 的国家编码，name_long 国家名字，continent 大洲名字，region_un 区域名称，subregion 子区域名称和 type 类型。数据收集自国家地理 [Natural Earth](https://www.naturalearthdata.com/) 和世界银行 [World Bank](https://data.worldbank.org/)，Jakub Nowosad 整理在 **spData** 包里。

[rnaturalearth](https://github.com/ropenscilabs/rnaturalearth)

``` r
plot(world["gdpPercap"])
```

<figure>
<img src="/img/maps-in-r/sf-world.png" class="full" alt="Figure 29: 2014 年世界各国人均 GDP" /><figcaption aria-hidden="true">Figure 29: 2014 年世界各国人均 GDP</figcaption>
</figure>

<div class="rmdnote">

**spData** 包内置的 world 数据集将台湾和中国大陆的地区用不同的颜色标记，严格来讲，这是不符合国家地图规范的，不能出现在期刊、书籍等正式的出版物里。

</div>

再看一个稍微复杂的例子，涉及数据读取、操作和绘图，数据集 SIDS (Sudden Infant Death Syndrome，简称 SIDS)来自 **sf** 包，更早些时候收集在 **sp** 包内，更多细节见 **sp** 包 [帮助文档](https://edzer.github.io/sp/)，描述美国北卡罗来纳州各个区县的婴儿猝死综合征 1974 年和 1979 年的情况。

``` r
# 读取数据，且读取后不要转化为 tibble 数据类型
nc <- read_sf(system.file("gpkg/nc.gpkg", package = "sf"), as_tibble = FALSE)
# 提取部分列
nc2 <- subset(x = nc, select = c("SID74", "SID79"))
# 查看数据
nc2
# Simple feature collection with 100 features and 2 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -84.32 ymin: 33.88 xmax: -75.46 ymax: 36.59
# Geodetic CRS:  NAD27
# First 10 features:
#    SID74 SID79                           geom
# 1      1     0 MULTIPOLYGON (((-81.47 36.2...
# 2      0     3 MULTIPOLYGON (((-81.24 36.3...
# 3      5     6 MULTIPOLYGON (((-80.46 36.2...
# 4      1     2 MULTIPOLYGON (((-76.01 36.3...
# 5      9     3 MULTIPOLYGON (((-77.22 36.2...
# 6      7     5 MULTIPOLYGON (((-76.75 36.2...
# 7      0     2 MULTIPOLYGON (((-76.01 36.3...
# 8      0     2 MULTIPOLYGON (((-76.56 36.3...
# 9      4     2 MULTIPOLYGON (((-78.31 36.2...
# 10     1     5 MULTIPOLYGON (((-80.03 36.2...
```

nc2 是一种宽格式数据，有两列 SID74 和 SID79，现在希望在地图上以 ggplot2 的分面绘图方式同时展示两个变量的空间分布，因此，需要先将数据由「宽格式」转为「长格式」。转化前，先来看下 nc2 的数据类型：

``` r
class(nc2)
# [1] "sf"         "data.frame"
```

它是一个非常复杂的数据类型，集合了 `sf` 和 `data.frame` 两种基本类型，在数据操作和绘图时，会根据类型的先后顺序依次查找和调用对应类型下的方法。

``` r
# 将 nc2 强制转化为简单的 data.frame 类型
nc2 <- as.data.frame(nc2)
# 对 nc2 做「宽格式」转「长格式」的变形操作
nc3 <- reshape(
  data = nc2,
  varying = c("SID74", "SID79"), # 需要转行的列，也可以用索引位置代替
  times = c("SID74", "SID79"),
  v.names = "SID", # 列转行 列值构成的新列，指定名称
  timevar = "VAR", # 列转行 列名构成的新列，指定名称
  idvar = "geom",
  new.row.names = 1:(2 * 100), # 2 列拉长，每列有 100 个值，长格式有 2*100 行
  direction = "long"
)
# 变形完成后，恢复原来的数据类型
nc3 <- st_as_sf(nc3, sf_column_name = "geom")
class(nc3)
# [1] "sf"         "data.frame"
```

**ggplot2** 提供的几何图层 `geom_sf()` 是专门为 sf 数据对象准备的，`facet_wrap()` 和 `facet_grid()` 都可以用来实现分面，布局样式稍有不同，更多绘图细节介绍见《ggplot2: Elegant Graphics for Data Analysis》([Wickham 2022](#ref-Wickham2022))
第三版的地图章节，如图 <a href="#fig:sf-nc">30</a>。在地图上绘制栅格图形，有个专业的制图术语 — Choropleth maps，翻译过来，大致叫填充地图、等值域图、瓦片图、围栏图、面量图、断层图等，可以非常直观地展示观测变量在地理区域内的变化情况。

``` r
library(ggplot2)
ggplot() +
  geom_sf(data = nc3, aes(fill = SID)) +
  facet_wrap(~VAR, ncol = 1)
# 或
# ggplot() +
#   geom_sf(data = nc3, aes(fill = SID)) +
#   facet_grid(rows = vars(VAR))
```

<figure>
<img src="/img/maps-in-r/sf-nc.png" class="full" alt="Figure 30: sf 数据可视化" /><figcaption aria-hidden="true">Figure 30: sf 数据可视化</figcaption>
</figure>

``` r
library(maptools)
nc <- readShapePoly(
  fn = system.file("shapes/sids.shp", package = "maptools"),
  proj4string = CRS("+proj=longlat +datum=NAD27")
)
```

<div class="rmdwarn">

**maptools** 包提供的 `readShapePoly` 函数去读取 shp 文件的方式已经过时，将在 2023 年底不可用，推荐使用 `rgdal::readOGR` 或者 `sf::st_read` 方式读取

</div>

**sp** 包提供的函数 `spplot()` 方法绘制类似的分面图，这其中借助了 **lattice** 包的绘图能力，效果如<a href="#fig:lattice-nc">31</a>所示。

``` r
spplot(nc, c("SID74", "SID79"),
  as.table = TRUE,
  scales = list(draw = T, 
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  sp.layout = list("SpatialPolygonsRescale",
    layout.north.arrow(2),
    offset = c(-76, 34), scale = 0.5, which = 2
  )
)
```

<figure>
<img src="/img/maps-in-r/lattice-nc.png" class="full" alt="Figure 31: lattice 数据可视化" /><figcaption aria-hidden="true">Figure 31: <strong>lattice</strong> 数据可视化</figcaption>
</figure>

**latticeExtra** 在 **lattice** 的基础上，封装了一些高级函数，围绕本篇主题，下面介绍一下 `mapplot()` 函数，读者不妨类比 `spplot()` 函数，可知它是专门为 map 数据类型提供绘图服务。 map 数据类型在 R 语言中存在很多年了，算得上是古老了，以前绘图的 R 包主要是基础地图 **maps**， 更多地图 **mapdata**， 地图投影 **mapproj** 和读写操作 **maptools**。

``` r
mapplot(x, data, map,
  outer = TRUE,
  prepanel = prepanel.mapplot,
  panel = panel.mapplot,
  aspect = "iso",
  legend = NULL,
  breaks, cuts = 30,
  colramp = colorRampPalette(hcl.colors(n = 11, palette = "Spectral")),
  colorkey = TRUE,
  ...
)

prepanel.mapplot(x, y, map, ...)
panel.mapplot(x, y, map,
  breaks, colramp,
  exact = FALSE, lwd = 0.5,
  ...
)
```

参数 `x` 提供符合 R 语言语法的公式，比如 `y ~ x1 + x2`。参数 `data` 提供数据集，包含观测变量。参数 `map` 提供地理边界信息，地理单元的名称必须和公式中变量 y 的值匹配。

``` r
# 加载 maps 包
library(maps)
# 将 sp 多边形类型 SpatialPolygons 转化为 map 类型
nc_map <- SpatialPolygons2map(nc)
# 调 map 函数绘制地图
map(database = nc_map)
```

事实上，**lattice** 在绘图能力上丝毫不逊色于 **ggplot2**，甚至还有超越，本篇主要介绍空间数据，下面以 R 软件内置的地形数据 volcano 为例。

<figure>
<img src="/img/maps-in-r/lattice-volcano-shade.png" class="full" alt="Figure 32: Auckland Maunga Whau 火山三维地形图 \(10m\times 10m\)" /><figcaption aria-hidden="true">Figure 32: <a href="https://en.wikipedia.org/wiki/Maungawhau_/_Mount_Eden">Auckland Maunga Whau 火山</a>三维地形图 <code>\(10m\times 10m\)</code></figcaption>
</figure>

仅是图 <a href="#fig:lattice-volcano-shade">32</a> 就已经让 **ggplot2** 自愧不如了，更别说实现图<a href="#fig:lattice-volcano-contour">33</a>这样的组合图形，此例摘自 [Deepayan Sarkar](https://deepayan.github.io/) 的书《**lattice**: Multivariate Data Visualization with R》([Sarkar 2008](#ref-Sarkar2008))。

<figure>
<img src="/img/maps-in-r/lattice-volcano-contour.png" class="full" alt="Figure 33: Auckland Maunga Whau 火山带等值线的三维地形图 \(10m\times 10m\)" /><figcaption aria-hidden="true">Figure 33: Auckland Maunga Whau 火山带等值线的三维地形图 <code>\(10m\times 10m\)</code></figcaption>
</figure>

# 环境信息

在 RStudio IDE 内编辑本文的 R Markdown 源文件，用 **blogdown** ([Xie, Hill, and Thomas 2017](#ref-Xie2017)) 构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 **knitr** 之后的 Markdown 文件，得益于 **blogdown** 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：

``` r
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "blogdown",
  "ggmap", "ggplot2", "sp", 
  "leaflet", "echarts4r", "layer",
  "baidumap", "RgoogleMaps",
  "lattice", "latticeExtra", "loa",
  "raster", "rasterVis", "sf", "plotly"
), dependencies = FALSE)
# R version 4.1.2 (2021-11-01)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS Big Sur 10.16
# 
# Locale: en_US.UTF-8 / en_US.UTF-8 / en_US.UTF-8 / C / en_US.UTF-8 / en_US.UTF-8
# 
# Package version:
#   baidumap_0.2.2      blogdown_1.7        echarts4r_0.4.3    
#   ggmap_3.0.0         ggplot2_3.3.5       knitr_1.37         
#   lattice_0.20-45     latticeExtra_0.6.29 layer_0.0.1        
#   leaflet_2.0.4.1     loa_0.2.47.1        plotly_4.10.0      
#   raster_3.5-11       rasterVis_0.51.1    RgoogleMaps_1.4.5.3
#   rmarkdown_2.11      sf_1.0-5            sp_1.4-6           
# 
# Pandoc version: 2.16.2
# 
# Hugo version: 0.91.2
```

# 参考文献

<div id="refs" class="references csl-bib-body hanging-indent">

<div id="ref-leaflet" class="csl-entry">

Cheng, Joe, Bhaskar Karambelkar, and Yihui Xie. 2021. *Leaflet: Create Interactive Web Maps with the JavaScript Leaflet Library*. <https://rstudio.github.io/leaflet/>.

</div>

<div id="ref-echarts4r" class="csl-entry">

Coene, John. 2022. *Echarts4r: Create Interactive Graphs with Echarts JavaScript Version 5*. <https://CRAN.R-project.org/package=echarts4r>.

</div>

<div id="ref-Cressie1993" class="csl-entry">

Cressie, Noel A. C. 1993. *Statistics for Spatial Data*. Revised. London: John Wiley; Sons Inc.

</div>

<div id="ref-raster" class="csl-entry">

Hijmans, Robert J. 2021. *Raster: Geographic Data Analysis and Modeling*. <https://rspatial.org/raster>.

</div>

<div id="ref-Kahle2013" class="csl-entry">

Kahle, David, and Hadley Wickham. 2013. “<span class="nocase">ggmap</span>: Spatial Visualization with <span class="nocase">ggplot2</span>.” *The R Journal* 5 (1): 144–61. <https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf>.

</div>

<div id="ref-Loecher2015" class="csl-entry">

Loecher, Markus, and Karl Ropkins. 2015. “RgoogleMaps and <span class="nocase">loa</span>: Unleashing R Graphics Power on Map Tiles.” *Journal of Statistical Software* 63 (4): 1–18. <http://www.jstatsoft.org/v63/i04/>.

</div>

<div id="ref-sf" class="csl-entry">

Pebesma, Edzer. 2021. *Sf: Simple Features for r*. <https://CRAN.R-project.org/package=sf>.

</div>

<div id="ref-sp" class="csl-entry">

Pebesma, Edzer, and Roger Bivand. 2021. *Sp: Classes and Methods for Spatial Data*. <https://CRAN.R-project.org/package=sp>.

</div>

<div id="ref-Sarkar2008" class="csl-entry">

Sarkar, Deepayan. 2008. *<span class="nocase">lattice</span>: Multivariate Data Visualization with R*. New York: Springer-Verlag. <http://lmdvr.r-forge.r-project.org>.

</div>

<div id="ref-plotly" class="csl-entry">

Sievert, Carson, Chris Parmer, Toby Hocking, Scott Chamberlain, Karthik Ram, Marianne Corvellec, and Pedro Despouy. 2021. *Plotly: Create Interactive Web Graphics via Plotly.js*. <https://CRAN.R-project.org/package=plotly>.

</div>

<div id="ref-Wickham2022" class="csl-entry">

Wickham, Hadley. 2022. *<span class="nocase">ggplot2</span>: Elegant Graphics for Data Analysis*. 3rd ed. Springer-Verlag New York. <https://ggplot2-book.org/>.

</div>

<div id="ref-Xie2017" class="csl-entry">

Xie, Yihui, Alison Presmanes Hill, and Amber Thomas. 2017. *<span class="nocase">blogdown</span>: Creating Websites with R Markdown*. Boca Raton, Florida: Chapman; Hall/CRC. <https://bookdown.org/yihui/blogdown/>.

</div>

</div>

[^1]: [ipinfo](https://github.com/ipinfo) 工具是开源可商用的，由前 Facebook 工程师 Ben Dowling 于 2013 年创建，后来发展成 IPinfo 公司，专门提供 IP 定位服务，服务的公司包括腾讯、戴尔、耐克等。
