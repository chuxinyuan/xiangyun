---
title: 空间数据分析与 R 语言
author: 黄湘云
date: '2022-04-20'
slug: spatial-data-analysis
categories:
  - 统计模型
tags:
  - 空间随机过程
  - 地统计学
  - 克里金插值
  - 数据可视化
  - 交互式图形
  - 轨迹分析
  - 房价分析
  - 深圳房价
  - 供需分析
  - sp
  - gstat
toc: true
draft: true
thumbnail: /img/logo/gdal.svg
link-citations: true
bibliography: 
  - refer.bib
  - packages.bib
description: "本文以四个真实数据为背景，介绍空间点数据、轨迹数据和区域数据的分析、建模和可视化。地统计学方法分析城市地表土壤重金属污染状况，空间点模式统计方法分析北京出租车轨迹，加权地理神经网络分析美国波士顿和中国深圳房价，时空统计方法分析近40年中日美区县级人口增长率。"
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#",
  error = FALSE,
  tidy = FALSE,
  cache = FALSE,
  collapse = TRUE
)
# 修改输出的显示行数
knitr::knit_hooks$set(output = local({
  # the default output hook
  hook_output <- knitr::knit_hooks$get("output")
  function(x, options) {
    if (!is.null(n <- options$out.lines)) { # out.lines
      x <- xfun::split_lines(x)
      if (length(x) > n) {
        # truncate the output
        x <- c(head(x, n), "....\n")
      }
      x <- paste(x, collapse = "\n") # paste first n lines together
    }
    hook_output(x, options)
  }
}))
# 控制输出的宽度
options(width = 89)
```

```{css, echo=FALSE}
.sidebar {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.sidebar, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.rmdinfo {
  border: 1px solid #ccc;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}
div.rmdinfo::before {
  content: "声明";
  color: block;
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

figure {
  text-align: center;
}

div.img {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}
```

::: rmdinfo
本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。
:::



# 概览

在地统计分析方面，比较流行的 R 包有 **gstat** [@Pebesma2004] 包，**geoR** 包， **geoRglm** 包[@geoRglm2002]和 **PrevMap** 包[@PrevMap2017]等，而点过程分析方面，**splance** 包和 **spatstat** 包[@Baddeley2005]。

空间和时空点模式分析《Statistical Analysis of Spatial and Spatio-Temporal Point Patterns》[@Diggle2013]

本文以 **sp** 包 [@Pebesma2005] 内置的 meuse 数据集为例介绍空间数据分析、建模的过程。主要使用的 R 包有 **sp** 包 和 **gstat** 包，继续围绕 sp 空间数据进行介绍，一方面 sp 的生态非常成熟，完全迁移到 **sf** 包 [@Pebesma2018] 为核心的生态尚需要时日；另一方面，笔者也在摸索学习过程中，以空间统计为重，以后可以再将本文的代码升级到 **sf** 为核心的生态。


本文主要的参考材料来自[**sp**](https://github.com/edzer/sp/)包 的[帮助文档](https://edzer.github.io/sp/) 和 [**gstat**](https://github.com/r-spatial/gstat/) 包的[帮助文档](https://edzer.github.io/sp/)，
以及三本参考书籍《Model-based Geostatistics》[@Diggle2007] 和《Applied spatial data analysis with R》[@Bivand2013]，
最后一本是《lattice: Multivariate Data Visualization with R》[@Sarkar2008]，供绘制图形时，充当查询手册。



# 软件准备


```{r}
library(ggplot2)   # https://github.com/tidyverse/ggplot2
library(gganimate) # 动态可视化
library(ggspatial) # 静态可视化
library(leaflet)   # 交互可视化
library(mapview)   # https://github.com/r-spatial/mapview
library(mapedit)   # https://github.com/r-spatial/mapedit
# 空间点数据处理、分析
library(sp)
library(sf)
library(gstat)
library(lattice)
library(mapsf)
# 栅格数据处理
library(raster)
library(rasterVis)
library(stars)
# 设置 WebGL 渲染
options(rgl.useNULL = TRUE)
options(rgl.printRglwidget = TRUE)
library(rgl)
```
  


<!-- 

新的微软电子表格套件 Excel 保存的文件都是 `*.xlsx` 格式，[**openxlsx**](https://github.com/ycphs/openxlsx)包专用于读写 XLSX 格式文件。

```{r,eval=FALSE,echo=FALSE}
library(openxlsx)
dat <- readWorkbook(
  xlsxFile = "static/data/cumcm2011A附件_数据.xls",
  sheet = 1, cols = 1:5,
  rows = 3:322,
  colNames = TRUE
)
```

brew install proj geos gdal

geos-config --version
projinfo EPSG:4326

Universal Transverse Mercator (UTM)
全球 60 个时区，每个时区横跨 6 经度

介绍 Proj  https://proj.org/
指定坐标系和时区 北半球
echo 12 56 | proj +proj=utm +zone=32
南半球
echo 174 -44 | proj +proj=utm +zone=59 +south

echo 12 56 | proj +proj=utm +zone=32 +ellps=GRS80
sf 包

EPSG:3857
echo 2 49 | proj +proj=webmerc +datum=WGS84 +ellps=GRS80


如果空间分析在不同投影下的结果不同，那么应该采用何种投影呢？可以考虑保角映射，原始的数据在投影下不至于膨胀或变形，尽管尺寸会缩小，共形变换保持了角度以及无穷小物体的形状。保角映射是复变函数中非常重要的概念，空间几何计算需要复变函数、微分几何、微分流形、微分拓扑等高等数学知识。


空间数据操作与 sf

数据导入导出：read_sf/write_sf
数据类型：点、线、多边形
数据操作：
- 数据类型转化 st_as_sf 
- 多边形求交/并/补 st_union 关联 st_join 
- 点操作：st_point
- 多边形操作：st_polygon
- 点和多边形关系：
  -  包含 st_contains 
  -  接触 st_touches 
  -  覆盖 st_covers
  -  过滤 st_filter
  -  等同 st_equals
  -  距离 st_distance
  -  缓冲区 st_buffer
- 坐标系统检索 st_crs 转化 st_transform
数据展示
- plot_sf

GEOS PROJ GDAL 和 sf 的关系

sf_extSoftVersion()

空间数据可视化与 leaflet
leaflet 依赖的上游 JS 库 Leaflet JS、Leaflet Provider 和插件、生态，它们和 leaflet 的关系

-->

# 数据结构


连续空间数据：地统计数据和空间点数据，离散空间数据：栅格数据

线下有需求，通过 App 表达需求，线上用户行为是结果，理解用户意图需要从线下出发。

栅格数据，连续和离散型变量


## 栅格数据 raster

关于栅格数据的介绍，还是以 raster 为主，因为读者肯定还会遇到大量以 raster 为主的分析代码，同时提供 terra 替代介绍，后者是升级替代，性能更好。raster 和 terra 在栅格数据的抽象表示上和 stars 是不同的。


栅格数据是空间数据的另一种类型，比如遥感卫星拍摄的照片，**raster** [@raster] 可以处理这类数据的分析和可视化。**raster** 包正在过渡到 **terra** 包，后者速度更快，接口函数是相似的。图\@ref(fig:layer)来自[layer](https://github.com/marcosci/layer) 包，栅格数据包含丰富的层次性。

![(\#fig:layer) 图片来自**layer** 包](/img/maps-in-r/layer.jpg){.full}



```{r raster-grain, eval=FALSE}
data(grain, package = "spData")
terra::plot(grain,
  asp = NA,
  col = hcl.colors(4, palette = "Plasma")
)
```

![(\#fig:raster-grain) **terra** 包绘制栅格数据](/img/maps-in-r/raster-grain.png){.full}


## 栅格数据 terra


[**spData**](https://github.com/Nowosad/spData/) 包内的 wheat 数据集来自非常经典的空间统计书籍《Statistics for Spatial Data》[@Cressie1993]。


```{r}
# sf 读取 shp 文件
library(sf)
wheat <- st_read(system.file("shapes/wheat.shp", package = "spData"))
wheat
```


```{r,eval=FALSE}
plot(wheat["yield"])
```

![(\#fig:sf-wheat) 小麦产量空间分布图](/img/maps-in-r/sf-wheat.png){.full}


## 栅格数据 stars


相比于 **terra**，**stars** 采用数组的概念，和 **sf** 的理念更加贴合一些，用多维数组表示时空数据，而不管空间数据是矢量还是栅格的。




```{r,eval=FALSE}
install.packages("starsdata",
  repos = "http://gis-bigdata.uni-muenster.de/pebesma",
  type = "source", lib = "~/Documents/R-packages"
)
```


# 栅格图形

## leaflet

下面采用高德地图的卫星影像数据做背景，定位地点矿大北京学10楼，往南即北京语言大学、成府路，往右是学院路，往北是清华东路。

```{r,eval=FALSE}
library(leaflet)
leaflet() |>
  addTiles(urlTemplate = paste(
    "https://webst01.is.autonavi.com",
    "appmaptile?style=6&x={x}&y={y}&z={z}",
    sep = "/"
  )) |>
  addMarkers(
    lng = 116.347817, lat = 39.997202,
    popup = "中国矿业大学（北京）学院路校区"
  )
```

![(\#fig:cumtb-satellite)中国矿业大学（北京）学院路校区卫星影像](/img/maps-in-r/cumtb-satellite.png){.full}


## ggplot2

iPhone 12 Pro 拍摄的照片默认采用 HEIC (High Efficiency Image Container) 格式保存，这是一张层次很丰富的乌云照片，原始尺寸为 $4032 \times 3024$，这里先用 [ImageMagick](https://imagemagick.org/) 将 HEIC 格式转化为 Tiff 格式，长宽尺寸均缩小为原来的十分之一，方便后续处理。

```bash
magick dark_cloud.HEIC -resize 10% dark_cloud.tif
```

```{r,eval=FALSE}
library(stars)
dark_cloud <- stars::read_stars("../../static/img/maps-in-r/dark-cloud.tif")
plot(dark_cloud)
# 调用 ggplot2 绘图
library(ggplot2)
ggplot() +
  geom_stars(data = dark_cloud) +
  facet_wrap(~band, ncol = 2) +
  coord_equal() +
  theme_void() +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_viridis_c()
```

![(\#fig:cloud-stars) **stars** 包读取 raster 数据](/img/maps-in-r/cloud-stars.png){.full}

颜色越深，乌云越厚，真正的 GeoTIFF 图片一般包含 RGB 三颜色和 alpha 通道，笔者用 iPhone 12 Pro 拍摄的天空照片，与之相似但是缺少了 alpha 通道。卫星拍摄的 TIFF 照片与此大致相仿，所使用的镜头不同而已。剩下的就是图像处理，这一块内容很多，如检测 detection，分割 segmentation，识别 recognition 等等，鉴于笔者对这一领域全然不了解，就不班门弄斧了。

# 案例：地表土壤重金属污染分析

## 数据描述

meuse 数据集中，x 和 y 坐标的参考系

- x Easting (m) in Rijksdriehoek (RDH) (Netherlands topographical) map coordinates
- y Northing (m) in RDH coordinates

meuse 数据集为例

```{r}
library(sp)
data("meuse")
summary(meuse)
```

Ruud van Rijn 和 Mathieu Rikken 最初收集了 Stein 村 Meuse 河洪泛区地表土壤重金属浓度数据，Edzer Pebesma 将数据整理打包后做成 **sp** 内置的数据集 meuse。除了几种重金属浓度，还包含土壤、周围环境相关的变量，共 155 个采样点，14 个观测变量，具体情况：

- x 东西方向坐标，单位米，坐标参照系为 RDH（Rijksdriehoek）荷兰地形。 
- y 南北方向坐标，单位米。
- cadmium 表土**镉**浓度，每千克土壤中镉含量（按毫克计），因此，浓度单位为 ppm，若原始数据中镉浓度为 0，则漂移至 0.2，即最小的镉浓度的一半。
- copper 表土**铜**浓度，单位 ppm。
- lead 表土**铅**浓度，单位 ppm。
- zinc 表土**锌**浓度，单位 ppm。
- elev 以当地河床为水平面，相对高度，单位米。
- dist 采样点至 Meuse 河的距离，距离归一化到 0-1 区间。
- om 每100千克土壤中有机质的占比，百分数。
- ffreq 洪水等级，1 表示两年一次，2 表示十年一次，3 表示 五十年一次。
- soil 土壤类型，按照荷兰 1:50000 的土壤图划分，1 表示 Rd10A （钙质弱发育草甸土，轻质砂质粘土），2 表示 Rd90C/VII （非钙质弱发育草甸土，重砂质粘土至轻质粘土），3 表示 Bkd26/VII
（红砖土、细砂质、粉质轻质粘土）。
- landuse 土地利用类别：Aa 农业/未指定 = ，Ab = Agr/糖用甜菜，Ag = Agr/小谷物，Ah = Agr/??，Am = Agr/玉米，B = 树林，Bw = 牧场中的树木，DEN = ?? , Fh = 高果树，Fl = 矮果树； Fw = 牧场果树，Ga = 家庭花园，SPO = 运动场，STA = 马厩，Tv = ?? , W = 牧场。
- dist.m 采样点到 Meuse 河的距离，单位以米计，数据来自实地调查。

最后，数据集 meuse 中的行名 `row.names` 表示原始的采样点的编号。



## 准备数据

meuse 指定坐标系，meuse 转化为 SpatialPointsDataFrame 类型

```{r}
crs <- CRS("+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs")
coordinates(meuse) <- ~ x + y
proj4string(meuse) <- crs
```


```{r}
class(meuse)
```


将普通的数据框 data.frame 转化为空间点数据框 SpatialPointsDataFrame， sp 包不仅提供了数据类型的转化方法，而且对这种新的数据类型提供相应的绘图方法，使用方法和普通的 `plot()` 函数一样，这也是 S3 泛型函数的特色。

```{r,eval=FALSE}
plot(meuse)
```

![(\#fig:sp-meuse) **sp** 包绘图空间点数据](/img/maps-in-r/sp-meuse.png){.full}

```{r}
data("meuse.grid")
coordinates(meuse.grid) <- ~ x + y
proj4string(meuse.grid) <- crs
class(meuse.grid)
```

meuse.grid 是 SpatialPointsDataFrame 类型

```{r,eval=FALSE}
plot(meuse.grid)
```


```{r}
# gridded 构造 Pixels
gridded(meuse.grid) <- TRUE
class(meuse.grid)
```

meuse.grid 是 SpatialPixelsDataFrame 类型

```{r,eval=FALSE}
plot(meuse.grid)
```


查看数据

```{r,eval=FALSE}
spplot(meuse.grid, "dist")
```



```{r}
data("meuse.riv")
meuse.riv <- SpatialPolygons(list(Polygons(list(Polygon(meuse.riv)), "meuse.riv")))
proj4string(meuse.riv) <- crs
```

meuse.riv 是 SpatialPolygons 类型，一条河流

```{r,eval=FALSE}
plot(meuse.riv)
```

```{r,eval=FALSE}
library(lattice)
library(loa)
OpenStreetMapPlot(lead * 2 + zinc ~ latitude * longitude,
  col.regions = c("grey", "darkred"), 
  key.z.main="Concentrations", panel.zcases = TRUE,
  data = lat.lon.meuse, map = roadmap.meuse
)
```

栅格数据

```{r,eval=FALSE}
meuse.test <- raster::raster(x = system.file("external/test.grd", package="raster"))
class(meuse.test)
terra::plot(meuse.test, legend = F)
```


## 模型计算

zinc 的浓度取对数，然后做普通克里金插值，

```{r,eval=FALSE}
library(gstat) # 实现克里金插值方法
# 公式形式 函数 variogram 要求 meuse 是 sp 类型
v.ok <- gstat::variogram(log(zinc) ~ 1, data = meuse)
# 变差模型为指数型
ok.model <- gstat::fit.variogram(v.ok, gstat::vgm(1, "Exp", 500, 1))
# 绘制
plot(v.ok, ok.model, main = "ordinary kriging")

zn.ok <- gstat::krige(log(zinc) ~ 1, meuse, meuse.grid,
  model = ok.model, debug.level = 0
)
```


## 模型结果

锌浓度（取对数）预测值及其预测误差的空间分布

```{r,eval=FALSE}
# 需要弄清楚各个参数的含义
rv <- list("sp.polygons", meuse.riv, fill = "blue", alpha = 0.1)
pts <- list("sp.points", meuse, pch = 3, col = "grey", alpha = .5)
text1 <- list("sp.text", c(180500, 329900), "0", cex = .5, which = 4)
text2 <- list("sp.text", c(181000, 329900), "500 m", cex = .5, which = 4)
scale <- list("SpatialPolygonsRescale", layout.scale.bar(),
  offset = c(180500, 329800), scale = 500,
  fill = c("transparent", "black"), which = 4
)
# 预测值
p1 <- spplot(zn.ok, c("var1.pred"),
  names.attr = c("ordinary kriging"),
  scales = list(
    draw = TRUE, # 坐标轴刻度
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  as.table = TRUE, main = "预测值的空间分布",
  sp.layout = list(rv, scale, text1, text2)
)
# 预测误差
p2 <- spplot(zn.ok, c("var1.var"),
  names.attr = c("ordinary kriging"),
  scales = list(
    draw = TRUE, # 坐标轴刻度
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  as.table = TRUE, main = "预测误差的空间分布",
  sp.layout = list(rv, scale, text1, text2)
)

print(p1, split = c(1, 1, 2, 1), more = TRUE)
print(p2, split = c(2, 1, 2, 1), more = FALSE)
```


# 案例：北京市出租车轨迹分析

Edzer Pebesma 将2008年2月4日[北京出租车轨迹数据](https://www.microsoft.com/en-us/research/publication/t-drive-trajectory-data-sample/)打包在**taxidata**包内。

```{r,eval=FALSE}
install.packages("taxidata",
  repos = "http://gis-bigdata.uni-muenster.de/pebesma",
  type = "source", lib = "~/Documents/R-packages"
)
```

[**trajectories**](https://github.com/edzer/trajectories) 包处理轨迹，提供的数据类型 Track 衍生自 **sp** 包的 Spatial 类型，下面先介绍基础的轨迹数据类型和轨迹数据概况。


## 准备工作


```{r}
library(trajectories)
methods(class = "Track")
library(sp)
methods(class = "Spatial")
```

**taxidata** 包就一个作用，打包北京出租车轨迹数据集

```{r,eval=FALSE}
library(taxidata) # taxidata 数据集
ls("package:taxidata")
```


```{r,eval=FALSE}
summary(taxidata) # Length Class Mode

# 5642 条轨迹
length(taxidata)

# 取其中一条轨迹
tmp <- taxidata[[1]]
proj4string(tmp)
class(tmp)

plot(tmp)

plot(taxidata[[2]])
```



![(\#fig:track) 北京某台出租车的出行轨迹](/img/track-data-analysis/track.png){.full}



# 案例：波士顿郊区房价分析

[Arya A. Pourzanjani](https://github.com/pourzanj)采用[贝叶斯神经网络分析方法](https://github.com/pourzanj/Bayesian_Neural_Networks) 预测房价。

[中国深圳房价估值模型](https://arxiv.org/abs/2202.04358)

<!-- 补充波士顿的地图  leaflet  usmap -->

本节分析 R 包 **MASS** 内置的波士顿郊区房价数据集 *Boston*，一共**506**条记录和**14**个特征变量，由 Boston Standard Metropolitan Statistical Area (SMSA) 在 **1970** 年收集，在做分析之前，首先要对每个特征变量的含义有充分的理解。

crim
: 城镇人均犯罪率 per capita crime rate by town

zn
: 占地面积超过25,000平方尺的住宅用地比例 proportion of residential land zoned for lots over 25,000 sq.ft.

indus
: 每个城镇非零售业务的比例 proportion of non-retail business acres per town.

chas
: 查尔斯河 Charles River dummy variable (= 1 if tract bounds river; 0 otherwise).

nox
: 氮氧化物浓度 nitrogen oxides concentration (parts per 10 million).

rm
: 每栋住宅的平均房间数量 average number of rooms per dwelling. 
容积率

age
: 1940年以前建造的自住单位比例 proportion of owner-occupied units built prior to 1940.
房龄

dis
: 到波士顿五个就业中心的加权平均值 weighted mean of distances to five Boston employment centres.
商圈

rad
: 径向高速公路可达性指数 index of accessibility to radial highways.
交通

tax
: 每10,000美元的全额物业税率 full-value property-tax rate per $10,000.
物业

ptratio
: 城镇的师生比例 pupil-teacher ratio by town.
教育

black
: 城镇黑人比例 `$1000(Bk - 0.63)^2$` where Bk is the proportion of blacks by town.
安全

lstat
: 较低的人口状况（百分比）lower status of the population (percent).

medv
: 自住房屋的中位数为1000美元 median value of owner-occupied homes in $1000s. 房价，这是响应变量


```{r out.lines=6}
data("Boston", package = "MASS")
Boston
```


# 案例：中日美人口增长率分析

改革开放40年为背景，尽量获取近40年区县级几个宏观指标，分别是人口增长率，失业率，城镇化率和固定资产投资增速/占比。

## 数据获取

数据说明

- 中国国家、省、市、县统计年鉴数据
- 日本
- 美国人口普查数据
[Analyzing US Census Data: Methods, Maps, and Models in R](https://walker-data.com/census-r/mapping-census-data-with-r.html)

[tigris](https://github.com/walkerke/tigris)
[tidycensus](https://github.com/walkerke/tidycensus)


## 静态可视化

ggplot2

## 动态可视化

ggplot2 和 gganimate 配合动态可视化


## 交互式动态可视化


Python 版 plotly 绘制 choropleth map 交互式动态可视化。


## 沉浸式探索性分析


shiny 沉浸式探索性分析



# 环境信息

在 RStudio IDE 内编辑本文的 R Markdown 源文件，用 **blogdown** [@Xie2017] 构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 **knitr** 之后的 Markdown 文件，得益于 **blogdown** 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：

```{r}
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "blogdown",
  "sp", "gstat", "lattice"
), dependencies = FALSE)
```


# 参考文献
