---
title: 空间数据可视化与 R 语言（上篇）
author: 黄湘云
date: '2022-05-25'
slug: maps-in-r
categories:
  - 统计图形
tags:
  - 地理可视化
  - ggplot2
  - ggmap
  - echarts4r
  - plotly
  - maps
  - leaflet
  - leafletCN
  - baidumap
  - RgoogleMaps
  - choroplethr
  - lattice
  - sf
  - terra
  - sp
  - raster
toc: true
draft: true
link-citations: true
bibliography: 
  - refer.bib
  - packages.bib
description: "介绍用于地理可视化的几种常用数据结构，比如 **sp** 包、**sf** 包和 **raster** 包提供的三种空间数据存储、操作的类和方法。
介绍地理可视化常用的展示形式，如瓦片图、围栏图、气泡图等，以及绘制过程中需要注意的制图规范问题，地理信息是比较敏感的数据，从大的层面上来说，涉及国家主权和领土完整。笔者合著的书籍《现代统计图形》曾因此将所有地图相关的介绍全部摘除，本文也意图去梳理和填补这方面的坑点。"
---


```{r setup, echo=FALSE}
# library(data.table)
knitr::opts_chunk$set(
  comment = "#",
    error = FALSE,
     tidy = FALSE,
    cache = FALSE,
 collapse = TRUE
)
# 修改输出的显示行数
knitr::knit_hooks$set(output = local({
  # the default output hook
  hook_output = knitr::knit_hooks$get('output')
  function(x, options) {
    if (!is.null(n <- options$out.lines)) { # out.lines
      x = xfun::split_lines(x)
      if (length(x) > n) {
        # truncate the output
        x = c(head(x, n), '....\n')
      }
      x = paste(x, collapse = '\n') # paste first n lines together
    }
    hook_output(x, options)
  }
}))
# 控制输出的宽度
options(width = 69)
```

```{css, echo=FALSE}
.sidebar {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.sidebar, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.rmdinfo {
  border: 1px solid #ccc;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}
div.rmdinfo::before {
  content: "声明";
  color: block;
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

figure {
  text-align: center;
}

div.img {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}
```

::: rmdinfo
本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。
:::


# 概览

介绍用于地理可视化的几种常用数据结构，比如 **sp** 包、**raster** 包、**sf** 包和 **terra** 包 提供的三种空间数据存储、操作的类和方法。
介绍地理可视化常用的展示形式，如瓦片图、围栏图、气泡图等，以及绘制过程中需要注意的制图规范问题，地理信息是比较敏感的数据，从大的层面上来说，涉及国家主权和领土完整。


Python 语言社区关于空间数据操作的流行模块有[shapely](https://github.com/shapely/shapely)和[geopandas](https://github.com/geopandas/geopandas)，后者还包含基于[matplotlib](https://github.com/matplotlib/matplotlib)的地理可视化，而做空间数据可视化的有[bokeh](https://github.com/bokeh/bokeh)、[pyecharts](https://github.com/pyecharts/pyecharts)和[plotly](https://github.com/plotly/plotly.py)等。[basemap](https://github.com/matplotlib/basemap) 基于 matplotlib 提供地图坐标映射，作用类似 R 包 **mapproj**。[geoplot](https://github.com/ResidentMario/geoplot) 提供高级易用的使用接口，扩展 [cartopy](https://github.com/SciTools/cartopy) 和 matplotlib 在地理可视化方面的能力。[rasterio](https://github.com/rasterio/rasterio) 读写栅格数据，以及[地理资源列表](https://github.com/sacridini/Awesome-Geospatial)。



# 地图服务

比较常见的地图服务，国外有谷歌、微软，国内有百度、高德，凡是提供本地生活服务的公司都或多或少地依赖高精地图，如美团外卖，阿里飞猪等。本文主要带领读者了解地图服务，以及使用 R 语言来做地理可视化，为增加代入感，笔者就以「中国矿业大学（北京）学院路校区」这个地标的 IP 定位开始。首先用 [curl](https://curl.se/) 工具请求网站 <https://ipinfo.io/>[^ipinfo]，它会自动获取用户上网使用的 IP 以及 IP 所处的地理位置，如下：

```bash
curl ipinfo.io
```
```
{
  "ip": "223.71.83.98",
  "city": "Beijing",
  "region": "Beijing",
  "country": "CN",
  "loc": "39.9288,116.3890",
  "org": "AS56048 China Mobile Communicaitons Corporation"
}
```

可知学校所处位置：纬度 39.9288 经度 116.3890，当然这离高精地图还有十万八千里，也正因定位的粗糙性，笔者才敢把它放在博客里，毕竟高精地理信息是涉及国家安全的内容。另外，值得注意的是对同一目标不同公司提供的定位可能是不同的，因为所选的地理参考系不同，常用的三种坐标系见文档[坐标系](https://lbsyun.baidu.com/index.php?title=coordinate)。大家熟知的GPS全球卫星定位系统采用 WGS84，而 GCJ02 由WGS84加密后的坐标系，是由中国国家测绘局制定的地理坐标系统，又称火星坐标系。BD09为百度坐标系，在GCJ02坐标系基础上再次加密。注意，加密过程不可逆，是一种非线性加密方式，反向解密后的坐标在部分区域的定位差别很大。

[^ipinfo]: [ipinfo](https://github.com/ipinfo) 工具是开源可商用的，由前 Facebook 工程师 Ben Dowling 于 2013 年创建，后来发展成 IPinfo 公司，专门提供 IP 定位服务，服务的公司包括腾讯、戴尔、耐克等。

## 谷歌地图


David Kahle 开发的[**ggmap**](https://github.com/dkahle/ggmap) [@Kahle2013] 包在 2011 年发布在 CRAN 上，是一个基于 ggplot2 的空间可视化包，背景地图来自谷歌地图。目前，由于 Google 地图服务策略调整，需要申请 Google 地图服务的访问令牌才可以使用地图服务。
可将申请到的 `GGMAP_GOOGLE_API_KEY` 保存到本地文件 `~/.Renviron`，以供 **ggmap** 后续使用。


Google 提供的是一种瓦片地图，即由一张张小图片拼凑起来形成一张完整的地图，就好像盖房用的瓦片。精度由瓦片的分辨率决定，且是栅格 raster 地图，而非矢量地图，如图 \@ref(fig:ggmap-tile) 所示。

![(\#fig:ggmap-tile) ggmap 地形图](http://tile.stamen.com/terrain-background/5/4/10.png){.full}

ggmap 可以调用多种样式的地图，地形图、水彩图等，如图\@ref(fig:ggmap-tiles) 所示。

```{r,eval=FALSE,echo=FALSE}
library(ggplot2)
library(ggmap)
library(patchwork)

us <- c(left = -125, bottom = 25.75, right = -67, top = 49)
# 从 tile server 服务器上下载 Stamen Maps 数据，组成一个图片
dat1 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "toner-lite"
  )
p1 <- ggmap(dat1)
# 地形图
dat2 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "terrain"
)
p2 <- ggmap(dat2)

dat3 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "watercolor"
)
p3 <- ggmap(dat3)

dat4 <- get_stamenmap(
  bbox = us, zoom = 5, maptype = "terrain-background"
)
p4 <- ggmap(dat4)

p1 / p2 | p3 / p4
```

![(\#fig:ggmap-tiles) ggmap 几种常用背景地图](/img/maps-in-r/ggmap-tiles.png){.full}

## 必应地图

与 **ggmap** 相比，[**RgoogleMaps**](https://github.com/markusloecher/rgooglemaps) [@Loecher2015] 支持更多的地图服务，除了 Google 地图外，还支持必应地图，以及基于 lattice 的可视化，借助 [**loa**](https://r-forge.r-project.org/scm/?group_id=1400) 和 [**latticeExtra**](https://r-forge.r-project.org/projects/latticeextra/) 还可以支持高级的自定义，如何使用见[ggmap 使用案例](https://github.com/vertica/Vertica-Geospatial) 
、[loa 文档](https://loa.r-forge.r-project.org/loa.intro.html)和[latticeExtra 文档](https://latticeextra.r-forge.r-project.org/)。


```{r,eval=FALSE}
library(RgoogleMaps) # 同时需要 RCurl
library(RCurl)
```

使用 Bing 地图服务也是需要 `API_KEY` 的，可先去 [Bing 地图开发中心](https://www.bingmapsportal.com/) 用 Outlook 邮箱创建账户，然后申请免费的基础版，过程见[说明](https://www.microsoft.com/en-us/maps/create-a-bing-maps-key)。

```{r,eval=FALSE}
map_cumtb <- GetBingMap(
  center = c(lat = 40.0, lon = 116.4), zoom = 12, 
  apiKey = Sys.getenv("BingMap_API_KEY"), verbose = 0, 
  destfile = "CUMTB.png"
)
PlotOnStaticMap(map_cumtb)
```

如图 \@ref(fig:bing-cumtb) 所示，坐标（40.0, 116.4）定位在中国矿业大学（北京）学院路校区。

![(\#fig:bing-cumtb) 微软必应地图](/img/maps-in-r/bing-cumtb.png){.full}










## 百度地图


杜亚磊开发的[baidumap](https://github.com/badbye/baidumap)包可以调用百度地图服务 <https://map.baidu.com/> 提供地理可视化的背景地图。百度是国内比较早的互联网公司，之前介绍的 Apache Echarts 最早也是百度可视化团队开发的，百度地理信息可视化平台使用的地理可视化组件来自开源的[mapv](https://github.com/huiyan-fe/mapv)。

在百度地图上，根据地理名称获得经纬度信息，获得经纬度后，可以将位置标记在地图上，下面以「中国矿业大学（北京）」为例

```{r,eval=FALSE}
remotes::install_github('badbye/baidumap')
```

`BaiduMap_API_Key` 是从[百度 LBS 云服务](https://lbsyun.baidu.com/)申请到的地图 API 访问令牌，保存到本地 `.Renviron` 文件里 `BaiduMap_API_Key=[key]`，这样启动 R 软件时就会自动载入。

```{r}
library(baidumap)
options(baidumap.key = Sys.getenv("BaiduMap_API_Key"))
getCoordinate('中国矿业大学（北京）学院路校区', formatted = T)
```


```{r,eval=FALSE}
library(ggplot2)
cumtb_map <- getBaiduMap("中国矿业大学（北京）学院路校区", zoom = 12)
cumtb_coordinate <- getCoordinate("中国矿业大学（北京）学院路校区", formatted = T)
cumtb_coordinate <- data.frame(t(cumtb_coordinate))
# 调 ggmap 绘制背景地图
ggmap::ggmap(cumtb_map) +
  geom_point(aes(x = longtitude, y = latitude),
    data = cumtb_coordinate, col = "red", size = 5
  )
```

![(\#fig:baidumap-cumtb) 百度地图-中国矿业大学（北京）](/img/maps-in-r/baidumap-cumtb.png){.full}



## 开放地图

OpenStreetMap 虽是开放数据，来自世界各地的贡献者，不提供免费的地图 API，使用此地图服务，不会将自己的数据上传至 OpenStreetMap 的服务器上。而 Leaflet 是开源的交互式地理可视化 JS 库。

![(\#fig:leaflet) 开源交互式 JavaScript 库 Leaflet](/img/leaflet.svg){.full}

Joe Cheng 开发维护的 [leaflet](https://github.com/rstudio/leaflet) 包是 JavaScript 库 [Leaflet](https://github.com/Leaflet/Leaflet) 的 R 语言接口。



在 leaflet 地图上实际经纬度为 `c(116.34394, 39.99665)`

```{r,eval=FALSE}
library(magrittr)
library(leaflet)
cumtb_map1 = leaflet() %>% 
  setView(lng = 116.34394, lat = 39.99665, zoom = 17) %>%
  addTiles() %>% 
  addPopups(116.34394, 39.99665, '这里是 <b>学院路校区</b>, 中国矿业大学（北京）')
cumtb_map1
```

![(\#fig:leaflet-cumtb) OpenStreetMap 地图-中国矿业大学（北京）](/img/maps-in-r/leaflet-cumtb.png){.full}


不难看出，百度地图和 leaflet 地图的坐标系不是同一个，获取的经纬度不同，这里将矿大（北京）定位到农大了

```{r,eval=FALSE}
cumtb_map2 = leaflet() %>% 
  setView(lng = 116.35688, lat = 40.00314, zoom = 17) %>%
  addTiles() %>% 
  addPopups(116.35688, 40.00314, '这里是 <b>学院路校区</b>, 中国矿业大学（北京）')
cumtb_map2
```

注意：GeoIP 只能给定一个粗略的经纬度信息，根据IP解析出来的经纬度 `c(116,39.9)` ，相比百度地图API根据地理名称获取的经纬度`c(116.35688,40.00314 )`就更加模糊了


## 高德地图

<!-- 
补充此测绘资质意味着什么？
-->

高德和百度都是有甲级测绘资质的单位

```{r,eval=FALSE}
library(leaflet)
library(leafletCN)

leaflet(options = leafletOptions(
  minZoom = 4, maxZoom = 18,
  zoomControl = FALSE
)) %>%
  amap() %>%
  addCircles(
    data = data.frame(lon = 116.35688, lat = 40.00314, size = 50),
    lng = ~lon, lat = ~lat, radius = ~size, color = "red",
    fillOpacity = 0.55, stroke = T, weight = 1,
    label = htmltools::HTML("这里是 <b>学院路校区</b>, 中国矿业大学（北京）")
  )
```


高德地图采用的是火星坐标系和 leaflet 采用的 GPS 坐标系不同，导致矿大定位到了农大，如图\@ref(fig:leaflet-amap-cumtb)

![(\#fig:leaflet-amap-cumtb)高德地图-中国矿业大学（北京）](/img/maps-in-r/leaflet-amap-cumtb.png){.full}

# 基础知识

## 网址定位

<!-- 
为什么网址 IP 网络协议 address 可以定位 GeoIP
如何使用？R 包如何使用它们？
-->

Os Keyes 开发的 R 包 [**rgeolocate**](https://github.com/ironholds/rgeolocate) [@rgeolocate] 可以解析 IP 地址，根据 IP 地址数据库提取位置信息，其内置 `GeoLite2-Country.mmdb` 数据支持定位到国家，是一个 [MaxMind](https://github.com/maxmind) 的 GeoIP2 数据库文件。

```{r}
library(rgeolocate)
# IP 地址 111.203.130.69 在中国矿业大学（北京）校区内。
maxmind(
  ips = "111.203.130.69",
  file = system.file("extdata", "GeoLite2-Country.mmdb", package = "rgeolocate"),
  fields = c(
    "continent_name", "country_code", "country_name",
    "region_name", "city_name", "city_geoname_id",
    "timezone", "longitude", "latitude"
  )
)
```

依次是洲、国家编码简称、国家名称、区域（省级）名称、城市名称、城市代码（不确定编码体系，此外国家行政区划编码）、时区、经度和纬度。内置的数据库定位精度有限，可以去[MaxMind 官网](https://dev.maxmind.com/geoip/geolite2-free-geolocation-data)下载免费的可以定位到城市的数据库。**rgeolocate** 包还提供连接其它 IP 定位服务的接口，比如前面提及的 <https://ipinfo.io/>。

```{r}
ip_info('111.203.130.69')
```

依次将城市、省份、国家、经纬度、网络服务提供商和时区都提供了。


## 地理编码

地球上每一块区域都对应有一个唯一的 GeoHash 值，比起区、县、乡、镇行政单元，它是用来刻画规则的更小的网格单元，广泛用于本地生活服务场景，比如外卖、打车、配送等。

[geohashTools](https://github.com/MichaelChirico/geohashTools) 包[@geohashTools]可以非常高效地将 GeoHash 编码的地理区域转为经纬度坐标。

```{r,eval=FALSE}
# 随意造几个位置
geohash_df <- data.frame(geohash = c(
  "wmd0k2ktr", "wmd0k2kv3", "wmd0k2kv7",
  "wmd0k2kvq", "wmd0k2mj0", "wmd0k2mj4"
))
# 转码为经纬度
dat <- geohashTools::gh_decode(geohashes = geohash_df$geohash)
dat2 <- data.frame(latitude = dat$latitude, longitude = dat$longitude)
# 将位置绘制在地图上
leaflet::leaflet(data = dat2) |> 
  leafletCN::amap() |> 
  leaflet::addCircles(lng = ~longitude, lat = ~latitude, radius = 3)
```

![(\#fig:sf-geohash) GeoHash 地理区域编码](/img/maps-in-r/sf-geohash.png){.full}


**lwgeom** 包[@lwgeom]提供函数 `st_geohash()` 可将经纬度坐标转为 GeoHash 码。

```{r}
library(sf)
library(lwgeom)
st_geohash(st_sfc(st_point(c(116.35688, 40.00314)), st_point(c(0, 90))), 9)
```


## 坐标系统

地球既不是圆球的也不是标准的椭球，将三维的球面投影到二维的平面有不同的方法，每一种方法都对应一种坐标转化，选定坐标原点后即构成坐标参考系统（Coordinate Reference System，简称 CRS）。**maps** 包内置了一份世界地图数据，下面以此为例介绍，本节空间数据的操作都用 **sf** 包来完成。


```{r}
library(sf)
library(maps)
# st_as_sf 将 map 类转化为 sf 类
world1 <- st_as_sf(map("world", plot = FALSE, fill = TRUE))
## 检索坐标参考系统
st_crs(world1)
## world 数据集采用 WGS 84 坐标系
st_crs("EPSG:4326")
```

**sf** 包提供 `st_as_sf()` 函数将 map 类转化为 sf 类，`st_crs()` 函数检索地图数据中附带的坐标参考系信息。接下来，用 `st_transform()` 函数转化坐标，参数 `crs` 指定新的坐标系统，示例里 `+proj=laea` 表示目标映射关系 Lambert Azimuthal Equal Area，而 `+ellps=WGS84` 即 [WGS 1984](https://en.wikipedia.org/wiki/World_Geodetic_System) 或称 [EPSG:4326](https://en.wikipedia.org/wiki/EPSG_Geodetic_Parameter_Dataset)，坐标系 WGS84 被全球定位系统采用，也简称 GPS 坐标系。`+lon_0=155` 和 `+lat_0=-90` 分别是经纬度，东经 155 度，南纬 90 度，也就是观测视角到南极去了。


```{r}
# 坐标转化
world2 <- st_transform(
  x = world1,
  crs = "+proj=laea +y_0=0 +lon_0=155 +lat_0=-90 +ellps=WGS84 +no_defs"
)
## 检索坐标参考系统
st_crs(world2)
## WGS 84 / Pseudo-Mercator 墨卡托投影
st_crs("EPSG:3857")
```

下面将两个不同坐标系统下的世界地图绘制出来，如图 \@ref(fig:sf-crs) 所示。

```{r,eval=FALSE}
library(ggplot2)
library(patchwork)
p1 <- ggplot() +
  geom_sf(data = world1)

p2 <- ggplot() +
  geom_sf(data = world2)

p1 + p2
```

![(\#fig:sf-crs)坐标系统](/img/maps-in-r/sf-crs.png){.full}


# 空间数据

地理可视化的展示形式有气泡图、热力图、瓦片图、地形图等，下面陆续使用 **lattice** 、**ggplot2** 和 **leaflet** 来绘制静态和交互图形。

[choroplethr](https://github.com/trulia/choroplethr) 和[choroplethrMaps](https://github.com/trulia/choroplethrMaps) 主要用来制作地区分布图，需要的区域数据，**choroplethrMaps** 包提供三份地图数据，分别是美国州、县地图和世界地图， 相关介绍材料见[这里](https://arilamstein.com/open-source/)。[tmap](https://github.com/r-tmap/tmap) 制作交互地图，[mapsf](https://github.com/riatelab/mapsf) 制作符号地图、等值地图、拓扑地图，关于各类地图的可视化示例见[AntV 官网](https://antv.vision/zh)。[mapsapi](https://github.com/michaeldorman/mapsapi) 可以连接 4 种 Google 提供的 Web 地图服务。

## 示例：美国旧金山犯罪数据

下面以 **RgoogleMaps** 包内置的空间数据集 incidents 为例介绍

```{r}
library(RgoogleMaps)
# 加载 incidents 
data(incidents)
# 查看数据
head(incidents)
```

数据集 incidents 来自 2012 年旧金山的犯罪数据，更多数据见 [DataSF 项目](https://datasf.org/opendata/)，一些数据分析见 Github [项目](https://github.com/datasf)。数据集 incidents 随机抽取了 5000 行，16个观测变量，分别是犯罪数目 `IncidntNum`、犯罪类型 `Category`、犯罪行为描述 `Descript`、犯罪行为发生在周几 `DayOfWeek`、犯罪行为发生的日期 `Date`、犯罪行为发生的时间（hh::mm）`Time`、警局辖区 `PdDistrict`、警方处置方式 `Resolution`、位置 `Location`、经度 `lon`、纬度 `lat`、是否属于暴力行为 `violent`、发生时间（小时，以2位整数计） `HrOfDay`、发生时间（小时，以10进制计）`TimeOfDay`、发生时间（一周168个小时，0-168之间的数字）`HourOfWeek`、人口普查的区块标记 `censusBlock`。图\@ref(fig:incidents-map)展示警方出警地点，或者说犯罪行为发生地点，红点表示此处发生暴力冲突，黑点表示此处没有暴力冲突。


```{r,eval=FALSE}
plotmap(
  lat = lat, lon = lon, data = incidents, 
  col = 'violent', zoom = 12,
  pch = 20, cex = 0.5, API = "google",
  apiKey = Sys.getenv("GGMAP_GOOGLE_API_KEY")
)
```


![(\#fig:incidents-map) 2012 年旧金山警方出警地点的空间分布](/img/maps-in-r/incidents-map.png){.full}

除了 **RgoogleMaps** 提供的 `plotmap()` 函数，当然，还可以用 **leaflet** 来绘制交互式的散点图，因为交互，可以放入更多的信息。如图\@ref(fig:incidents-leaflet)，鼠标悬浮在散点上可以看到事件发生的警区 PdDistrict，点击可以看到警方的处置方式 Resolution，这是设置 `addCircles()` 的参数 `label` 和 `popup` 实现的，实际上，它们还可以放入更加丰富的信息。

```{r,eval=FALSE}
library(leaflet)
# 分类变量映射成颜色
colorize_factor <- function(x) {
  # 设置颜色梯度数目
  scales::col_factor(palette = "plasma", domain = unique(x))(x)
}
# 警方处置方式 Resolution 映射成颜色变量
incidents <- transform(incidents, color = colorize_factor(Resolution))
# 绘制交互图形
leaflet(options = leafletOptions(
    minZoom = 4, maxZoom = 18, zoomControl = FALSE
  )) |> 
  addTiles() |> 
  setView(lng = -122.4, lat = 37.77, zoom = 13) |> 
  addCircles(
    data = incidents, popup = ~Resolution, 
    radius = 30, label = ~PdDistrict,
    lng = ~lon, lat = ~lat, color = ~color
  ) |> 
  addLegend("topright", pal = colorFactor(
    palette = "plasma", domain = unique(incidents$Resolution)
  ), values = incidents$Resolution, opacity = 1)
```

![(\#fig:incidents-leaflet) 2012 年旧金山警方出警地点的空间分布](/img/maps-in-r/incidents-leaflet.png){.full}

接下来再细致一点地探索 incidents 数据集，各个警区出警次数的分布情况，

```{r,eval=FALSE}
library(data.table)
incidents <- as.data.table(incidents)
library(ggplot2)
# SOUTHERN 警区的犯罪记录显著高于其他警区
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("PdDistrict", "violent")]

ggplot(data = dat, aes(x = PdDistrict, y = cnt, fill = violent)) +
  geom_col()
```

![(\#fig:incidents-pddistrict) 事件发生次数随警区的分布](/img/maps-in-r/incidents-pddistrict.png){.full}

进一步，可将图\@ref(fig:incidents-pddistrict)所示分布绘制在地图上，如图\@ref(fig:incidents)事件发生次数随警区的空间分布。

```{r,eval=FALSE}
dat <- incidents[, .(cnt = length(IncidntNum), lat = mean(lat), lon = mean(lon)), by = c("violent", "PdDistrict")]
# RgoogleMapsPlot 函数合成了地图和 lattice 分面绘图的能力
RgoogleMapsPlot(cnt ~ lat * lon | violent,
  data = dat,
  pch = 19, col = "orangered",
  scales = list(
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  panel = panel.loaPlot, show.axes = TRUE
)
```

![(\#fig:incidents) 事件发生次数随警区的**空间**分布：左图**非暴力**事件，右图**暴力**事件](/img/maps-in-r/incidents.png){.full}

全年来看，事件发生的时间分布，即犯罪的高峰时段在下午 5-6 点，一直持续到午夜 12 点。

```{r,eval=FALSE}
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("HrOfDay", "violent")]
ggplot(data = dat, aes(x = HrOfDay, y = cnt, fill = violent)) +
  geom_col()
```

![(\#fig:incidents-hour) 事件发生次数随时段的分布](/img/maps-in-r/incidents-hour.png){.full}

每次接报出警，警方会根据具体情况快速对事件定级分类，然后派出相应的警力以及处置方式。可以见事件性质 Category、是否发生暴力 violent 和警方处置方式 Resolution 应当有很强的关联。既然 Category， violent 和 Resolution 有很强的关联，展示关联关系非常重要，有的分类 Category 应该给予足够的处置力度，特别对于暴力事件，警方的措施是否有不当或处置不力的？以此，还可以推测旧金山的治安状况。

```{r,eval=FALSE}
dat <- incidents[, .(cnt = length(IncidntNum)), by = c("Category", "violent", "Resolution")]

ggplot(data = dat, aes(x = reorder(Category, cnt), y = cnt, fill = Resolution)) +
  geom_col() +
  coord_flip() +
  facet_grid(rows = vars(violent), scales = "free", space = "free") +
  labs(x = "Category")
```


![(\#fig:incidents-resolution) 事件性质和警方处置情况](/img/maps-in-r/incidents-resolution.png){.full}

对于不同的事件 Category 有不同的执行措施 Resolution，执行措施和是否属于暴力有关系，一般来讲，暴力事件都应该有处置，发生暴力事件只有 5 类，打架斗殴、抢劫、性骚扰、绑架、盗窃。


```{r incidents-category,echo=FALSE}
dat <- data.frame(
  Category = c(
    "LARCENY/THEFT", "NON-CRIMINAL", "OTHER OFFENSES", "ASSAULT",
    "VANDALISM", "DRUG/NARCOTIC", "BURGLARY", "VEHICLE THEFT",
    "MISSING PERSON", "ROBBERY", "SUSPICIOUS OCC", "FRAUD",
    "TRESPASS", "FORGERY/COUNTERFEITING", "WEAPON LAWS", "DISORDERLY CONDUCT",
    "RECOVERED VEHICLE", "DRIVING UNDER THE INFLUENCE", "DRUNKENNESS", "SEX OFFENSES, FORCIBLE",
    "RUNAWAY", "KIDNAPPING", "LOITERING", "LIQUOR LAWS",
    "PROSTITUTION", "ARSON", "EMBEZZLEMENT", "EXTORTION",
    "STOLEN PROPERTY", "GAMBLING", "BAD CHECKS", "PORNOGRAPHY/OBSCENE MAT",
    "SUICIDE"
  ),
  Category_cn = c(
    "盗窃", "非犯罪", "其他罪行", "打架斗殴",
    "蓄意破坏", "毒品/麻醉品", "入室盗窃", "车辆盗窃",
    "人员失踪", "抢劫", "可疑的 OCC", "欺诈",
    "非法入侵", "伪造/假冒", "武器法", "扰乱秩序",
    "回收车辆", "非正常行驶", "醉酒", "性骚扰",
    "逃跑", "绑架", "游荡", "酒法", "卖淫",
    "纵火", "挪用公款", "勒索",
    "被盗财产", "赌博", "空头支票", "色情/淫秽", "自杀"
  )
)
knitr::kable(x = dat, caption = "事件性质")
```

## 示例：美国人口普查统计数据

**ggplot2** 提供的 `map_data()` 函数可以从 **maps** 包中提取和转化地图数据，而 `coord_map()` 函数结合 **mapproj** 包可以实现坐标转化。下面以 R 内置的数据集 state.x77 为例，它记录了美国 1977 年 50 个州的人口普查情况，Population 各州的人口数量 （1975 年 7 月 1 日估计），Income 人均收入（1974年），Illiteracy 文盲比例（人口百分比），平均寿命（1969-1971年统计），Murder 谋杀和非过失杀人率（单位：十万分之一，1976年统计），HS Grad 高中毕业生百分比（1970 年统计），Frost 首都或大城市最低气温低于冰点的平均天数（1931-1960年统计），Area 土地面积（单位：平方英里）。如图\@ref(fig:ggplot2-statex77)， **maps** 包内置的美国各州的地图数据缺少夏威夷和阿拉斯加州。


```{r,eval=FALSE}
library(ggplot2)
# 准备地图数据
# maps 包的地图数据提取转为 data.frame 数据类型
states_map <- map_data(map = "state")
# 准备观测数据
state.x77 <- data.frame(region = tolower(rownames(state.x77)), state.x77)

# 将观测数据合并进地图数据
states_map <- merge(states_map, state.x77, by = "region", all.x = TRUE, sort = FALSE)
# 地图数据排序保证地图绘制顺序
states_map <- states_map[order(states_map$order), ]
# 绘图
ggplot(states_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(group = group, fill = Population)) +
  scale_fill_binned(
    type = "viridis",
    guide = guide_colourbar(
      barwidth = 25, barheight = 0.4,
      title.position = "top" # 图例标题位于图例上方
    )
  ) +
  coord_map(projection = "albers", lat0 = 45.5, lat1 = 29.5) +
  labs(x = "Longitude", y = "Latitude", fill = "State Population (1975)") +
  theme_void() +
  theme(legend.position = "bottom") # 图例位置图形下方
```

![(\#fig:ggplot2-statex77) 1975年美国各个州的人口](/img/maps-in-r/ggplot2-statex77.png){.full}


[**usmap**](https://github.com/pdil/usmap/) 提供 `plot_usmap()` 函数可谓专门用来绘制美国各州县的地图，包含夏威夷和阿拉斯加州，参数 `data` 需要传入一个数据框，且必须有一列可以和地图提供的区域名称映射上，即需要有一列的列名是 state 或 fips。实际上，**usmap** 包 还内置有区县级地图数据，也支持抽取特定的州县，更多介绍见[这里](https://usmap.dev/)。

```{r,eval=FALSE}
library(ggplot2)
state_x77 <- data.frame(state = tolower(rownames(state.x77)), state_x77)

usmap::plot_usmap(data = state_x77, values = "Population", labels = TRUE) +
  scale_fill_gradientn(
    colours = hcl.colors(10), na.value = "grey90",
    guide = guide_colourbar(
      barwidth = 25, barheight = 0.4,
      title.position = "top" # 图例标题位于图例上方
    )
  ) +
  labs(fill = "State Population (1975)") +
  theme(legend.position = "bottom") # 图例位置图形下方
```

![(\#fig:usmap-statex77) 1975年美国各个州的人口](/img/maps-in-r/usmap-statex77.png){.full}


## 示例：美国锡安公园地形数据

美国西南部犹他州锡安国家公园的高程珊格数据 elevation，该数据集由 [Jakub Nowosad](https://nowosad.github.io/) 收集于 [spDataLarge](https://github.com/Nowosad/spDataLarge) 包内，由于该 R 包收集的地理信息数据很多又很大，超出了 CRAN 对 R 包的大小限制，因此，需要从作者制作的 drat 站点下载。

```{r check-spDataLarge, eval=FALSE}
install.packages("spDataLarge", repos = "https://nowosad.github.io/drat/")
```

elevation 数据集通过雷达地形测绘 SRTM (Shuttle Radar Topography Mission) 获得，其分辨率为 90m $\times$ 90m，属于高精度地形网格数据，更多细节描述见 <http://srtm.csi.cgiar.org/>，下图\@ref(fig:raster-elevation)将公园的地形清晰地展示出来了，读者不妨再借助维基百科词条 (<https://en.wikipedia.org/wiki/Zion_National_Park>) 从整体上了解该公园的情况，结合丰富的实景图可以获得更加直观的感受。

```{r}
#| elevation-zion,
#| fig.cap="锡安国家公园的高程珊格数据",
#| fig.height=5,fig.width=5.5, 
#| eval=FALSE,
#| echo=FALSE

data("elevation", package = "spDataLarge")
terra::plot(elevation, asp = NA)
```

![(\#fig:raster-elevation) **terra** 包绘制锡安国家公园地形](/img/maps-in-r/raster-elevation.png){.full}

## 示例：中国地图数据

R 语言社区有不少 R 包涉及中国地图数据，但是质量不一，下面简单说下几个主要的数据源。

### 地图数据源

[**rnaturalearth**](https://github.com/ropenscilabs/rnaturalearth) 和 [**rnaturalearthdata**](https://github.com/ropenscilabs/rnaturalearthdata) 提供 [美国国家地理](https://www.naturalearthdata.com/)网站的 R 语言接口，可以免费下载矢量和栅格地图数据。

```{r}
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
```

下载和绘制中国地图数据，如图\@ref(fig:china-map)

```{r china-map, eval=FALSE}
sp::plot(rnaturalearth::ne_countries(
  country = "China",
  continent = "Asia",
  type = "countries",
  scale = 10, returnclass = "sp"
))
```

![(\#fig:china-map) 美国国家地理网站提供的中国地图数据](/img/maps-in-r/china-map.png){.full}


::: rmdnote
**rnaturalearthhires** 有 20 多 M，不在 CRAN 上，安装命令如下：

```{r,eval=FALSE}
install.packages(
  pkgs = "rnaturalearthhires",
  repos = "http://packages.ropensci.org",
  type = "source"
)
```
:::


```{r,eval=FALSE}
# 创建目录存储临时地形文件
xfun::dir_create("~/data/") 
# 从 raster::getData('ISO3') 可以知道各个国家或地区的 ISO3 代码
# 下载 Raster 数据 
# 中国大陆地区
chn_map <- raster::getData(name = "alt", country = "CHN", mask = TRUE, path = "~/data/")
# 台湾地区
twn_map <- raster::getData(name = "alt", country = "TWN", mask = TRUE, path = "~/data/")
# 香港地区
hkg_map <- raster::getData(name = "alt", country = "HKG", mask = TRUE, path = "~/data/")
# 澳门地区
mac_map <- raster::getData(name = "alt", country = "MAC", mask = TRUE, path = "~/data/")

# 若已经下载到本地，可直接读取
chn_map <- raster::raster(x = "~/data/CHN_msk_alt.grd")
twn_map <- raster::raster(x = "~/data/TWN_msk_alt.grd")
hkg_map <- raster::raster(x = "~/data/HKG_msk_alt.grd")
mac_map <- raster::raster(x = "~/data/MAC_msk_alt.grd")
# 合并 Raster 数据
china_map = terra::merge(chn_map, twn_map, hkg_map, mac_map)
# 查看数据类型
class(china_map)
# 调 terra 包绘图速度快
terra::plot(china_map, col = terrain.colors(20, rev = F))
```

![(\#fig:china-elevation) 中国地图海拔数据](/img/maps-in-r/china-elevation.png){.full}


另一个提供地图数据的是商业软件 [Highcharts Maps](https://www.highcharts.com/)，国内外有不少商业公司是它的客户，它也有一个 R 包[**highcharter**](https://github.com/jbkunst/highcharter)，
有一个以美国地图数据为背景的博客详细介绍了使用过程，详见 [Highcharts 官方博客](https://www.highcharts.com/blog/tutorials/using-highcharter-in-tidytuesday-internet-access/)。[简数科技](https://www.highcharts.com.cn/) 定制了一份 GeoJSON 格式的中国地图数据，还提供了地图预览和下载的服务，因为涉及商业版权和地图数据合规性，使用需要注意，读者可前往[网站](https://www.highcharts.com.cn/mapdata)了解。另一个 R 包[**hchinamap**](https://github.com/czxa/hchinamap) 也是使用这份中国地图数据和 JavaScript 库 [Highcharts JS](https://github.com/highcharts/highcharts)。

```{r,eval=FALSE}
library(hchinamap)
# name 是地图数据中的各个区域单元的名称
hchinamap(
  name = c("北京", "天津", "上海", "湖南", "台湾", "海南"),
  value = c(120, 200, 126, 300, 150, 225),
  width = "100%",
  height = "650px",
  title = "分省地图",
  region = "China",
  minColor = "#f1eef6",
  maxColor = "#980043",
  itermName = "指标",
  hoverColor = "#f6acf5"
)
```

![(\#fig:china-hchinamap) 中国地图数据](/img/maps-in-r/china-hchinamap.png){.full}



### 交互地图

交互地图采用 **leaflet** 包绘制，采用 **leafletCN** 包汉化，并且提供合规的中国地图，核心函数是 `geojsonMap()`，它封装了 GeoJSON 格式的地图数据和绘图函数，更多定制参考`leaflet::leaflet()`，只要数据包含的一列区域名称和地图数据能映射上，就可以绘制出图\@ref(fig:china-leafletcn)，图中数据是随机生成的，调色板采用 `RdBu`，将连续的数据分段，每段对应一个色块。 

```{r,eval=FALSE}
library(leaflet)
library(leafletCN) # 提供 geojsonMap 函数
dat <- data.frame(name = regionNames("china"), value = runif(34))
# 还有很多其他参数设置，类似 leaflet::leaflet
geojsonMap(dat, mapName = "china", palette = "RdBu", colorMethod = "bin")
```

![(\#fig:china-leafletcn) 交互地图数据可视化](/img/maps-in-r/china-leafletcn.png){.full}


### 静态地图

[中华人民共和国民政部](http://xzqh.mca.gov.cn)提供了中国地图数据，是 GeoJSON 格式的，属于权威数据源，推荐使用。

```{r,eval=FALSE}
library(sf)
china_map = st_read(dsn = "http://xzqh.mca.gov.cn/data/quanguo_Line.geojson", stringsAsFactors = FALSE)
```
```
Reading layer `线' from data source 
  `http://xzqh.mca.gov.cn/data/quanguo_Line.geojson' using driver `GeoJSON'
Simple feature collection with 104 features and 3 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 73.68 ymin: 3.554 xmax: 135.2 ymax: 53.65
Geodetic CRS:  WGS 84
```
```r
china_map
```
```
Simple feature collection with 104 features and 3 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 73.68 ymin: 3.554 xmax: 135.2 ymax: 53.65
Geodetic CRS:  WGS 84
First 10 features:
     NAME  QUHUADAIMA strZTValue                       geometry
1         hainansheng            LINESTRING (121.9 30.84, 12...
2         hainansheng            LINESTRING (121.4 30.82, 12...
3         hainansheng            LINESTRING (121.5 31.64, 12...
4          tiaohuijie            LINESTRING (124.4 40.08, 12...
5          tiaohuijie            LINESTRING (124.5 40.13, 12...
6  台湾岛      daoyu6            LINESTRING (121.4 22.46, 12...
7  海南岛      daoyu5            LINESTRING (111.5 19, 112.4...
8  钓鱼岛      daoyu6            LINESTRING (122.8 26.07, 12...
9  赤尾屿      daoyu6            LINESTRING (125.2 25.86, 12...
10 黄岩岛      daoyu6            LINESTRING (117.2 14.61, 11...
```
```r
plot(china_map)
```

![(\#fig:china-linestring) 静态地图数据](/img/maps-in-r/china-linestring.png){.full}


另一份地图数据是全国各地的行政区域，只有省一级。

```{r,eval=FALSE}
china_map = st_read(dsn = "http://xzqh.mca.gov.cn/data/quanguo.json", stringsAsFactors = FALSE)
# 原数据集没有坐标系信息，因此设置一下
st_crs(china_map) = 4326
plot(china_map["QUHUADAIMA"])
```

![(\#fig:china-province) 静态地图数据](/img/maps-in-r/china-province.png){.full}



# 可视化包

本节主要介绍几个 R 语言社区提供的地理可视化 R 包，分别是绘制交互式地图的 **echarts4r** 包 [@echarts4r]、**leaflet** 包和 **plotly** 包。

地理可视化的展示形式有多种，散点图、气泡图、峰窝图和热度图等，还可以有更加复合的专题地图，如在地图上省、市、区、县一级别，显示各个年龄段的人口比例，类似将饼图贴在地图上。为简单起见，以散点图为例介绍入门级别的内容。


## echarts4r

**echarts4r** 支持使用多种地图服务，包括 OSM（OpenStreetMap）、Mapbox、谷歌、高德 等，只要提供引用瓦片服务数据模版即可。**echarts4r** 默认使用了一份矢量地图数据，如图\@ref(fig:quakes-echarts4r)所示。简单起见，这里使用了 R 内置的数据集 quakes，它描述了太平洋岛国斐济及周边自 1964 年以来的四级以上的地震活动。从图中不难看出有两个非常清晰的地震带。结合背景材料，一个在主要板块交界处，另一个是新西兰附近的汤加海沟。2022年1月14日，汤加海底火山爆发，引发海啸等一系列自然灾害，中国地震局也发布新闻资讯---[汤加火山喷发，会造成哪些影响？](https://www.cea.gov.cn/cea/xwzx/fzjzyw/5647231/index.html)详细介绍了这一事件。



```{r,eval=FALSE}
library(echarts4r)
# 使用默认的地图
quakes |>
  e_charts(x = long) |>
  e_geo(
    roam = TRUE,
    map = "world",
    boundingCoords = list(
      c(165.67, -38.59),
      c(188.13, -10.72)
    )
  )  |>
  e_scatter(
    serie = lat, size = mag, name = "Fiji",
    coord_system = "geo"
  ) |>
  e_visual_map(mag, scale = e_scale)
```

![(\#fig:quakes-echarts4r) **echarts4r** 使用内置矢量地图数据](/img/maps-in-r/quakes-echarts4r.png){.full}

**echarts4r** 提供地理图层 `e_geo()` 专门用来加载地图数据，在这个例子中，只需要展示局部地图，因此基于数据集 quakes 提取经纬度范围，获取了边界信息，设置了参数 `boundingCoords`，即矩形的左上顶点和右下顶点的两个坐标，关于其它参数更加详尽的介绍，见 Apache Echarts 官方文档里 [地理图层](https://echarts.apache.org/en/option.html#geo.boundingCoords)。下面做一些更加细致的调整，最终效果如图\@ref(fig:quakes-dark)。

- `e_effect_scatter()` 替换 `e_scatter()` 实现一些动态特效，和地震的震波建立一些视觉联系，不过会增加渲染压力；设置 `scale = NULL` 去掉默认对 size 变量的尺度变换；
- `e_title()` 添加一些文字介绍斐济地震带背后的数据背景；
- `e_tooltip()` 参考 Apache Echarts 官方文档[tooltip](https://echarts.apache.org/zh/option.html#geo.tooltip.formatter)在气泡上定制悬浮提示，补充震点位置和震级信息，定性和定量结合；
- `e_visual_map()` 设置透明度缓解数据点覆盖，设置颜色和气泡大小的变化范围；
- `e_legend()` 隐藏图例，已用 `e_visual_map()` 替代；
- `e_theme()` 参考[主题配置页面](https://echarts.apache.org/zh/theme-builder.html)挑选黑色背景主题。

```{r,eval=FALSE}
# 使用默认的地图
annotation_point <- c(-21.0744, 183.7499, 0, 7, 0)
quakes <- rbind(quakes, annotation_point) # 把这个点加到数据集里面
# 新加一列专用于文本注释
# 火山爆发和地震不是一回事
quakes$annotation <- ' '
quakes[which(quakes$lat == -21.0744 & quakes$long == 183.7499), ]$annotation <- '汤加火山'

# 绘图
quakes |>
  e_charts(x = long) |>
  e_geo(
    roam = TRUE,
    map = "world",
    boundingCoords = list(
      c(165.67, -38.59),
      c(188.13, -10.72)
    )
  ) |>
  e_effect_scatter(
    serie = lat,
    scale = NULL, # 去掉尺度变换
    bind = annotation, # 用于 params.name
    size = mag, 
    name = "地震点",
    coord_system = "geo"
  ) |>
  e_visual_map(
    serie = mag, # 震级图例
    textStyle = list(color = "white"),
    inRange = list(
      color = hcl.colors(10), # 填充颜色
      colorAlpha = 0.7, # 设置透明度
      symbolSize = c(1, 15) # 设置气泡大小
    )
  ) |>
  e_labels(
    position = 'top',
    formatter = htmlwidgets::JS("function(params){return( params.name )}")
  ) |> 
  e_tooltip(
    formatter = htmlwidgets::JS("
        function(params) {
          return('<strong>' + params.seriesName + '</strong>' + 
          '<br>经度：' + params.value[0] + 
          '<br>纬度：' + params.value[1] + 
          '<br>震级：' + params.value[2])
        }
      ")
  ) |>
  e_title(
    text = "斐济地震带",
    subtext = "斐济是南太平洋上的一个岛国",
    left = "center",
    sublink = "https://echarts4r.john-coene.com/"
  ) |> 
  e_legend(show = FALSE) |>  # 隐藏图例
  e_theme(name = "chalk")
```


![(\#fig:quakes-dark) **echarts4r** 使用内置矢量地图数据](/img/maps-in-r/quakes-dark2.png){.full}


下面介绍在瓦片地图数据的基础上展示 quakes 数据，如图\@ref(fig:quakes-osm) 所示，这里采用地理图层 `e_leaflet()` 调用开放的 OpenStreetMap 瓦片服务。


```{r,eval=FALSE}
# OSM
quakes |>
  e_charts(long) |>
  e_leaflet(center = c(175, -20), zoom = 4) |>
  e_leaflet_tile() |>
  e_scatter(lat, size = mag, coord_system = "leaflet")
```


![(\#fig:quakes-osm) **echarts4r** 使用 OpenStreetMap 地图](/img/maps-in-r/quakes-osm.png){.full}

类似谷歌的要求，使用 Mapbox 地图服务也需要先申请个人访问令牌，申请下来后，也把它设置到 R 语言环境变量里 `MAPBOX_TOKEN`，以便后续使用。

```{r,eval=FALSE}
# MAPBOX 地图
quakes |>
  e_charts(long) |>
  e_mapbox(
    # MAPBOX 的访问令牌
    token = Sys.getenv("MAPBOX_TOKEN"),
    # 地图风格样式
    style = "mapbox://styles/mapbox/dark-v9",
    # 视角：地图中心
    center = c(175, -20),
    # 缩放等级
    zoom = 4
  ) |>
  e_scatter_3d(lat, mag, coord_system = "mapbox") |>
  e_visual_map(mag)
```


![(\#fig:quakes-mapbox) **echarts4r** 使用 MAPBOX 地图](/img/maps-in-r/quakes-mapbox.png){.full}


在国内，最好使用百度、高德这样的国家认可的地图服务提供商，这也很容易，只需用高德的 tile 服务数据替换 OSM 的。

```{r,eval=FALSE}
# 高德地图
quakes |>
  e_charts(long) |>
  e_leaflet(center = c(175, -20), zoom = 4) |>
  e_leaflet_tile(
    template = "https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
    options = list(tileSize = 256, minZoom = 3, maxZoom = 17)
  ) |>
  e_scatter(lat, size = mag, coord_system = "leaflet")
```


![(\#fig:quakes-amap) **echarts4r** 使用高德地图](/img/maps-in-r/quakes-amap.png){.full}

```{r,eval=FALSE}
# 谷歌地图
quakes |>
  e_charts(long) |>
  e_leaflet(center = c(175, -20), zoom = 4) |>
  e_leaflet_tile(
    template = "http://mt2.google.cn/vt/lyrs=m@167000000&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}&s=Galil",
    options = list(tileSize = 256, minZoom = 3, maxZoom = 17)
  ) |>
  e_scatter(lat, size = mag, coord_system = "leaflet")
```

![(\#fig:quakes-ggmap) **echarts4r** 使用谷歌地图](/img/maps-in-r/quakes-ggmap.png){.full}




百度、阿里、腾讯等公司都提供大量面向不同场景的地图服务，一些软件也内置了地图，如[tableau](https://www.tableau.com/products/desktop) 和[QGIS](https://www.qgis.org/)等，下图\@ref(fig:qgis) 展示 QGIS 软件使用在线的 OpenStreetMap 地图。

![(\#fig:qgis) QGIS 软件内的 OpenStreetMap 地图](/img/maps-in-r/qgis.png){.full}



## leaflet

**leaflet** [@leaflet] 包借助 htmlwidgets 封装了鼎鼎大名的 leaflet 库，


在可视化的过程中，配色是非常重要的一个环节，准确地表达地图上各个区域或位置的数据信息，负责体现分类、层次、大小等信息。常见的操作是将一组数据映射成一组颜色值，还是以 quakes 数据集为例，下面将连续型的地震震级数据映射成一组颜色值。这方面的工作已经有非常成熟的 R 包来做了，比如[**scales**](https://github.com/r-lib/scales)包和[**colourvalues**](https://github.com/SymbolixAU/colourvalues) 包。如图 \@ref(fig:quakes-viridis)，默认情况下 `viridis` 调色板，颜色越黄值越大。

```{r,eval=FALSE}
# 将连续型数据向量转化为颜色向量
colorize_numeric <- function(x) {
  scales::col_numeric(palette = "viridis", domain = range(x))(x)
}
# 在数据集 quakes 上添加新的一列数据 color
quakes <- transform(quakes, color = colorize_numeric(mag))
# 绘制散点图
plot(data = quakes, lat ~ long, col = color, pch = 19)
```

![(\#fig:quakes-viridis) 地震震级映射连续的颜色值](/img/maps-in-r/quakes-viridis.png){.full}

另一种情况是将分类型的变量映射上颜色，这通常采用分类型的调色板，比如 `Set2`。所有常用的调色板可见 **RColorBrewer** 包，在命令行中直接运行 `RColorBrewer::display.brewer.all()` 即可预览。稍微值得注意的是当分类太多，超出了调色板的数量，需要自己构造一下，比如 `Set2` 只有8种颜色，但是需要10种，可通过如下方法差值构造：

```{r}
colorRampPalette(colors = RColorBrewer::brewer.pal(n = 8, name = "Set2"))(10)
```

如图 \@ref(fig:quakes-set2) 所示，用不同颜色表示不同种类的鸢尾花。

```{r,eval=FALSE}
# 注意因子水平个数
colorize_factor <- function(x) {
  scales::col_factor(palette = "Set2", levels = unique(x))(x)
}
# 给每个点设置一个颜色
iris <- transform(iris, color = colorize_factor(Species))
# 绘图
plot(data = iris, Petal.Length ~ Petal.Width, col = color, pch = 19)
```

![(\#fig:quakes-set2) 三种鸢尾花用不同颜色标记](/img/maps-in-r/quakes-set2.png){.full}

实际上，还可以将地震震级分段，用梯度变化的颜色表示震级的大小，如图\@ref(fig:quakes-leaflet)所示。

```{r,eval=FALSE}
library(leaflet)
data(quakes)
# 构造 Pop 提示
quakes$popup_text <- lapply(paste(
  "编号:", "<strong>", quakes$stations, "</strong>", "<br>",
  "震深:", quakes$depth, "<br>",
  "震级:", quakes$mag
), htmltools::HTML)
# 构造调色板
pal <- colorBin("Spectral", bins = pretty(quakes$mag), reverse = TRUE)
# 绘图可视化
leaflet(quakes, options = leafletOptions(attributionControl = FALSE)) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  # 添加带颜色的散点图
  addCircles(lng = ~long, lat = ~lat, color = ~ pal(mag), label = ~popup_text) |>
  # 在右下角添加图例
  addLegend("bottomright", pal = pal, values = ~mag, title = "地震震级") |>
  # 在左下角添加地图比例尺
  addScaleBar(position = c("bottomleft"))
```

![(\#fig:quakes-leaflet) **leaflet** 包使用 OpenStreetMap 地图](/img/maps-in-r/quakes-leaflet.png){.full}


## plotly

**plotly** [@plotly] 包调用 Mapbox 地图服务做地理可视化


```{r,eval=FALSE}
plotly::plot_mapbox(
  data = quakes, colors = "Spectral",
  lon = ~long, lat = ~lat, color = ~mag,
  type = "scattermapbox", mode = "markers",
  marker = list(size = 10, opacity = 0.5)
) |>
  plotly::layout(
    title = "斐济地震带",
    mapbox = list(
      # style = 'dark', # 暗黑主题
      zoom = 4, # 缩放级别
      center = list(lat = -20, lon = 175)
    )
  ) |>
  plotly::config(
    mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"),
    displayModeBar = FALSE
  )
```

![(\#fig:quakes-plotly) **plotly** 包使用 Mapbox 地图](/img/maps-in-r/quakes-plotly.png){.full}

布局设置以 `layout(mapbox = ...)` 内的 style 参数为例， 它是用来设置地图风格样式的，除了默认的参数值 `basic`，还可以设置为夜晚暗黑 `dark`，卫星地图 `satellite` 等，其他见[文档](https://plotly.com/r/reference/layout/mapbox/)。


![(\#fig:quakes-satellite) **plotly** 包使用 Mapbox 卫星地图](/img/maps-in-r/quakes-satellite.png){.full}





# 数据结构

本节开始介绍一些空间数据相关的基础知识，R 语言有一些扩展包是专门处理空间数据的，提供基础数据结构和类型，了解这些是为空间数据操作、分析、建模打基础。空间数据操作（Spatial Data Manipulation），如计算空间区域的面积、空间点的路径、区域叠加、基于空间关系的数据查询等。空间数据分析（Spatial Data Analysis），空间数据的描述性分析和探索性分析，帮助发现数据中的模式规律。空间统计分析（Spatial Statistical Analysis），传统的统计模型认为观测值之间常常是独立的，而空间数据自带空间相关性，需要专门的统计分析方法。空间数据建模（Spatial Data Modeling），面对不同的空间数据类型需要不同的建模方法，比如空间点模式分析（Spatial Point Pattern Analysis）、格网/面状数据分析（Area Data/Grid Data/lattice Data Analysis）、地统计分析（Geostatistics）等。


**rgeos** [@rgeos]、**rgdal** [@rgdal] 和 **maptools** [@maptools] 都将于 2023 年底移出 CRAN，不再维护，它们主要用来读取和操作空间数据，相比于 **sf** [@sf] 加 **terra** [@terra] 的新方案，它们都落后了。部分功能会迁移到 **sp** 包[@sp]，而 **raster** 包[@raster]也不推荐使用，大迁移背景介绍见[这里](https://github.com/r-spatial/evolution)，几十年过去了，维护者退休了，代码的历史包袱很重，很难维护，功能和性能也没新的好。2019 年出版的开源书籍[《Geocomputation with R》](https://geocompr.robinlovelace.net/) 已经在紧锣密鼓地升级了，感兴趣的读者不妨看看新旧[详细比较](https://keen-swartz-3146c4.netlify.app/older.html)。


## 矢量数据 sp

**sp** [@sp] 是一个 R 包，提供一种存储和操作空间数据的对象类型，具体地，提供点 SpatialPoints / SpatialMultiPoints、线 SpatialLines、多边形 SpatialPolygons、栅格 SpatialGrid / SpatialPixels 等基础空间数据类型以及相应构造方法，还有聚合 `aggregate()`，合并 `merge()`，转化 `spTransform()` 和绘图 `spplot()` / `bubble()` / `image()` 等空间数据操作和可视化函数。

```{r}
library(sp)
```

meuse 数据集为例

```{r}
data(meuse)
summary(meuse)
```

Ruud van Rijn 和 Mathieu Rikken 最初收集了 Stein 村 Meuse 河洪泛区地表土壤重金属浓度数据，Edzer Pebesma 将数据整理打包后做成 **sp** 内置的数据集 meuse。除了几种重金属浓度，还包含土壤、周围环境相关的变量，共 155 个采样点，14 个观测变量，具体情况：

- x 东西方向坐标，单位米，坐标参照系为 RDH（Rijksdriehoek） 荷兰地形。 
- y 南北方向坐标，单位米。
- cadmium 表土**镉**浓度，每千克土壤中镉含量（按毫克计），因此，浓度单位为 ppm，若原始数据中镉浓度为 0，则漂移至 0.2，即最小的镉浓度的一半。
- copper 表土**铜**浓度，单位 ppm。
- lead 表土**铅**浓度，单位 ppm。
- zinc 表土**锌**浓度，单位 ppm。
- elev 以当地河床为水平面，相对高度，单位米。
- dist 采样点至 Meuse 河的距离，距离归一化到 0-1 区间。
- om 每100千克土壤中有机质的占比，百分数。
- ffreq 洪水等级，1 表示两年一次，2 表示十年一次，3 表示 五十年一次。
- soil 土壤类型，按照荷兰 1:50000 的土壤图划分，1 表示 Rd10A （钙质弱发育草甸土，轻质砂质粘土），2 表示 Rd90C/VII （非钙质弱发育草甸土，重砂质粘土至轻质粘土），3 表示 Bkd26/VII
（红砖土、细砂质、粉质轻质粘土）。
- landuse 土地利用类别：Aa 农业/未指定 = ，Ab = Agr/糖用甜菜，Ag = Agr/小谷物，Ah = Agr/??，Am = Agr/玉米，B = 树林，Bw = 牧场中的树木，DEN = ?? , Fh = 高果树，Fl = 矮果树； Fw = 牧场果树，Ga = 家庭花园，SPO = 运动场，STA = 马厩，Tv = ?? , W = 牧场。
- dist.m 采样点到 Meuse 河的距离，单位以米计，数据来自实地调查。

最后，数据集 meuse 中的行名 `row.names` 表示原始的采样点的编号。

meuse 是 SpatialPointsDataFrame 类型

meuse 指定坐标系

```{r}
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=WGS84 +units=m +no_defs")
class(meuse)
```

将普通的数据框 data.frame 转化为空间点数据框 SpatialPointsDataFrame， sp 包不仅提供了数据类型的转化方法，而且对这种新的数据类型提供相应的绘图方法，使用方法和普通的 `plot()` 函数一样，这也是 S3 泛型函数的特色。

```{r,eval=FALSE}
plot(meuse)
```

![(\#fig:sp-meuse) **sp** 包绘图空间点数据](/img/maps-in-r/sp-meuse.png){.full}

```{r,eval=FALSE}
data(meuse.grid)
coordinates(meuse.grid) = ~x+y
proj4string(meuse.grid) <- CRS("+init=epsg:28992")
gridded(meuse.grid) = TRUE
spplot(meuse.grid)
```

meuse.grid 是 SpatialPixelsDataFrame 类型

实际上，截止目前 `plot()` 函数已经汇集很多方法了，它已经是一个绘图对象，对于不同类型的数据对象，它会调用相应的绘图方法。记住，一切都是对象，一切的操作都是函数调用。

```{r methods-plot, echo=FALSE}
# library(raster)
# library(lattice)
# library(nlme)
knitr::kable(matrix(c(methods(plot), ""), ncol = 4),
  caption = "plot 绘图方法"
)
```


```{r,eval=FALSE}
library(loa)
OpenStreetMapPlot(lead * 2 + zinc ~ latitude * longitude,
  col.regions = c("grey", "darkred"), 
  key.z.main="Concentrations", panel.zcases = TRUE,
  data = lat.lon.meuse, map = roadmap.meuse
)
```

## 栅格数据 raster

栅格数据是空间数据的另一种类型，比如遥感卫星拍摄的照片，**raster** [@raster] 可以处理这类数据的分析和可视化。raster 包正在过渡到 terra 包，后者速度更快，接口函数是相似的。

[layer](https://github.com/marcosci/layer) 层次性


iPhone 12 Pro 拍摄的照片默认采用 HEIC (High Efficiency Image Container) 格式保存，这是一张层次很丰富的乌云照片，原始尺寸为 $4032 \times 3024$，这里先用 [ImageMagick](https://imagemagick.org/) 将 HEIC 格式转化为 Tiff 格式，长宽尺寸均缩小为原来的十分之一，方便后续处理。

```bash
magick dark_cloud.HEIC -resize 10% dark_cloud.tif
```

```{r,eval=FALSE}
library(stars)
dark_cloud = stars::read_stars("~/Documents/xiangyun/static/img/maps-in-r/dark-cloud.tif")
plot(dark_cloud)
# 调用 ggplot2 绘图
library(ggplot2)
ggplot() +
  geom_stars(data = dark_cloud) +
  facet_wrap(~band, ncol = 2) +
  coord_equal() +
  theme_void() +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_viridis_c()
```

![(\#fig:cloud-stars) **stars** 包读取 raster 数据](/img/maps-in-r/cloud-stars.png){.full}

颜色越深，乌云越厚，RGB 三颜色加 alpha 通道


笔者用 iPhone 12 Pro 拍摄的天空照片和银杏树照片，层次，通道， 
TIFF 照片卫星拍摄的照片与此大致相仿，所使用的镜头不同而已。下面介绍一下如何处理这类图像数据。图像处理，检测 detection，分割 segmentation，识别 recognition，如何识别出来图片中是乌云还是银杏叶，乌云和银杏叶的轮廓，如何将一朵朵乌云分割开来，一片片银杏叶呢？


```{r,eval=FALSE}
library(terra)
```

```{r raster-grain, eval=FALSE}
data(grain, package = 'spData')
terra::plot(grain, asp = NA)
```

![(\#fig:raster-grain) **terra** 包绘制栅格数据](/img/maps-in-r/raster-grain.png){.full}

::: rmdtip
R 软件内置的调色板 `terrain.colors()` 专用于地形图配色，从翠绿色、土黄色、沙白色，无不暗示海拔变化，读者不妨想象一下，山上的树呈翠绿色，山腰的砂石土块呈土黄色，山脚的河床小路呈沙白色，十分符合我国南方的丘陵山地印象。
:::



[**spData**](https://github.com/Nowosad/spData/)


**spData** 内的 wheat 数据集来自非常经典的空间统计书籍《Statistics for Spatial Data》[@Cressie1993]。

sf 读取 shp 文件

```{r}
library(sf)
wheat <- st_read(system.file("shapes/wheat.shp", package = "spData"))
wheat
```
```{r,eval=FALSE}
plot(wheat["yield"])
```

![(\#fig:sf-wheat) 小麦产量空间分布图](/img/maps-in-r/sf-wheat.png){.full}



## 矢量数据 sf

[Proj](https://proj.org/)

**sf** [@sf] 可以看作是继 sp 后的第二代空间数据处理和分析的框架，上一代的 maptools rgdal 和 rgeos 包退役。 历史遗留的部分陆续迁移至 sp 新的开发阵地已经迁移到 sf 上。哪些遗留的部分会迁移到 sp 而新的阵地又是什么？


```{r}
library(sf)
```


```{r}
data(alaska, package = 'spData')
alaska
```

数据集 alaska 使用的坐标参考系是 Alaska Albers (EPSG:3467)。各个变量分别是 GEOID 地理标识符（geographic identifiers），NAME 州的名称，REGION 区域的名称，AREA 面积（平方千米），total_pop_10 2010 年人口，total_pop_15 2015 年人口，geometry 表示 sf 多边形类的集合属性。

```{r,eval=FALSE}
plot(alaska["total_pop_15"])
```

![(\#fig:sf-alaska) **sf** 包绘制多边形数据](/img/maps-in-r/sf-alaska.png){.full}

```{r}
data(world, package = 'spData')
world
```

world 包含 177 个国家和地区的人口数据，area_km2 面积、pop 人口（2014 年）、lifeExp 人均寿命（2014 年）和 gdpPercap 人均 GDP （2014 年）。地理信息相关的数据有 iso_a2 国标 ISO 的国家编码，name_long 国家名字，continent 大洲名字，region_un 区域名称，subregion 子区域名称和 type 类型。数据收集自国家地理 [Natural Earth](https://www.naturalearthdata.com/) 和世界银行 [World Bank](https://data.worldbank.org/)，Jakub Nowosad 整理在 **spData** 包里。

[rnaturalearth](https://github.com/ropenscilabs/rnaturalearth)

```{r,eval=FALSE}
plot(world["gdpPercap"])
```

![(\#fig:sf-world) 2014 年世界各国人均 GDP](/img/maps-in-r/sf-world.png){.full}

::: rmdnote
**spData** 包内置的 world 数据集将台湾和中国大陆的地区用不同的颜色标记，严格来讲，这是不符合国家地图规范的，不能出现在期刊、书籍等正式的出版物里。
:::

## 栅格数据 terra




# 案例：美国北卡婴儿猝死综合征数据


再看一个稍微复杂的例子，涉及数据读取、操作和绘图，数据集 SIDS (Sudden Infant Death Syndrome，简称 SIDS)来自 **sf** 包，更早些时候收集在 **sp** 包内，更多细节见 Edzer Pebesma 开发的 **sp** 包[帮助文档](https://edzer.github.io/sp/)，描述 1974 年和 1979 年美国北卡罗来纳州各个区县的婴儿猝死综合征的情况。

```{r}
# 读取数据，且读取后不要转化为 tibble 数据类型
nc <- read_sf(system.file("gpkg/nc.gpkg", package = "sf"), as_tibble = FALSE)
# 提取部分列
nc2 <- subset(x = nc, select = c("SID74", "SID79"))
# 查看数据
nc2
```
```{r,echo=FALSE}
# Base R 方式的变形操作
# https://gis.stackexchange.com/questions/381112/
# 如下变形操作亦可用 tidyr::pivot_longer 实现
# nc2 <- tidyr::pivot_longer(
#   data = nc2, c("SID74", "SID79"),
#   names_to = "VAR", values_to = "SID"
# )
```

nc2 是一种宽格式数据，有两列 SID74 和 SID79，现在希望在地图上以 ggplot2 的分面绘图方式同时展示两个变量的空间分布，因此，需要先将数据由「宽格式」转为「长格式」。转化前，先来看下 nc2 的数据类型：

```{r}
class(nc2)
```

它是一个非常复杂的数据类型，集合了 `sf` 和 `data.frame` 两种基本类型，在数据操作和绘图时，会根据类型的先后顺序依次查找和调用对应类型下的方法。

```{r}
# 将 nc2 强制转化为简单的 data.frame 类型
nc3 <- as.data.frame(nc2)
# 对 nc2 做「宽格式」转「长格式」的变形操作
nc3 <- reshape(
  data = nc3,
  varying = c("SID74", "SID79"), # 需要转行的列，也可以用索引位置代替
  times = c("SID74", "SID79"),
  v.names = "SID", # 列转行 列值构成的新列，指定名称
  timevar = "VAR", # 列转行 列名构成的新列，指定名称
  idvar = "geom",
  new.row.names = 1:(2 * 100), # 2 列拉长，每列有 100 个值，长格式有 2*100 行
  direction = "long"
)
# 变形完成后，恢复原来的数据类型
nc3 <- st_as_sf(nc3, sf_column_name = "geom")
class(nc3)
```

## ggplot2

**ggplot2** 提供的几何图层 `geom_sf()` 是专门为 sf 数据对象准备的，`facet_wrap()` 和 `facet_grid()` 都可以用来实现分面，布局样式稍有不同，更多绘图细节介绍见《ggplot2: Elegant Graphics for Data Analysis》[@Wickham2022]
第三版的地图章节，如图 \@ref(fig:sf-nc)。在地图上绘制栅格图形，有个专业的制图术语 --- Choropleth maps，翻译过来，大致叫填充地图、等值域图、瓦片图、围栏图、面量图、断层图等，可以非常直观地展示观测变量在地理区域内的变化情况。

```{r,eval=FALSE}
library(ggplot2)
ggplot() +
  geom_sf(data = nc3, aes(fill = SID)) +
  facet_wrap(~VAR, ncol = 1)
# 或
# ggplot() +
#   geom_sf(data = nc3, aes(fill = SID)) +
#   facet_grid(rows = vars(VAR))
```

![(\#fig:sf-nc) sf 数据可视化](/img/maps-in-r/sf-nc.png){.full}

## sp::spplot

```{r,eval=FALSE}
library(maptools)
nc <- readShapePoly(
  fn = system.file("shapes/sids.shp", package = "maptools"),
  proj4string = CRS("+proj=longlat +datum=NAD27")
)
```

::: rmdwarn
**maptools** 包提供的 `readShapePoly` 函数去读取 shp 文件的方式已经过时，将在 2023 年底不可用，推荐使用 `rgdal::readOGR` 或者 `sf::st_read` 方式读取。
:::

**sp** 包提供的函数 `spplot()` 方法绘制类似的分面图，这其中借助了 **lattice** 包的绘图能力，效果如\@ref(fig:lattice-nc)所示。

```{r,eval=FALSE}
spplot(nc, c("SID74", "SID79"),
  as.table = TRUE,
  scales = list(draw = T, 
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  sp.layout = list("SpatialPolygonsRescale",
    layout.north.arrow(2),
    offset = c(-76, 34), scale = 0.5, which = 2
  )
)
```


![(\#fig:lattice-nc) **lattice** 数据可视化](/img/maps-in-r/lattice-nc.png){.full}

```{r,eval=FALSE}
library(ggmap)
bgMap = get_map(as.vector(bbox(nc)), source = "google", zoom = 8) 
spplot(spTransform(nc, CRS("+init=epsg:3857")),
  c("SID74", "SID79"),
  as.table = TRUE,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  sp.layout = list(panel.ggmap, bgMap, first = TRUE)
)
```

![(\#fig:sp-nc) **sp** 数据可视化](/img/maps-in-r/sp-nc.png){.full}


## leaflet

而 leaflet 支持绘制交互式的图形，如图 \@ref(fig:leaflet-nc) 所示。

```{r,eval=FALSE}
# https://stackoverflow.com/questions/57223853/
# 转化坐标和 leaflet 的坐标系保持一致
nc2 <- sf::st_transform(nc2, crs = "+proj=longlat +datum=WGS84")
library(leaflet)
# 调色板
pal <- colorNumeric("plasma", domain = NULL)
# 绘图
leaflet(nc2) %>%
  addTiles() %>%
  addPolygons(
    stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1.0,
    fillColor = ~ pal(SID74)
  ) %>%
  addLegend(pal = pal, values = ~SID74, opacity = 1.0)
```

![(\#fig:leaflet-nc) **leaflet** 数据可视化](/img/maps-in-r/leaflet-nc.png){.full}

## latticeExtra::mapplot

**latticeExtra** 在 **lattice** 的基础上，封装了一些高级函数，围绕本篇主题，下面介绍一下 `mapplot()` 函数，读者不妨类比 `spplot()` 函数，可知它是专门为 map 数据类型提供绘图服务。 map 数据类型在 R 语言中存在很多年了，算得上是古老了，以前绘图的 R 包主要是基础地图 **maps**， 更多地图 **mapdata**， 地图投影 **mapproj** 和读写操作 **maptools**。

```{r,eval=FALSE}
mapplot(x, data, map,
  outer = TRUE,
  prepanel = prepanel.mapplot,
  panel = panel.mapplot,
  aspect = "iso",
  legend = NULL,
  breaks, cuts = 30,
  colramp = colorRampPalette(hcl.colors(n = 11, palette = "Spectral")),
  colorkey = TRUE,
  ...
)

prepanel.mapplot(x, y, map, ...)
panel.mapplot(x, y, map,
  breaks, colramp,
  exact = FALSE, lwd = 0.5,
  ...
)
```

参数 `x` 提供符合 R 语言语法的公式，比如 `y ~ x1 + x2`。参数 `data` 提供数据集，包含观测变量。参数 `map` 提供地理边界信息，地理单元的名称必须和公式中变量 y 的值匹配。

```{r,eval=FALSE}
# 加载 maps 包
library(maps)
# 将 sp 多边形类型 SpatialPolygons 转化为 map 类型
# 每个多边形单元的名字（郡县）都是唯一的
# 原数据 nc 里面标识每个单元的字段 NAME
nc_map <- SpatialPolygons2map(nc, namefield = "NAME")
# 查看转化后的数据类型
class(nc_map)
```

```{r,eval=FALSE}
# 提取原数据中的观测变量
dat <- nc@data
library(latticeExtra)
# 绘图
mapplot(NAME ~ SID79 + SID74,
  data = dat, border = NA,
  map = nc_map,
  colramp = viridisLite::plasma, # hcl.colors,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  xlab = "Long", ylab = "Lat"
)
```

![(\#fig:latticeExtra-nc) **latticeExtra** 数据可视化](/img/maps-in-r/latticeExtra-nc.png){.full}


# 案例：中国改革开放40年人均GDP数据

世界经济状况，历史至今，GDP 增速和失业率

https://tradingeconomics.com/matrix

贸易经济，GDP 速度，数据源都是官方发布
[Trading Economics](https://github.com/tradingeconomics/tradingeconomics)

https://github.com/tradingeconomics/tradingeconomics/tree/master/R/tradingeconomics

```{r,eval=FALSE}
remotes::install_github("tradingeconomics/tradingeconomics/R/tradingeconomics")
```


# 总结归纳

分两块，其一提供基础的空间数据类型，以及相应的数据操作方法，包括导入各种各样格式的空间数据，其二是空间数据分析和可视化方法，支持接入各种各样的地图服务，渲染静态和交互图形。表\@ref(tab:spatial-deps)列出了基础的空间数据处理、分析和可视化的 R 包，更多详情见 CRAN 上空间数据的[任务视图](https://cran.r-project.org/view=Spatial)。

```{r spatial-deps, message=FALSE, echo=FALSE}
# 获取 R 包元数据
Sys.setenv(R_CRAN_WEB = "https://mirrors.tuna.tsinghua.edu.cn/CRAN")
# 返回 data.frame
pdb <- tools::CRAN_package_db()
library(data.table)
pdb <- as.data.table(pdb)
pdb <- unique(pdb, by = "Package")
# CRAN 上的 R 包
pkgs <- c(
  "sp", "rgeos", "rgdal", "maps", 
  "mapdata", "mapproj", "maptools",
  "sf", "raster", "terra", "stars", "loa",
  "lattice", "latticeExtra", "rasterVis",
  "leaflet", "mapview", "mapedit", "mapsf",
  "ggmap", "RgoogleMaps", "echarts4r",
  "ggplot2", "plotly"
)
# 提取 R Shiny 应用使用的 R 包及其基本描述
sub_pdb <- subset(
  x = pdb, subset = Package %in% pkgs,
  select = c("Package", "Title", "Maintainer")
) |>
  transform(Title = gsub("(\\\n)", " ", Title)) |>
  transform(Maintainer = gsub("<([^<>]*)>", "", Maintainer)) |> 
  transform(Package = paste0("**", Package, "**", " ", "[@", Package, "]"))

# 展示表格
knitr::kable(sub_pdb[order(sub_pdb$Maintainer), ],
  row.names = FALSE,
  caption = "空间分析的 R 包（排名不分先后）",
  col.names = c("R 包", "简介", "维护者")
)
```


## sp vs sf

性能提升是非常显著的

## raster vs terra

性能提升是非常显著的


## lattice vs ggplot2

事实上，**lattice** 在绘图能力上丝毫不逊色于 **ggplot2**，甚至还有超越，本篇主要介绍空间数据，下面以 R 软件内置的地形数据 volcano 为例。

```{r}
#| volcano-shade, 
#| fig.cap="Auckland Maunga Whau 火山地形图 $10m\times 10m$。火山的实况地形图", 
#| fig.width=5, fig.height=5, 
#| out.width="75%",
#| eval=FALSE,
#| echo=FALSE

library(lattice)

wireframe(volcano,
  shade = TRUE, # 灯光渲染
  xlab = expression(x[1]),
  ylab = expression(x[2]),
  zlab = list(expression(italic(f) ~ group("(", list(x[1], x[2]), ")")), rot = 90),
  # 刻度
  scales = list(arrows = FALSE, col = "black"),
  # 减少三维图形的边空
  lattice.options = list(
    layout.widths = list(
      left.padding = list(x = -.6, units = "inches"),
      right.padding = list(x = -1.0, units = "inches")
    ),
    layout.heights = list(
      bottom.padding = list(x = -.8, units = "inches"),
      top.padding = list(x = -1.0, units = "inches")
    )
  ),
  # 轴线
  par.settings = list(
    axis.line = list(col = "transparent"),
    shade.colors = list(
      # 调整 shade 的色彩，研究色彩构造
      # 设置什么样的值可以让色彩接近 terrain.colors()
      # 设置来自 lattice::trellis.par.get()
      palette = function(irr, ref, height, saturation = .5) {
        hsv(h = height, s = 1 - saturation * (1 - (1 - ref)^0.5), v = irr)
      }
    )
  ),
  # 视角
  screen = list(z = -45, x = -50, y = 0)
)
```

![(\#fig:lattice-volcano-shade) [Auckland Maunga Whau 火山](https://en.wikipedia.org/wiki/Maungawhau_/_Mount_Eden)三维地形图 $10m\times 10m$](/img/maps-in-r/lattice-volcano-shade.png){.full}

仅是图 \@ref(fig:lattice-volcano-shade) 就已经让 **ggplot2** 自愧不如了，更别说实现图\@ref(fig:lattice-volcano-contour)这样的组合图形，此例摘自 [Deepayan Sarkar](https://deepayan.github.io/) 的书《**lattice**: Multivariate Data Visualization with R》[@Sarkar2008]。

```{r,eval=FALSE,echo=FALSE}
library(lattice)
panel.3d.contour <- function(x, y, z, rot.mat, distance, nlevels = 20, zlim.scaled, ...) {
  add.line <- trellis.par.get("add.line")
  panel.3dwire(x, y, z, rot.mat, distance,
    zlim.scaled = zlim.scaled, ...
  )
  clines <- contourLines(x, y, matrix(z, nrow = length(x), byrow = TRUE), nlevels = nlevels)
  for (ll in clines) {
    m <- ltransform3dto3d(rbind(ll$x, ll$y, zlim.scaled[2]), rot.mat, distance)
    panel.lines(m[1, ], m[2, ],
      col = add.line$col, lty = add.line$lty, lwd = add.line$lwd
    )
  }
}

wireframe(volcano,
  shade = TRUE, # 灯光渲染
  xlab = expression(x[1]),
  ylab = expression(x[2]),
  zlab = list(expression(italic(f) ~ group("(", list(x[1], x[2]), ")")), rot = 90),
  # 增加高度，让轮廓线更加突出
  zlim = c(90, 250),
  # 刻度
  scales = list(arrows = FALSE, col = "black"),
  # 减少三维图形的边空
  lattice.options = list(
    layout.widths = list(
      left.padding = list(x = -.6, units = "inches"),
      right.padding = list(x = -1.0, units = "inches")
    ),
    layout.heights = list(
      bottom.padding = list(x = -.8, units = "inches"),
      top.padding = list(x = -1.0, units = "inches")
    )
  ),
  # 比例
  aspect = c(61/87, .3), panel.aspect = 0.6,
  panel.3d.wireframe = "panel.3d.contour",
  # 轴线
  par.settings = list(
    axis.line = list(col = "transparent"),
    shade.colors = list(
      # 调整 shade 的色彩，研究色彩构造
      # 设置什么样的值可以让色彩接近 terrain.colors()
      # 设置来自 lattice::trellis.par.get()
      palette = function(irr, ref, height, saturation = .5) {
        hsv(h = height, s = 1 - saturation * (1 - (1 - ref)^0.5), v = irr)
      }
    )
  ),
  # 视角
  screen = list(z = 20, x = -60)
)
```

![(\#fig:lattice-volcano-contour) Auckland Maunga Whau 火山带等值线的三维地形图 $10m\times 10m$](/img/maps-in-r/lattice-volcano-contour.png){.full}









# 环境信息

在 RStudio IDE 内编辑本文的 R Markdown 源文件，用 **blogdown** [@Xie2017] 构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 **knitr** 之后的 Markdown 文件，得益于 **blogdown** 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：

```{r}
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "blogdown",
  "ggmap", "ggplot2", "sp", 
  "leaflet", "echarts4r", "layer",
  "baidumap", "RgoogleMaps",
  "lattice", "loa",
  "terra", "raster", "stars",
  "sf", "plotly"
), dependencies = FALSE)
```
```{r write-bib, include=FALSE}
pkgs <- c(
  "knitr", "rmarkdown", "blogdown",
  "ggmap", "ggplot2", 
  "leaflet", "leafletCN", 
  "echarts4r", "plotly",
  "baidumap", "RgoogleMaps", 
  "mapview", "mapedit", "mapsf",
  "lattice", "loa", "latticeExtra", "rasterVis",
  "geohashTools", "lwgeom", "rgeolocate",
  "terra", "sf", "sp", "stars",
  "maps", "mapdata", "mapproj",
  "raster", "rgeos", "rgdal", "maptools"
)
bib <- knitr::write_bib(
  x = pkgs, file = NULL, prefix = ""
)
bib <- unlist(bib)
bib <- gsub("(\\\n)", " ", bib)
xfun::write_utf8(bib, "packages.bib")
```

# 参考文献

